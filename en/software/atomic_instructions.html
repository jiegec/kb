<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Knowledge Base of @jiegec">
      
      
      
        <link rel="canonical" href="https://jia.je/kb/en/software/atomic_instructions.html">
      
      
        <link rel="prev" href="agentic_chat.html">
      
      
        <link rel="next" href="aws_pricing.html">
      
      
        
          <link rel="alternate" href="atomic_instructions.html" hreflang="en">
        
          <link rel="alternate" href="../../software/atomic_instructions.html" hreflang="zh">
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>原子指令 - Jiegec's Knowledge Base</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3109FRSVTT');
</script>

<script src="https://analytics.jiege.pro/api/script.js" data-site-id="1" defer></script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  
<meta property="og:type" content="website">
<meta property="og:title" content="原子指令 - Jiegec's Knowledge Base">
<meta property="og:description" content="Knowledge Base of @jiegec">
<meta property="og:image" content="https://jia.je/kb/assets/images/social/en/software/atomic_instructions.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://jia.je/kb/en/software/atomic_instructions.html">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="原子指令 - Jiegec's Knowledge Base">
<meta property="twitter:description" content="Knowledge Base of @jiegec">
<meta property="twitter:image" content="https://jia.je/kb/assets/images/social/en/software/atomic_instructions.png">
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Jiegec's Knowledge Base" class="md-header__button md-logo" aria-label="Jiegec's Knowledge Base" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jiegec's Knowledge Base
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              原子指令
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="atomic_instructions.html" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../software/atomic_instructions.html" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/kb" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../cooking/bocaichaojidan.html" class="md-tabs__link">
          
  
  
    
  
  Cooking

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../cryptography/acd.html" class="md-tabs__link">
          
  
  
    
  
  Cryptography

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../hardware/async_sram.html" class="md-tabs__link">
          
  
  
    
  
  Hardware

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../mathematics/abstract_algebra.html" class="md-tabs__link">
          
  
  
    
  
  Mathematics

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../networking/ethernet.html" class="md-tabs__link">
          
  
  
    
  
  Networking

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="2fa.html" class="md-tabs__link">
          
  
  
    
  
  Software

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../travel/italy.html" class="md-tabs__link">
          
  
  
    
  
  Travel

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Jiegec's Knowledge Base" class="md-nav__button md-logo" aria-label="Jiegec's Knowledge Base" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Jiegec's Knowledge Base
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/kb" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cooking
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cooking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/bocaichaojidan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    菠菜炒鸡蛋
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/chaoqincai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    炒芹菜
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/congbaorou.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    葱爆肉
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/ganchaoniuhe.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    干炒牛河
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/hongshaodonggua.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    红烧冬瓜
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/jiandan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    煎蛋
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/liangbanzhengqiezi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    凉拌蒸茄子
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/luoboniunanbao.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    萝卜牛腩煲
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/pidandoufu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    皮蛋豆腐
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/qiezichaorou.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    茄子炒肉
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanlachaodouya.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    酸辣炒豆芽
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanlatudousi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    酸辣土豆丝
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanrongchaokongxincai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    蒜蓉炒空心菜
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanrongfensizhengdaxia.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    蒜蓉粉丝蒸大虾
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xiangchunjiandan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    香椿煎蛋
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xiangguchaoqingcai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    香菇炒青菜
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xihongshichaojidan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    西红柿炒鸡蛋
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Cryptography
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cryptography
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/acd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    近似公约数问题（Approximate Common Divisor Problem）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/bsgs.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Baby-step Giant-step 算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/ec.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    椭圆曲线
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/ecdsa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ECDSA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/lll.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLL 格基规约算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/mihnp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    模逆隐藏数问题（Modular Inverse Hidden Number Problem）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/montgomery_mul_mod.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Montgomery 模乘
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/paillier.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paillier 同态加密算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/pohlig_hellman.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pohlig-Hellman 算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/rsa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RSA 非对称加密
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/zk_snark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    zk-SNARK
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hardware
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hardware
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/async_sram.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Asynchronous SRAM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/bus_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    总线协议
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cache_coherence_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    缓存一致性协议
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cache_replacement_policy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    缓存替换策略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/chiplet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chiplet 接口
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cmos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CMOS (Complementary Metal Oxide Semiconductor)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/conditional_branch_predictor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    条件分支预测器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cpu_microarchitecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CPU 微架构分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cpu_vulnerabilities.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CPU 漏洞和缓解措施
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cxl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CXL (Compute Express Link)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/data_prefetcher.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    数据预取器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/display_interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    显示接口
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/error_detection_correction_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    检错纠错码
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/gpgpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GPGPU (General Purpose Graphics Processing Unit)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/high_speed_serial.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    高速串行通信
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/huawei.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    华为芯片
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/i2c.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    I2C (Inter-Integrated Circuit)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/logic_levels.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logic level standards
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/motherboard.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    主板
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/nand_flash.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    NAND Flash
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/on_chip_networks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    片上网络
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/ooo_cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    乱序执行 CPU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/oscillator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    振荡器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/pcie.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PCIe (Peripheral Component Interconnect Express) 分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/remote_kvm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    远程 KVM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/rvv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RISC-V Vector (RVV) 指令扩展
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/sdram.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDRAM (Synchronous Dynamic Random Access Memory)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/signal_processing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    信号处理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/spi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SPI (Serial Peripheral Interface) 协议
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/usb_hci.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    USB Host Controller Interface
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mathematics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mathematics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/abstract_algebra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    抽象代数
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/fourier_transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    傅立叶变换
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/probability.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概率论
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/score.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Networking
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Networking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/ethernet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    以太网
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/infiniband.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    InfiniBand
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/spanning_tree_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STP 协议
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/vlan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VLAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/wlan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    WLAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Software
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Software
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="2fa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2FA/MFA 多因素认证
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="abi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ABI (Application Binary Interface) 分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="agentic_chat.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agentic Chat
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    原子指令
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="atomic_instructions.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    原子指令
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        背景
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llsc" class="md-nav__link">
    <span class="md-ellipsis">
      
        LL/SC
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LL/SC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        定义
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        常见用法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        指令集架构支持
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        硬件实现
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        活锁
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cas" class="md-nav__link">
    <span class="md-ellipsis">
      
        CAS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        定义
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        常见用法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aba" class="md-nav__link">
    <span class="md-ellipsis">
      
        ABA 问题
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dwcas" class="md-nav__link">
    <span class="md-ellipsis">
      
        DWCAS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        指令集架构支持
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        硬件实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#amo" class="md-nav__link">
    <span class="md-ellipsis">
      
        AMO
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AMO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        定义
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        常见用法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        指令集架构支持
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        硬件实现
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#htm" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        定义
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        常见用法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        指令集架构支持
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        不同原子指令间的关系
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      
        编程语言支持
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      
        其他原子指令
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      
        不同指令集架构对原子指令支持的对比
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="aws_pricing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AWS Pricing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cfi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Control Flow Integrity 控制流完整性
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    计算机图形学
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="coding_plan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Coding Plan
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cpio.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cpio 文件格式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ctf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CTF 常用信息
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CUDA 相关
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dijkstra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dijkstra 算法
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="doh.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DNS over HTTPS (DoH) 协议分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="gc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Garbage Collection 垃圾回收
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="gcc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GCC 内部实现
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="glibc_allocator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    glibc 内存分配器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="glibc_file.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    glibc FILE 结构体
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_allocator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux 内存分配器
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_graphics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux 图形软件栈
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_kernel_memory_barriers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Kernel Memory Barriers 总结
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_mm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux 内存管理（Memory Management）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_resctrl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux 资源控制（Resource Control）
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_scheduler.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Scheduler 分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_soft_raid.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux Soft RAID
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lock_free.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lock Free 数据结构
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="macos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    macOS Goodies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ohos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenHarmonyOS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="read_copy_update.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RCU (Read-Copy-Update) 总结
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="redshift.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Amazon Redshift 分析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sgemm_cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用 CUDA 实现 SGEMM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="spark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Apache Spark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sunrpc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SUNRPC 使用样例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="svg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SVG 速查
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tar.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    tar 文件格式
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="transformer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Transformer 解析
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vivado.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Vivado 相关信息
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8">
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Travel
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Travel
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../travel/italy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    意大利
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../travel/itinerary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    行程
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../travel/rules.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    交通法规
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
  
                  


  
    <a href="https://github.com/jiegec/kb/edit/main/docs/software/atomic_instructions.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </a>
  
  


<h1 id="_1">原子指令</h1>
<p>现在的处理器，一般会提供如下几种形式的原子指令：</p>
<ol>
<li>LL(Load-Linked)/SC(Store-Conditional)</li>
<li>CAS(Compare And Swap)</li>
<li>AMO(Atomic Memory Operation)</li>
<li>HTM(Hardware Transactional Memory)</li>
</ol>
<p>它们在软件的使用方式和硬件实现上有所区别，下面来讨论这些原子指令。</p>
<h2 id="_2">背景</h2>
<p>首先讨论一下为什么需要有原子指令。假设现在有一个多线程程序在多核处理器上运行，每个线程都需要对内存中同一个地址的数据进行加一的操作。在处理器中，加一的操作实际上分为三步：</p>
<ol>
<li>从内存中读取当前的值</li>
<li>求值加一的结果</li>
<li>把加一的结果写入到内存中</li>
</ol>
<p>但是这三个操作是分别进行的，可能会出现这么一种情况：</p>
<ol>
<li>线程一读取内存中的值等于 0</li>
<li>线程二读取内存中的值等于 0</li>
<li>线程一计算 0 加 1 等于 1</li>
<li>线程二计算 0 加 1 等于 1</li>
<li>线程一把 1 写入内存</li>
<li>线程二把 1 写入内存</li>
</ol>
<p>于是加法的结果就被丢弃了。下面用 OpenMP 给出了一个例子：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="cp">#pragma omp parallel for</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>如果用多核执行，得到的结果会是一个远小于 100000 的结果。如果把程序绑定到一个核心上（<code>numactl -C 0</code>），就会得到正确的 100000 的结果。因此需要用原子指令来保证更新的原子性。</p>
<p>在讨论原子指令的硬件实现时，会涉及到缓存一致性协议的内容。如果对这方面还缺乏了解，可以参考 <a href="../hardware/cache_coherence_protocol.html">缓存一致性</a> 的内容。</p>
<h2 id="llsc">LL/SC</h2>
<h3 id="_3">定义</h3>
<p><a href="https://en.wikipedia.org/wiki/Load-link/store-conditional">LL/SC</a> 是一对指令，其中 LL 指令从内存地址 read_addr 中读取数据到寄存器 read_data；SC 指令执行时，如果要写入的内存地址 write_addr 和之前用 LL 指令读取的内存地址 read_addr 相同，并且在 LL 指令后，被 LL 访问的内存区域（粒度可能是 32 位，也可能更粗，例如一个缓存行）没有被修改，那么写入寄存器 write_data 的值到同样的地址 write_addr；否则就不写入。SC 指令的写入是否成功，会通过向目的寄存器 dest 写入不同的值来区分。也就是说，如果 SC 写入成功，就保证了从 LL 到 SC 这段时间内，这段内存没有被改变。</p>
<h3 id="_4">常见用法</h3>
<p>LL/SC 的通常用法是，实现一个读 - 改 - 写（read-modify-write）操作：首先用 LL 指令读取内存，然后对寄存器进行计算，再用 SC 指令把结果写入内存：如果中途内存的值被其他处理器核心修改了，那么用 LL 指令读取的结果是旧的，用的也是旧的值做计算，计算结果就不会被 SC 写进去；否则，说明 LL 指令读取的值和内存中的值是相同的，SC 指令把更新后的结果写入到内存中。</p>
<p>因此 LL/SC 在使用的时候，通常会和循环放在一起用：如果 SC 失败，就重新开始读 - 改 - 写操作，直到 SC 成功。用 LL/SC 实现对内存进行原子加一操作（Atomic Add One）的伪代码如下：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nl">loop:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="c1"># Read</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="nf">ll</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="c1"># Modify</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="c1"># Write</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="nf">sc</span><span class="w"> </span><span class="no">result</span><span class="p">,</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="c1"># Try again if SC failed</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="w"> </span><span class="no">if</span><span class="w"> </span><span class="no">failed</span>
</span></code></pre></div>
<h3 id="_5">指令集架构支持</h3>
<p>在 RISC-V 的 A 扩展中，LL 指令叫做 LR（Load-Reserved），SC 指令还是叫做 SC。下面是 RISC-V 指令集手册中给出的一段用 LL/SC 实现原子比较和写入（Atomic Compare And Set）操作的<a href="https://github.com/riscv/riscv-isa-manual/blob/cd30ad51f1b282a3b409bd803bc02a0e03afbbf2/src/a-st-ext.adoc?plain=1#L227">代码</a>：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w">    </span><span class="c1"># a0 holds address of memory location</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="c1"># a1 holds expected value</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1"># a2 holds desired value</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="c1"># a0 holds return value, 0 if successful, !0 otherwise</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nl">cas:</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nf">lr.w</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span><span class="w">        </span><span class="c1"># Load original value.</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nf">bne</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">fail</span><span class="w">     </span><span class="c1"># Doesn't match, so fail.</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nf">sc.w</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span><span class="w">    </span><span class="c1"># Try to update.</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nf">bnez</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">cas</span><span class="w">         </span><span class="c1"># Retry if store-conditional failed.</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="c1"># Set return to success.</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="nf">jr</span><span class="w"> </span><span class="no">ra</span><span class="w">                </span><span class="c1"># Return.</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nl">fail:</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">             </span><span class="c1"># Set return to failure.</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="nf">jr</span><span class="w"> </span><span class="no">ra</span><span class="w">                </span><span class="c1"># Return.</span>
</span></code></pre></div>
<p>代码利用 LL/SC 指令，把 a0 指向的内存的值和 a1 的值比较，如果相等，就把 a2 写到 a0 指向的内存，返回成功；如果不相等，则不修改内存的值，返回错误。</p>
<p>除了内存被其他处理器核心写入会导致 SC 失败以外，一些指令集架构允许程序手动让 SC 失败，以 LoongArch 为例，标准要求：</p>
<p>LL.{W/D} 执行时记录下访问地址并置上一个标记（LLbit 置为 1），SC.{W/D} 指令执行时会查看 LLbit，仅当 LLbit 为 1 时才真正产生写动作，否则不写。在配对的 LL-SC 执行期间，下列事件会让 LLbit 清 0:</p>
<ul>
<li>执行了 ERTN 指令且执行时 CSR.LLBCTL 中的 KLO 位不等于 1;</li>
<li>其它处理器核或 Cache Coherent master 对该 LLbit 对应的地址所在的 Cache 行执行完成了一个 store 操作。</li>
</ul>
<p>这样做的目的是，如果在 LL 和 SC 之间触发了上下文切换，操作系统可以把 SC 自动取消掉，详情可以看 LoongArch 的 CSR.LLBCTL 的定义。</p>
<p><a href="https://en.wikipedia.org/wiki/Load-link/store-conditional#Implementations">其他实现了 LL/SC 的指令集架构</a>：</p>
<ul>
<li>Alpha: ldl_l/stl_c, ldq_l/stq_c</li>
<li>PowerPC/Power ISA: lwarx/stwcx, ldarx/stdcx</li>
<li>MIPS: ll/sc, llwp/scwp(Double Width)</li>
<li>ARM: ldrex/strex(ARMv6 &amp; ARMv7), ldxr/stxr(ARMv8), ldxp/stxp(Double Width, ARMv8)</li>
<li>ARC: llock/scond</li>
</ul>
<p>实际实现时，根据处理器实现不同，检测内存访问的粒度可能不同。</p>
<h3 id="_6">硬件实现</h3>
<p>在处理器中，LL/SC 的实现并不复杂：缓存一致性协议下，保证了当一个缓存行被更新的时，所有拥有该缓存行的核心都会被通知到。因此，LL 指令只需要在读取缓存的基础上，在缓存上打一个标记；通过缓存一致性协议，如果发现有其他核心要写入 LL 指令读取的缓存行，或者该缓存行要被 Evict，那就记录一个 SC 失败标记，使得下一次 SC 指令失败。实现 SC 指令时，首先检查它的地址是否和 LL 指令相同，如果相同，并且没有触发 SC 失败标记，那就进行实际的写入。伪代码如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">Init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="n">LLvalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="n">LLaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="p">}</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="n">LL</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="n">LLaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="n">LLvalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="p">}</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="n">SC</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LLaddr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">LLvalid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUCCESS</span><span class="p">;</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FAIL</span><span class="p">;</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="p">}</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="n">Invalidate</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LLaddr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="n">LLvalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_7">活锁</h3>
<p>LL/SC 在使用的时候，潜在的一个问题是，可能会出现活锁：当 LL 和 SC 之间执行的指令比较多，花费的时间比较长，可能使得 LL/SC 一直被其他核心打断，没有办法实现进展。</p>
<p>此外，编写 LL/SC 程序的时候也需要小心，避免在中间进行一些比较复杂的操作，因为这些操作可能导致 SC 的时候总是失败：例如在 LL/SC 中途访问其他内存，可能会导致 SC 要写入的的缓存行被 Evict。</p>
<p>因为这个问题，RISC-V 在标准中定义了一些<a href="https://github.com/riscv/riscv-isa-manual/blob/cd30ad51f1b282a3b409bd803bc02a0e03afbbf2/src/a-st-ext.adoc?plain=1#L255">条件</a>，如果满足了这些条件，就可以避免活锁的发生：</p>
<ul>
<li>The loop comprises only an LR/SC sequence and code to retry the sequence in the case of failure, and must comprise at most 16 instructions placed sequentially in memory.</li>
<li>An LR/SC sequence begins with an LR instruction and ends with an SC instruction. The dynamic code executed between the LR and SC instructions can only contain instructions from the base “I” instruction set, excluding loads, stores, backward jumps, taken backward branches, JALR, FENCE, and SYSTEM instructions. If the “C” extension is supported, then compressed forms of the aforementioned “I” instructions are also permitted.</li>
<li>The code to retry a failing LR/SC sequence can contain backwards jumps and/or branches to repeat the LR/SC sequence, but otherwise has the same constraint as the code between the LR and SC.</li>
<li>The LR and SC addresses must lie within a memory region with the LR/SC eventuality property. The execution environment is responsible for communicating which regions have this property.</li>
<li>The SC must be to the same effective address and of the same data size as the latest LR executed by the same hart.</li>
</ul>
<p>因为 LL/SC 的局限性，现在很多算法会用下面讲到的 CAS 或者 AMO 指令来实现。</p>
<h2 id="cas">CAS</h2>
<h3 id="_8">定义</h3>
<p>CAS（Compare-And-Swap）指令做的事情是，把内存中的值和给定的值进行比较，如果相同，那么写入一个新的值；把写入是否成功写入目的寄存器中，或者把旧值写入到目的寄存器中：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nf">cas</span><span class="w"> </span><span class="no">dest</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span><span class="p">,</span><span class="w"> </span><span class="no">compare</span><span class="p">,</span><span class="w"> </span><span class="no">new</span>
</span></code></pre></div>
<p>相当于原子地完成了如下操作：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">compare</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>或者返回内存中的旧值：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">compare</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="n">memory</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="_9">常见用法</h3>
<p>CAS 指令的常见用法是，放在循环中，首先读取内存中的值，进行一系列计算，用 CAS 指令进行对内存的原子更新：如果内存的值没有变，那就把新的值写入；如果内存的值变了，那就循环重新尝试：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nl">loop:</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="c1"># Read</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="nf">load</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="c1"># Modify</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">new_data</span><span class="p">,</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="c1"># Compare-And-Swap</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="nf">cas</span><span class="w"> </span><span class="no">dest</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span><span class="p">,</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="no">new_data</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="c1"># Try again if CAS failed</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="w"> </span><span class="no">if</span><span class="w"> </span><span class="no">failed</span>
</span></code></pre></div>
<p>这样就实现了原子加一操作。和 LL/SC 一样，也需要在循环中不断尝试更新，直到更新成功为止。</p>
<p>对于返回内存中旧值的 CAS 指令，可以把 dest 和 old_data 进行比较来判断 CAS 是否成功。有的 CAS 指令既返回了 CAS 是否成功的信息，又返回了内存中的旧值。</p>
<p>这个过程看起来和 LL/SC 很像，但是有如下的不同：</p>
<ol>
<li>LL/SC 需要两条原子指令，分别在开头的读和最后的写；CAS 只有一条原子指令，在最后实现写入。</li>
<li>LL/SC 需要的操作数比较少：LL 是一个源操作数，也就是要读取的内存地址，一个目的操作数，用来保存读取的值；SC 是两个源操作数，包括要写入的内存地址和数据，一个目的操作数，用来保存 SC 是否成功的结果；CAS 需要的操作数比较多：三个源操作数，包括内存地址、比较数据和新数据，一个目的操作数，用来保存 CAS 是否成功或者内存旧值。</li>
<li>CAS 可能会遇到 ABA 问题：在 Read-Modify-CAS 过程中，如果内存中的值从 A 变成了 B，又从 B 变回了 A，CAS 依然会成功，因为它写入与否，仅取决于比较是否相等；而 LL/SC 会由硬件监测中途的内存访问，只要内存中的值被写入过，无论最后的值是否回到了 LL 读取的值，都会让 SC 失败。下面来讨论 ABA 问题。</li>
</ol>
<h3 id="aba">ABA 问题</h3>
<p>ABA 问题就是指的在 Read-Modify-Write 循环中，如果内存中的值从 A 变成了 B，又从 B 变成了 A，是否会影响写入是否成功的问题。LL/SC 的答案是，如果出现了 ABA 的情况，会使得写入失败；CAS 的答案是，ABA 情况下写入依然成功。</p>
<p>为什么要讨论 ABA 问题呢？这是因为一些无锁数据结构的实现，是不允许 ABA 情况的出现的。这个时候，就需要用 LL/SC，或者用下面要介绍的 DWCAS（Double Width Compare And Swap）指令，而不是 CAS 指令。</p>
<h3 id="dwcas">DWCAS</h3>
<p>DWCAS（Double Width Compare And Swap）指令其实也是 CAS 指令，只不过它的内存操作的粒度是处理器位数的两倍：例如 32 位处理器，DWCAS 的操作宽度就是 64 位；64 位处理器，DWCAS 的操作宽度就是 128 位。</p>
<p>引入 DWCAS 可以解决 ABA 的问题：既然问题出在值会从 A 到 B 再回到 A，那就让值“不回到”A，不就好了？每次更新的时候，除了原本要更新的值，同时更新一个 counter，这个 counter 每次更新都加一。counter 溢出需要很多很多次 CAS，因此可以认为不会出现 ABA 的情况，这时候就解决了 ABA 问题。</p>
<p>但是，通常处理器都只会提供不超过处理器位数的内存指令，例如 32 位处理器提供 8 位、16 位和 32 位 CAS，那要是需要更新的值已经占了 32 位，怎么同时更新 counter 呢？所以就不得不引入了 DWCAS，在 32 位处理器上提供 64 位 CAS，多的那 32 位就可以拿来更新 counter。</p>
<p>但是 DWCAS 实现起来也会比较复杂：每个操作数的位宽都翻倍了，原来的一个通用寄存器放不下了，怎么办？一个朴素的办法是，传更多的操作数，两个操作数拼起来合成一个两倍位宽的值，但是这样在指令编码中，操作数占用的位数太多：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nf">cas</span><span class="w"> </span><span class="no">dest_hi</span><span class="p">,</span><span class="w"> </span><span class="no">dest_lo</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span><span class="p">,</span><span class="w"> </span><span class="no">old_data_hi</span><span class="p">,</span><span class="w"> </span><span class="no">old_data_lo</span><span class="p">,</span><span class="w"> </span><span class="no">new_data_hi</span><span class="p">,</span><span class="w"> </span><span class="no">new_data_lo</span>
</span></code></pre></div>
<p>一个解决方法是，一个操作数对应两个连续的通用寄存器，例如某个操作数是 2 号寄存器，代表的就是 2 号和 3 号寄存器拼接起来的两倍位宽的值。如果平台有更宽的向量寄存器，也可以把操作数放到向量寄存器上传入。但无论如何，单条指令涉及到的操作数和宽度都比较大，给处理器的设计带来了一定的挑战。</p>
<p>除了 DWCAS 以外，还有一种 CAS 变体：<a href="https://en.wikipedia.org/wiki/Double_compare-and-swap">DCAS（Double Compare and Swap）</a>。和 DWCAS 不同的是，DCAS 实现的原子的两个 CAS 操作，这两个 CAS 可以操作不连续的内存。换句话说，DWCAS 可以认为是 DCAS 的一个特殊情况，特殊在于两个 CAS 操作的是连续的内存。</p>
<h3 id="_10">指令集架构支持</h3>
<p>x86_64 指令集提供了 CAS 指令，并且提供了 DWCAS 两倍位宽版本：<a href="https://www.felixcloutier.com/x86/cmpxchg8b:cmpxchg16b">cmpxchg16b 指令</a>，它把内存中的值和 RDX:RAX 比较，如果相等，就设置 ZF，并往内存写入 RCX:RBX；如果不相等，清空 ZF 并把内存中的值写入到 RDX:RAX。可以看到，这条指令采用的是多个源寄存器的方案：RDX、RAX、RCX、RBX 一共四个源 64 位通用寄存器，并且通过定死寄存器编号，解决了指令编码的问题。同时，一条指令也要写入两个通用寄存器 RDX 和 RAX，外加 FLAGS 寄存器的 ZF。</p>
<p>ARM64 也提供了 CAS 指令，通过 CASP 指令实现了 DWCAS：<code>CASP &lt;Xs&gt;, &lt;X(s+1)&gt;, &lt;Xt&gt;, &lt;X(t+1)&gt;, [&lt;Xn|SP&gt;{,#0}]</code>，可以把连续两个 64 位通用寄存器拼起来，作为一个 128 位的整体来进行 CAS。</p>
<p>LoongArch 从 V1.1 版本开始，支持了 AMCAS 指令。RISC-V 也有可选的 <a href="https://github.com/riscv/riscv-zacas">Zacas</a> 扩展。</p>
<h3 id="_11">硬件实现</h3>
<p>CAS 的硬件实现也比较简单：在缓存一致性协议下，当一个缓存可以写缓存行的时候，它拥有了这个缓存行的所有权限，因此只需要在缓存里实现 CAS 即可，其他缓存无法打断这个原子的操作。</p>
<h2 id="amo">AMO</h2>
<h3 id="_12">定义</h3>
<p>AMO（Atomic Memory Operations）指的是对内存中的值进行原子更新：读取内存中的值，写入到目的寄存器，同时对值进行一些更新操作，再写入内存。这个更新操作是预设的，例如位运算（AND、OR、XOR 和 SWAP）或者整数运算（ADD、MIN 和 MAX）等等。它用一条指令完成了前面 LL/SC 或者 CAS 指令的读 - 改 - 写循环做的功能，但是限制了允许的修改操作：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Use AMO</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="nf">amoadd</span><span class="w"> </span><span class="no">dest</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1"># Use CAS</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="nl">loop:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="c1"># Read</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="nf">load</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="c1"># Modify</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">new_data</span><span class="p">,</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="c1"># Compare-And-Swap</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="nf">cas</span><span class="w"> </span><span class="no">dest</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span><span class="p">,</span><span class="w"> </span><span class="no">old_data</span><span class="p">,</span><span class="w"> </span><span class="no">new_data</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="c1"># Try again if CAS failed</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">loop</span><span class="w"> </span><span class="no">if</span><span class="w"> </span><span class="no">failed</span>
</span></code></pre></div>
<h3 id="_13">常见用法</h3>
<p>AMO 指令相当于是把一些常见的读 - 改 - 写循环固化成了指令，因此原来用 LL/SC 或 CAS 实现的一些原子操作，如果有对应的 AMO 指令，可以直接用 AMO 指令实现。</p>
<h3 id="_14">指令集架构支持</h3>
<p>RISC-V 和 LoongArch 都提供了 AMO 指令，它们可以完成内存的原子更新，同时得到更新前的旧值。x86 指令集下，通过给 <a href="https://en.wikipedia.org/wiki/Fetch-and-add#x86_implementation">add 指令添加 lock 前缀</a>，也可以实现原子更新的效果，如果要得到更新前的旧值，可以用 xadd 指令。</p>
<p>AArch64 提供了 AMO 指令：LDADD、LDCLR、LDEOR、LDSET、LDSMAX、LDSMIN、LDUMAX、LDUMIN、STADD、STCLR、STEOR、STSET、STSMAX、STSMIN、STUMAX、STUMIN、SWP 等等。此外，在实现了 LSFE 扩展的 AArch64 处理器上，还支持浮点的 AMO 指令：LDFADD、LDFMAX、LDFMIN、LDBFADD、LDBFMAX、LDBFMIN、STFADD、STFMAX、STFMIN、STBFADD、STBFMAX、STBFMIN。</p>
<h3 id="_15">硬件实现</h3>
<p>AMO 指令的硬件实现和 CAS 类似，也是把原子操作下放到缓存中去执行。但由于 AMO 指令需要涉及少量的更新操作，例如位运算和整数运算，因此缓存内部也需要引入一个 ALU 用于实现 AMO 指令的计算。因此，目前 AMO 指令仅限于硬件开销比较小的位运算和整数运算，没有整数乘除法，也没有浮点运算。</p>
<p>例如 Rocket Chip 设计了一个 <a href="https://github.com/chipsalliance/rocket-chip/blob/e3773366a5c473b6b45107f037e3130f4d667238/src/main/scala/rocket/AMOALU.scala#L53">AMOALU</a>，用于在 DCache 中实现 AMO 指令的计算。</p>
<h2 id="htm">HTM</h2>
<h3 id="_16">定义</h3>
<p>HTM 是硬件提供的在内存上的事务。事务这个概念在数据库上比较常见，把多个对数据库的操作放到一个事务中，可以保证整个事务的原子性。HTM 也是类似的，只不过是在 CPU 上，可以保证一系列的指令对内存的操作是原子的。</p>
<h3 id="_17">常见用法</h3>
<p>通常，它需要用特定的 begin 指令开始一段事务，执行一系列指令后，再用特定的 end 指令结束事务。如果在事务中途，事务被打断，例如程序主动用指令打断，或者涉及到的内存被其他处理器核心修改，那么事务就会被回滚，同时程序转移到指定的 fallback 地址继续执行，这个 fallback 地址会在 begin 指令中给出。下面是一段用硬件内存事务实现的原子加一：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nl">retry:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="c1"># begin transaction</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="c1"># set fallback address to fail label</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nf">begin</span><span class="w"> </span><span class="no">fail</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="c1"># do computation</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="nf">load</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="nf">store</span><span class="w"> </span><span class="no">data</span><span class="p">,</span><span class="w"> </span><span class="no">addr</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="c1"># end transaction</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="nf">end</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="nl">fail:</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="c1"># retry if transaction failed</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="nf">goto</span><span class="w"> </span><span class="no">retry</span>
</span></code></pre></div>
<p>实际上，HTM 支持嵌套，也就是说可以在一次事务中途，再开另一个事务。但只有最外层的事务的 end 指令会提交事务，如果需要回滚事务，也会回滚到最外层事务，再跳转到最外层事务的 fallback 地址。</p>
<h3 id="_18">指令集架构支持</h3>
<p>x86_64 指令集提供了 Transactional Synchronization Extensions (TSX) 扩展，它有两种使用方法：Hardware Lock Elision 和 Restricted Transactional Memory。它的文档在 Intel 64 and IA-32 Architectures Software Develop's Manual 的 Volume 1 Chapter 16 Programming with Intel Transaction Synchronization Extensions。</p>
<p>Hardware Lock Elision 的应用场景是，程序编写了 critical section，并且用锁来保护它，保证同时只有一个核心在执行这个 critical section。但锁会带来额外的开销。既然有了硬件内存事务，就可以先跳过加锁这一步，在事务里执行一次 critical section，在原来释放锁的地方结束事务。如果事务成功提交，说明没有其他核心要进入 critical section，那就省下了锁的开销；如果事务没有成功提交，就会回滚，再正常执行带锁的 critical section。</p>
<p>具体地，它在加锁的指令上添加一个 XACQUIRE 前缀，并在释放锁的指令上添加一个 XRELEASE 前缀。那么在支持 TSX 的硬件上，处理器就可以用硬件事务来尝试绕过锁。如果处理器不支持 TSX，就会忽略掉 XACQUIRE 和 XRELEASE 前缀，正常上锁、执行代码再释放锁。</p>
<p>Restricted Transactional Memory 就是完整的硬件内存事务支持：用 XBEGIN 指令开始事务，用 XEND 指令结束事务，用 XABORT 指令打断当前事务。</p>
<p>AArch64 从 ARMv9-A 开始，也引入了硬件内存事务支持：<a href="https://documentation-service.arm.com/static/62ff4dcbc3b04f2bd53e21d5?token=">Transactional Memory Extension (TME)</a>。它引入了如下的新指令：</p>
<ul>
<li>TCANCEL imm: 对应 x86 的 XABORT，取消事务，从 TSTART 下一条指令开始继续执行，imm 会被写入到 TSTART 指令的目的寄存器</li>
<li>TCOMMIT: 对应 x86 的 XEND</li>
<li>TSTART Xd: 对应 x86 的 XBEGIN，如果事务成功开始，那么目的寄存器被写入 0；如果事务失败，那么目的寄存器会被写入为事务失败原因</li>
<li>TTEST Xd: 把目前的事务嵌套层级写到目的寄存器</li>
</ul>
<p>因此 TME 的预期使用方法是（例子来自 ARM DDI0617 C1.1 Conventions）：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nf">loop</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="nf">tstart</span><span class="w"> </span><span class="no">x12</span><span class="w">     </span><span class="c1"># attempt to start a new transaction</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">loop</span><span class="w"> </span><span class="c1"># retry forever</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="err">&lt;</span><span class="nf">code</span><span class="err">&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="nf">tcommit</span>
</span></code></pre></div>
<p>此外，TME 扩展也可以用来实现类似 x86 的 HLE 特性：Transactional Lock Elision。但是，与 x86 的实现方法不同，AArch64 的 TME 扩展还是需要用上述的 TSTART 等指令来实现 Transactional Lock Elision，下面是一个例子（来自 ARM DDI0617 C2.3 Acquiring a lock）：</p>
<p>获得锁：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nl">loop:</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="nf">TSTART</span><span class="w"> </span><span class="no">X5</span><span class="w">         </span><span class="c1"># attempt to start a new transaction</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="nf">CBNZ</span><span class="w"> </span><span class="no">X5</span><span class="p">,</span><span class="w"> </span><span class="no">fallback</span><span class="w"> </span><span class="c1"># check if start succeeded</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="c1"># CHECK_ACQ(X1)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="c1"># add the fallback lock to the transactional read set ; and set W5 to 0 if the fallback lock is free.</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="nf">LDAR</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">    </span><span class="nf">CBZ</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">enter</span><span class="w">     </span><span class="c1"># if the fallback lock is free enter the critical region</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="nf">TCANCEL</span><span class="w"> </span><span class="mi">#0</span><span class="no">xFFFF</span><span class="w">   </span><span class="c1"># otherwise cancel the transaction with RTRY set to 1</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="nl">fallback:</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="nf">TBZ</span><span class="w"> </span><span class="no">X5</span><span class="p">,</span><span class="w"> </span><span class="mi">#15</span><span class="p">,</span><span class="w"> </span><span class="no">lock</span><span class="w"> </span><span class="c1"># if RTRY is 0 take the fallback lock</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="nf">SUB</span><span class="w"> </span><span class="no">W6</span><span class="p">,</span><span class="w"> </span><span class="no">W6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span><span class="w">    </span><span class="c1"># decrement the retry count</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="nf">CBZ</span><span class="w"> </span><span class="no">W6</span><span class="p">,</span><span class="w"> </span><span class="no">lock</span><span class="w">      </span><span class="c1"># take the lock if 0</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="c1"># WAIT_ACQ(X1==0)</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="c1"># wait until the lock is free</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="nl">loop_wait:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">    </span><span class="nf">LDAR</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w">     </span><span class="c1"># load acquire ensures it is ordered before subsequent loads/stores</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">    </span><span class="nf">CBNZ</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">loop_wait</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">    </span><span class="nf">B</span><span class="w"> </span><span class="no">loop</span><span class="w">            </span><span class="c1"># retry the transaction</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="nl">lock:</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="c1"># LOCK(X1)</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="w">    </span><span class="c1"># elision failed, acquire the fallback lock</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">    </span><span class="nf">PRFM</span><span class="w"> </span><span class="no">PSTL1KEEP</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w"> </span><span class="c1"># preload into cache in unique state</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="nl">loop_lock:</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">    </span><span class="nf">LDAXR</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w">       </span><span class="c1"># read lock with acquire</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">    </span><span class="nf">CBNZ</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">loop_lock</span><span class="w">   </span><span class="c1"># check if 0</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="w">    </span><span class="nf">STXR</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">W0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w">    </span><span class="c1"># attempt to store new value</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="w">    </span><span class="nf">CBNZ</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">loop_lock</span><span class="w">   </span><span class="c1"># test if store succeeded and retry if not</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="w">    </span><span class="nf">DMB</span><span class="w"> </span><span class="no">ISH</span><span class="w">           </span><span class="c1"># block loads/stores from the critical region</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="nl">enter:</span>
</span></code></pre></div>
<p>代码首先开始一次事务，如果发现锁没有被其他线程获得，那就直接跳转到 enter 进行 critical section 的执行；如果发现锁已经被其他线程获得，就取消事务，再次循环，如果循环多次还是失败，那就用传统的锁。</p>
<p>在 critical section 最后释放锁：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="w">    </span><span class="c1"># CHECK(X1)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="c1"># set W5 to 0 if the fallback lock is free</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="nf">LDR</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">Xx</span><span class="p">]</span><span class="w"> </span><span class="c1">; read lock</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nf">CBNZ</span><span class="w"> </span><span class="no">W5</span><span class="p">,</span><span class="w"> </span><span class="no">unlock</span><span class="w">   </span><span class="c1"># check if 0</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nf">TCOMMIT</span><span class="w">           </span><span class="c1"># the lock was elided, exit the transaction</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="nf">B</span><span class="w"> </span><span class="no">exit</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="nl">unlock:</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="c1"># UNLOCK(X1)</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="c1"># elision failed, release the fallback lock exit:</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="nf">STLR</span><span class="w"> </span><span class="no">WZR</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">X1</span><span class="p">]</span><span class="w">    </span><span class="c1"># clear the lock with release semantics</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="nl">exit:</span>
</span></code></pre></div>
<p>首先检查之前是采用的哪种方法“获得”了锁，如果是事务，那就提交事务；如果是传统的锁，那就释放掉锁。可以看到，相比 x86 的方案，ARM 的 TME 在实现 Lock Elision 时，指令上会比较冗余，但好处是微架构的实现会比较容易。</p>
<h2 id="_19">不同原子指令间的关系</h2>
<p>不同原子指令之间，虽然语义不同，但是可以一定程度上互相实现。</p>
<p>用 LL/SC 实现 CAS：首先用 LL 读取旧值，和预期值进行比较，如果相等，则用 SC 写入新值，如果 SC 写入失败，则循环。</p>
<p>用 CAS 实现 AMO：首先读取旧值，用指令实现 AMO 要做的更新操作后，用 CAS 尝试写入，如果内存中的值等于旧值，就把更新后的新值写入，如果写入失败，则循环。</p>
<p>用 CAS 实现 LL/SC：不完美，可能有 ABA 问题。用正常的指令读取内存以代替 LL，记录下访问的内存地址和读取的值；在原来 SC 的地方，判断 SC 的地址是否和之前 LL 的相同，如果地址相同，则用 CAS 尝试写入，如果内存中的值等于之前读取的值，就写入 SC 要写入的值。</p>
<p>关于 LL/SC 和 CAS 在 Linux 中使用的讨论，推荐阅读：<a href="https://yarchive.net/comp/linux/cmpxchg_ll_sc_portability.html">cmpxchg ll/sc portability</a>。</p>
<p>事实上，QEMU 为了性能，会用 CAS 实现 LL/SC。虽然它会有 ABA 问题，但实际上利用 LL/SC 来避免 ABA 问题的代码比较少。如果不这么做，就需要比较复杂的方法来实现精确的 LL/SC 模拟，这方面的论文也不少，例如：</p>
<ul>
<li>Kristien, Martin, et al. "Fast and correct load-link/store-conditional instruction handling in DBT systems." IEEE Transactions on Computer-Aided Design of Integrated Circuits and Systems 39.11 (2020): 3544-3554.</li>
<li>Z. Zhao, Z. Jiang, Y. Chen, X. Gong, W. Wang and P. -C. Yew, "Enhancing Atomic Instruction Emulation for Cross-ISA Dynamic Binary Translation," 2021 IEEE/ACM International Symposium on Code Generation and Optimization (CGO), Seoul, Korea (South), 2021, pp. 351-362, doi: 10.1109/CGO51591.2021.9370312.</li>
</ul>
<p>但很遗憾的是，这些工作的性能都没有达到 CAS 模拟那么好，所以还是没有被 QEMU 采用。关于 QEMU 为什么要采用 CAS 来模拟 LL/SC 的讨论，可以见 <a href="https://lists.gnu.org/archive/html/qemu-devel/2016-06/msg07754.html">cmpxchg-based emulation of atomics</a>。</p>
<h2 id="_20">编程语言支持</h2>
<p>目前很多编程语言都内置了对原子指令的支持，例如：</p>
<ul>
<li>C: C11 引入了 stdatomic.h 头文件</li>
<li>C++: C++11 引入了 atomic 头文件</li>
<li>Rust：提供了 std::sync::atomic</li>
</ul>
<p>根据指令集架构支持的原子指令类型，这些编程语言的原子操作会被翻译成对应的汇编代码。</p>
<h2 id="_21">其他原子指令</h2>
<p>一些指令集架构还提供了其他类型的原子指令，例如：</p>
<ul>
<li>AArch64 提供了 64 字节粒度的原子读或写：LD64B 从内存原子读取连续 64 字节的数据到 8 个通用寄存器中；ST64B 把连续 8 个通用寄存器的值原子写入到内存中</li>
</ul>
<h2 id="_22">不同指令集架构对原子指令支持的对比</h2>
<table>
<thead>
<tr>
<th>ISA</th>
<th>LL/SC</th>
<th>CAS</th>
<th>AMO</th>
<th>HTM</th>
</tr>
</thead>
<tbody>
<tr>
<td>RISC-V</td>
<td>A 扩展</td>
<td>Zacas 扩展，并且支持双倍宽度</td>
<td>A 扩展</td>
<td>无</td>
</tr>
<tr>
<td>LoongArch</td>
<td>有，V1.1 支持了双倍宽度</td>
<td>需要 V1.1 版本，不支持双倍宽度</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>x86_64</td>
<td>无</td>
<td>有，并且支持双倍宽度</td>
<td>有</td>
<td>TSX</td>
</tr>
<tr>
<td>AArch64</td>
<td>有</td>
<td>有，并且支持双倍宽度</td>
<td>有</td>
<td>TME</td>
</tr>
<tr>
<td>MIPS</td>
<td>有，也支持双倍宽度</td>
<td>有，并且支持双倍宽度</td>
<td>有</td>
<td>无</td>
</tr>
</tbody>
</table>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年7月13日 14:19:55 UTC">2025年7月13日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2023年10月27日 16:32:04 UTC">2023年10月27日</span>
  </span>

    
    
    
  </aside>


  



<!-- https://squidfunk.github.io/mkdocs-material/setup/adding-a-comment-system/ -->
<h2 id="__comments">Comments</h2>
<!-- Insert generated snippet here -->

<script src="https://giscus.app/client.js" data-repo="jiegec/kb" data-repo-id="R_kgDOJZwffg" data-category="General" data-category-id="DIC_kwDOJZwffs4CV-wv" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async>
</script>
                

  <script>
    var language = "";
    if (language === "None") {
      language = "zh";
    }
    var prefix = "";
    var suffix = "";
    if (language === "zh") {
      prefix = "图 ";
      suffix = "：";
    } else {
      // en
      prefix = "Figure ";
      suffix = ": ";
    }
    /* prepend the counter to the figcaption content */
    var styles = `figure figcaption:before { content: "${prefix}" counter(figureCounter) "${suffix}" }`;

    var styleSheet = document.createElement("style")
    styleSheet.innerText = styles
    document.head.appendChild(styleSheet)
  </script>

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="agentic_chat.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Agentic Chat">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Agentic Chat
              </div>
            </div>
          </a>
        
        
          
          <a href="aws_pricing.html" class="md-footer__link md-footer__link--next" aria-label="Next: AWS Pricing">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                AWS Pricing
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2023-2025 Jiajie Chen
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.action.edit", "content.code.copy", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tracking", "navigation.tabs", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>