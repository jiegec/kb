
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Knowledge Base of @jiegec">
      
      
      
        <link rel="canonical" href="https://jia.je/kb/software/glibc_allocator.html">
      
      
        <link rel="prev" href="gcc.html">
      
      
        <link rel="next" href="glibc_file.html">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../feed_rss_updated.xml">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>glibc 内存分配器 - 杰哥的知识库</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3109FRSVTT');
</script>

<script
    src="https://analytics.jiege.pro/api/script.js"
    data-site-id="1"
    defer
></script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="glibc 内存分配器 - 杰哥的知识库" >
      
        <meta  property="og:description"  content="Knowledge Base of @jiegec" >
      
        <meta  property="og:image"  content="https://jia.je/kb/assets/images/social/software/glibc_allocator.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://jia.je/kb/software/glibc_allocator.html" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="glibc 内存分配器 - 杰哥的知识库" >
      
        <meta  name="twitter:description"  content="Knowledge Base of @jiegec" >
      
        <meta  name="twitter:image"  content="https://jia.je/kb/assets/images/social/software/glibc_allocator.png" >
      
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#glibc" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../index.html" title="杰哥的知识库" class="md-header__button md-logo" aria-label="杰哥的知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的知识库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              glibc 内存分配器
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../en/software/glibc_allocator.html" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="glibc_allocator.html" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jiegec/kb" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../cooking/bocaichaojidan.html" class="md-tabs__link">
          
  
  
    
  
  厨艺

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../cryptography/ec.html" class="md-tabs__link">
          
  
  
    
  
  密码学

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../hardware/async_sram.html" class="md-tabs__link">
          
  
  
    
  
  硬件

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../mathematics/abstract-algebra.html" class="md-tabs__link">
          
  
  
    
  
  数学

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../networking/ethernet.html" class="md-tabs__link">
          
  
  
    
  
  网络

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="2fa.html" class="md-tabs__link">
          
  
  
    
  
  软件

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../travel/italy.html" class="md-tabs__link">
          
  
  
    
  
  旅行

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="杰哥的知识库" class="md-nav__button md-logo" aria-label="杰哥的知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    杰哥的知识库
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jiegec/kb" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    主页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    厨艺
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            厨艺
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/bocaichaojidan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    菠菜炒鸡蛋
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/chaoqincai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    炒芹菜
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/congbaorou.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    葱爆肉
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/ganchaoniuhe.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    干炒牛河
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/hongshaodonggua.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    红烧冬瓜
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/jiandan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    煎蛋
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/liangbanzhengqiezi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    凉拌蒸茄子
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/luoboniunanbao.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    萝卜牛腩煲
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/pidandoufu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    皮蛋豆腐
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/qiezichaorou.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    茄子炒肉
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanlachaodouya.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    酸辣炒豆芽
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanlatudousi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    酸辣土豆丝
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanrongchaokongxincai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    蒜蓉炒空心菜
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/suanrongfensizhengdaxia.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    蒜蓉粉丝蒸大虾
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xiangchunjiandan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    香椿煎蛋
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xiangguchaoqingcai.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    香菇炒青菜
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cooking/xihongshichaojidan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    西红柿炒鸡蛋
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    密码学
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            密码学
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/ec.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    椭圆曲线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/ecdsa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ECDSA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/lll.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLL 格基规约算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/montgomery_mul_mod.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Montgomery 模乘
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cryptography/zk_snark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zk-SNARK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    硬件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            硬件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/async_sram.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    异步 SRAM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/bus_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    总线协议
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cache_coherence_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    缓存一致性协议
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cache_replacement_policy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    缓存替换策略
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/chiplet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chiplet 接口
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cmos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CMOS (Complementary Metal Oxide Semiconductor)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/conditional_branch_predictor.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    条件分支预测器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cpu_microarchitecture.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CPU 微架构分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cpu_vulnerabilities.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CPU 漏洞和缓解措施
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/cxl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CXL (Compute Express Link)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/display_interface.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    显示接口
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/error_detection_correction_code.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    检错纠错码
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/gpgpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GPGPU (General Purpose Graphics Processing Unit)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/high_speed_serial.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    高速串行通信
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/huawei.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    华为芯片
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/i2c.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    I2C (Inter-Integrated Circuit)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/logic_levels.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    逻辑电平标准
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/motherboard.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    主板
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/nand_flash.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NAND Flash
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/on_chip_networks.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    片上网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/ooo_cpu.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    乱序执行 CPU
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/oscillator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    振荡器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/pcie.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PCIe (Peripheral Component Interconnect Express) 分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/remote_kvm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    远程 KVM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/rvv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V Vector (RVV) 指令扩展
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/sdram.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SDRAM (Synchronous Dynamic Random Access Memory)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/signal_processing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    信号处理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/spi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SPI (Serial Peripheral Interface) 协议
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/usb_hci.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    USB Host Controller Interface
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    数学
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            数学
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/abstract-algebra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    抽象代数
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/fourier-transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    傅立叶变换
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/probability.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概率论
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mathematics/score.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Score
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    网络
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/ethernet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    以太网
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/infiniband.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    InfiniBand
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/spanning_tree_protocol.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STP 协议
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/vlan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VLAN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../networking/wlan.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WLAN
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    软件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            软件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="2fa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2FA/MFA 多因素认证
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="abi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ABI (Application Binary Interface) 分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="atomic_instructions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    原子指令
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="aws_pricing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Pricing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cfi.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Control Flow Integrity 控制流完整性
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    计算机图形学
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cpio.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cpio 文件格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ctf.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CTF 常用信息
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CUDA 相关
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dijkstra.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dijkstra 算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="doh.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DNS over HTTPS (DoH) 协议分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="gc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Garbage Collection 垃圾回收
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="gcc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GCC 内部实现
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    glibc 内存分配器
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="glibc_allocator.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    glibc 内存分配器
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#glibc-231" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.31
    </span>
  </a>
  
    <nav class="md-nav" aria-label="glibc 2.31">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-thread-local-cache" class="md-nav__link">
    <span class="md-ellipsis">
      tcache (Thread Local Cache)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tcache (Thread Local Cache)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#malloc" class="md-nav__link">
    <span class="md-ellipsis">
      malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free" class="md-nav__link">
    <span class="md-ellipsis">
      free
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__libc_malloc" class="md-nav__link">
    <span class="md-ellipsis">
      回到 __libc_malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      块布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-bin" class="md-nav__link">
    <span class="md-ellipsis">
      fast bin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fast bin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#malloc_1" class="md-nav__link">
    <span class="md-ellipsis">
      malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free_1" class="md-nav__link">
    <span class="md-ellipsis">
      free
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      实验
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#small-bin" class="md-nav__link">
    <span class="md-ellipsis">
      small bin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="small bin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#malloc_2" class="md-nav__link">
    <span class="md-ellipsis">
      malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free_2" class="md-nav__link">
    <span class="md-ellipsis">
      free
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consolidate" class="md-nav__link">
    <span class="md-ellipsis">
      consolidate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#__libc_malloc_1" class="md-nav__link">
    <span class="md-ellipsis">
      再次回到 __libc_malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unsorted-bin" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#large-bin" class="md-nav__link">
    <span class="md-ellipsis">
      large bin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="large bin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#malloc_3" class="md-nav__link">
    <span class="md-ellipsis">
      malloc
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bin" class="md-nav__link">
    <span class="md-ellipsis">
      寻找更大的 bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#top-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      top chunk 分配
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free_3" class="md-nav__link">
    <span class="md-ellipsis">
      free
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#realloc" class="md-nav__link">
    <span class="md-ellipsis">
      realloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calloc" class="md-nav__link">
    <span class="md-ellipsis">
      calloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arena-heap" class="md-nav__link">
    <span class="md-ellipsis">
      arena 和 heap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
    <nav class="md-nav" aria-label="小结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#malloc_4" class="md-nav__link">
    <span class="md-ellipsis">
      malloc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#free_4" class="md-nav__link">
    <span class="md-ellipsis">
      free
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      各种常量的默认值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      性能优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      后续版本更新
    </span>
  </a>
  
    <nav class="md-nav" aria-label="后续版本更新">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#glibc-232" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.32
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-233" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.33
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-234" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.34
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-235" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.35
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-236" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.36
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-237" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.37
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-238" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.38
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-239" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.39
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-240" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.40
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-241" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.41
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#glibc-242" class="md-nav__link">
    <span class="md-ellipsis">
      glibc 2.42
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      小结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ctf" class="md-nav__link">
    <span class="md-ellipsis">
      CTF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CTF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-poisoning" class="md-nav__link">
    <span class="md-ellipsis">
      tcache poisoning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#duplicate-chunks-in-fast-bin" class="md-nav__link">
    <span class="md-ellipsis">
      duplicate chunks in fast bin
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      参考
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="glibc_file.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    glibc FILE 结构体
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_allocator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux 内存分配器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_graphics.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux 图形软件栈
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_kernel_memory_barriers.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux Kernel Memory Barriers 总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_mm.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux 内存管理（Memory Management）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_resctrl.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux 资源控制（Resource Control）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="linux_scheduler.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux Scheduler 分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lock_free.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lock Free 数据结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="macos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    macOS Goodies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ohos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenHarmonyOS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PostgreSQL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="read_copy_update.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RCU (Read-Copy-Update) 总结
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="redshift.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Amazon Redshift 分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sgemm_cuda.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用 CUDA 实现 SGEMM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="spark.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Apache Spark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sunrpc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SUNRPC 使用样例
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="svg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SVG 速查
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tar.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    tar 文件格式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="transformer.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transformer 解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vivado.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vivado 相关信息
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    旅行
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            旅行
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../travel/italy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    意大利
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../travel/itinerary.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    行程
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  
                  


  
    <a href="https://github.com/jiegec/kb/edit/main/docs/software/glibc_allocator.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="glibc">glibc 内存分配器</h1>
<h2 id="glibc-231">glibc 2.31</h2>
<p>glibc 2.31 是 ubuntu 20.04 所使用的 libc 版本，首先来分析它的实现，源码可以从 <a href="https://github.com/bminor/glibc/tree/glibc-2.31">glibc-2.31 tag</a> 中找到。</p>
<p>首先来看 malloc 函数，它实现在 <code>malloc/malloc.c</code> 的 <a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022"><code>__libc_malloc</code></a> 函数当中，忽略 <code>__malloc_hook</code> 和一些检查，首先可以看到它有一段代码，使用了一个叫做 tcache 的数据结构：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cm">/* int_free also calls request2size, be careful to not pad twice.  */</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">tbytes</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checked_request2size</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tbytes</span><span class="p">))</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">__set_errno</span><span class="w"> </span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csize2tidx</span><span class="w"> </span><span class="p">(</span><span class="n">tbytes</span><span class="p">);</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">MAYBE_INIT_TCACHE</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">DIAG_PUSH_NEEDS_COMMENT</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tc_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tcache_get</span><span class="w"> </span><span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="n">DIAG_POP_NEEDS_COMMENT</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="tcache-thread-local-cache">tcache (Thread Local Cache)</h3>
<p>接下来仔细地研究 tcache 的结构。首先，它是一个 per-thread 的数据结构，意味着每个线程都有自己的一份 tcache，不需要上锁就可以访问：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">static</span><span class="w"> </span><span class="n">__thread</span><span class="w"> </span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></div>
<p>接下来看它具体保存了什么：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cm">/* We overlay this structure on the user-data portion of a chunk when</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="cm">   the chunk is stored in the per-thread cache.  */</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="cm">/* This field exists to detect double frees.  */</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_entry</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="cm">/* There is one of these for each thread, which contains the</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="cm">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="cm">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="cm">   are redundant (we could have just counted the linked list each</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="cm">   time), this is for performance reasons.  */</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="p">{</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_perthread_struct</span><span class="p">;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="cm">/* Caller must ensure that we know tc_idx is valid and there&#39;s room</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="cm">   for more chunks.  */</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="n">tcache_put</span><span class="w"> </span><span class="p">(</span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">)</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="p">{</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">  </span><span class="cm">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="cm">     detect a double free.  */</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">  </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="p">;</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">  </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">  </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">  </span><span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="p">}</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="cm">/* Caller must ensure that we know tc_idx is valid and there&#39;s</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="cm">   available chunks to remove.  */</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="n">tcache_get</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">)</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="p">{</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">  </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">  </span><span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">  </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到它有两个成员，把 tcache 分为 <code>TCACHE_MAX_BINS</code> 这么多个 bin，每个 bin 分别有一个：</p>
<ol>
<li><code>counts[bin]</code>：记录了这个 bin 中空闲块的数量，<code>tcache_put</code> 的时候加一，<code>tcache_get</code> 的时候减一</li>
<li><code>entries[bin]</code>: 每个 bin 用一个链表保存了空闲块，链表的节点类型是 <code>tcache_entry</code>，那么 <code>entries[bin]</code> 保存了链表头的指针</li>
</ol>
<p>bin 是内存分配器的一个常见做法，把要分配的块的大小分 bin，从而保证拿到的空闲块足够大。接下来看 <code>tcache_put</code> 是如何把空闲块放到 tcache 中的：</p>
<ol>
<li>把空闲块强制转换为 <code>tcache_entry</code> 结构体类型</li>
<li>把它的 <code>key</code> 字段指向 tcache，用来表示这个空闲块当前在 <code>tcache</code> 当中，后续用它来检测 double free</li>
<li>以新的 <code>tcache_entry</code> 作为链表头，插入到 tcache 的对应的 bin 当中：<code>entries[tc_idx]</code></li>
<li>更新这个 bin 的空闲块个数到 <code>count[tc_idx]</code> 当中</li>
</ol>
<p>反过来，<code>tcache_get</code> 则是从 tcache 中拿出一个空闲块：</p>
<ol>
<li>从链表头 <code>entries[tc_idx]</code> 取出一个空闲块，把它从链表中删除：<code>entries[tc_idx] = e-&gt;next</code></li>
<li>更新这个 bin 的空闲块个数到 <code>count[tc_idx]</code> 当中</li>
<li>把它的 <code>key</code> 字段指向 NULL，用来表示这个空闲块当前不在 <code>tcache</code> 当中</li>
<li>返回这个空闲块的地址</li>
</ol>
<h4 id="malloc">malloc</h4>
<p>接下来回到 <code>malloc</code> 的实现，它首先根据用户要分配的空间大小（<code>bytes</code>），计算出实际需要分配的大小（<code>tbytes</code>），和对应的 bin（<code>tc_idx</code>）：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cm">/* int_free also calls request2size, be careful to not pad twice.  */</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">tbytes</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checked_request2size</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tbytes</span><span class="p">))</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="n">__set_errno</span><span class="w"> </span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csize2tidx</span><span class="w"> </span><span class="p">(</span><span class="n">tbytes</span><span class="p">);</span>
</span></code></pre></div>
<p>其中 <code>checked_request2size</code> 实现如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cp">#define request2size(req)                                         \</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="cp">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="cp">   MINSIZE :                                                      \</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="cp">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="cm">/* Check if REQ overflows when padded and aligned and if the resulting value</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="cm">   is less than PTRDIFF_T.  Returns TRUE and the requested size or MINSIZE in</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="cm">   case the value is less than MINSIZE on SZ or false if any of the previous</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="cm">   check fail.  */</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">bool</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="nf">checked_request2size</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="n">__nonnull</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="p">{</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PTRDIFF_MAX</span><span class="p">))</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">  </span><span class="o">*</span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request2size</span><span class="w"> </span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>它实现的实际上是把用户请求的内存大小，加上 <code>SIZE_SZ</code>（即 <code>sizeof(size_t)</code>），向上取整到 <code>MALLOC_ALIGN_MASK</code> 对应的 alignment（<code>MALLOC_ALIGNMENT</code>，通常是 <code>2 * SIZE_SZ</code>）的整数倍数，再和 <code>MINSIZE</code> 取 max。这里要加 <code>SIZE_SZ</code>，是因为 malloc 会维护被分配的块的一些信息，包括块的大小和一些 flag，后续会详细讨论，简单来说就是分配的实际空间会比用户请求的空间要更大。</p>
<p>接着，看它是如何计算出 tcache index 的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cm">/* When &quot;x&quot; is from chunksize().  */</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="cp"># define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span>
</span></code></pre></div>
<p>可以看到，从 MINSIZE 开始，以 MALLOC_ALIGNMENT 为单位，每个 bin 对应一个经过 align 以后的可能的内存块大小。得到 tcache index 后，检查对应的 bin 是否有空闲块，如果有，则直接分配：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tc_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tcache_get</span><span class="w"> </span><span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，tcache 相当于是一个 per thread 的小缓存，记录了最近释放的内存块，可供 malloc 使用。由于 bin 的数量有限，所以比较大的内存分配不会经过 tcache。</p>
<p>P.S. <code>calloc</code> 不会使用 tcache，而是用后面提到的 <code>_int_malloc</code> 进行各种分配。</p>
<h4 id="free">free</h4>
<p>既然 malloc 用到了 tcache，自然 free 就要往里面放空闲块了，相关的代码在 <code>_int_free</code> 函数当中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csize2tidx</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="cm">/* Check to see if it&#39;s already in the tcache.  */</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="cm">/* This test succeeds on double free.  However, we don&#39;t 100%</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="cm">       trust it (it also matches random payload data at a 1 in</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="cm">       2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="cm">       coincidence before aborting.  */</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tcache</span><span class="p">))</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="n">LIBC_PROBE</span><span class="w"> </span><span class="p">(</span><span class="n">memory_tcache_double_free</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">             </span><span class="n">tmp</span><span class="p">;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">             </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">            </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;free(): double free detected in tcache 2&quot;</span><span class="p">);</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">            </span><span class="cm">/* If we get here, it was a coincidence.  We&#39;ve wasted a</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="cm">               few cycles, but don&#39;t abort.  */</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">        </span><span class="n">tcache_put</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>它的逻辑也不复杂：</p>
<ol>
<li>计算 tcache index，找到对应的 bin</li>
<li>检查它是不是已经被 free 过了，即 double free：free 过的指针，它的 key 字段应当指向 tcache，如果实际检测到是这样，那就去 tcache 里遍历链表，检查是不是真的在里面，如果是，说明 double free 了，报错</li>
<li>如果对应的 bin 的链表长度不是很长（阈值是 <code>mp_.tcache_count</code>，取值见后），则添加到链表头部，完成 free 的过程</li>
</ol>
<p>那么 tcache 默认情况下有多大呢：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="cp"># define TCACHE_MAX_BINS  64</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cm">/* This is another arbitrary limit, which tunables can change.  Each</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="cm">   tcache bin will hold at most this number of chunks.  */</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="cp"># define TCACHE_FILL_COUNT 7</span>
</span></code></pre></div>
<p>也就是说，它有 64 个 bin，每个 bin 的链表最多 7 个空闲块。</p>
<p>在 64 位下，这 64 个 bin 对应的块大小是从 32 字节到 1040 字节，每 16 字节一个 bin（<code>(1040 - 32) / 16 + 1 = 64</code>）。那么，<code>malloc(1032)</code> 或更小的分配会经过 tcache，而 <code>malloc(1033)</code> 或更大的分配则不会。1032 在代码中对应 <code>MAX_TCACHE_SIZE</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="cp"># define TCACHE_MAX_BINS  64</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="cp"># define tidx2usize(idx)       (((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="cp"># define MAX_TCACHE_SIZE       tidx2usize (TCACHE_MAX_BINS-1)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="c1">// MAX_TCACHE_SIZE = (TCACHE_MAX_BINS - 1) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1">// on 64-bit: 63 * 16 + 32 - 8 = 1032</span>
</span></code></pre></div>
<h4 id="_1">实验</h4>
<p>下面来写一段程序来观察 tcache 的行为，考虑到从链表头部插入和删除是后进先出（LIFO），相当于是一个栈，所以分配两个大小相同的块，释放后再分配相同大小的块，得到的指针的顺序应该是反过来的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="n">p4</span><span class="p">);</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>输出如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">p1</span><span class="o">=</span><span class="mh">0x55fb2f9732a0</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x55fb2f9732d0</span><span class="w"> </span><span class="n">p3</span><span class="o">=</span><span class="mh">0x55fb2f9732d0</span><span class="w"> </span><span class="n">p4</span><span class="o">=</span><span class="mh">0x55fb2f9732a0</span>
</span></code></pre></div>
<p>结果符合预期，tcache 的内部状态变化过程如下：</p>
<ol>
<li><code>free(p1)</code>：p1 变成链表的头部</li>
<li><code>free(p2)</code>：p2 变成链表的头部，next 指针指向 p1</li>
<li><code>p3 = malloc(32)</code>: p2 是链表的头部，所以被分配给 p3，之后 p1 成为链表的头部</li>
<li><code>p4 = malloc(32)</code>: p1 是链表的头部，所以被分配给 p4</li>
</ol>
<p>如果修改分配的大小，让它们被放到不同的 bin，就不会出现顺序颠倒的情况：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="n">p4</span><span class="p">);</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>输出如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">p1</span><span class="o">=</span><span class="mh">0x5638e68db2a0</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x5638e68db2d0</span><span class="w"> </span><span class="n">p3</span><span class="o">=</span><span class="mh">0x5638e68db2a0</span><span class="w"> </span><span class="n">p4</span><span class="o">=</span><span class="mh">0x5638e68db2d0</span>
</span></code></pre></div>
<p>可以看到 p3 等于 p1，p4 等于 p2。此时 p1 和 p3 属于同一个 bin，而 p2 和 p4 属于另一个 bin。</p>
<p>既然我们知道了 tcache 的内部构造，我们可以写一个程序，首先得到 tcache 的地址，再打印出每次 malloc/free 之后的状态：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="cp">#define TCACHE_MAX_BINS 64</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_entry</span><span class="p">;</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_perthread_struct</span><span class="p">;</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_tcache</span><span class="p">(</span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TCACHE_MAX_BINS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">      </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache bin #%d: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="p">}</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">  </span><span class="c1">// leak tcache address</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p0</span><span class="p">);</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p0</span><span class="p">;</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="w">  </span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache is at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="w">  </span><span class="c1">// clear tcache</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="w">  </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after free(p1):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after free(p2):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after malloc(p3):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after malloc(p4):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;p1=%p p2=%p p3=%p p4=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="n">p4</span><span class="p">);</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a><span class="p">}</span>
</span></code></pre></div>
<p>运行结果如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">tcache</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x558f39310010</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">after</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x558f39310740</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="n">after</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x558f39310770</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x558f39310740</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">after</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x558f39310740</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">after</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="n">p1</span><span class="o">=</span><span class="mh">0x558f39310740</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x558f39310770</span><span class="w"> </span><span class="n">p3</span><span class="o">=</span><span class="mh">0x558f39310770</span><span class="w"> </span><span class="n">p4</span><span class="o">=</span><span class="mh">0x558f39310740</span>
</span></code></pre></div>
<p>打印出来的结果和预期一致。</p>
<p>接下来继续分析 malloc 的后续代码。</p>
<h3 id="__libc_malloc">回到 <code>__libc_malloc</code></h3>
<p>如果 malloc 没有命中 tcache，或者 free 没有把空闲块放到 tcache 当中，会发生什么事情呢？接下来往后看，首先是 <code>__libc_malloc</code> 的后续实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_int_malloc</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="n">arena_get</span><span class="w"> </span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_int_malloc</span><span class="w"> </span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span></code></pre></div>
<p>这里出现了 arena 的概念：多线程情况下，为了提升性能，同时用多个 arena，每个 arena 用一把锁来保证多线程安全，从而使得多个线程可以同时从不同的 arena 中分配内存。这里先不讨论多线程的情况，先假设在单线程程序下，全局只用一个 arena：<code>main_arena</code>，然后从里面分配内存。接下来看 <code>_int_malloc</code> 的内部实现，可以看到它根据要分配的块的大小进入了不同的处理：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">// in _int_malloc</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">get_max_fast</span><span class="w"> </span><span class="p">()))</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="c1">// fast bin handling</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="c1">// small bin handling</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="k">else</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="c1">// consolidate fast bins to unsorted bins</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="k">for</span><span class="w"> </span><span class="p">(;;</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="c1">// process unsorted bins</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>malloc 把空闲的块分成四种类型来保存：</p>
<ol>
<li>fast bin: 类似前面的 tcache bin，把大小相同的空闲块放到链表中，再维护多个对应不同大小的空闲块的链表头指针，采用单向链表维护</li>
<li>small bin：small bin 也会把相同的空闲块放在链表中，但相邻的空闲块会被合并为更大的空闲块，采用双向链表维护</li>
<li>large bin：large bin 可能保存不同大小的空闲块，采用双向链表维护</li>
<li>unsorted bin：近期被 free 的空闲块，如果没有保存到 tcache，会被放到 unsorted bin 当中，留待后续的处理</li>
</ol>
<p>在讨论这些 bin 的维护方式之前，首先要知道 glibc 是怎么维护块的：空闲的时候是什么布局，被分配的时候又是什么布局？</p>
<h3 id="_2">块布局</h3>
<p>glibc 每个空闲块（chunk）对应了下面的结构体 <code>malloc_chunk</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w">      </span><span class="n">mchunk_prev_size</span><span class="p">;</span><span class="w">  </span><span class="cm">/* Size of previous chunk (if free).  */</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w">      </span><span class="n">mchunk_size</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Size in bytes, including overhead. */</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="o">*</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">         </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="o">*</span><span class="w"> </span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="o">*</span><span class="w"> </span><span class="n">fd_nextsize</span><span class="p">;</span><span class="w"> </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="o">*</span><span class="w"> </span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="p">};</span>
</span></code></pre></div>
<p>它的字段如下：</p>
<ol>
<li>相邻的前一个空闲块的大小 <code>mchunk_prev_size</code>，记录它是为了方便找到前一个空闲块的开头，这样合并相邻的空闲块就很简单</li>
<li>当前空闲块的大小 <code>mchunk_size</code>，由于块的大小是对齐的，所以它的低位被用来记录 flag</li>
<li><code>fd</code> 和 <code>bk</code>：small bin 和 large bin 需要用双向链表维护空闲块，指针就保存在这里</li>
<li><code>fd_nextsize</code> 和 <code>bk_next_size</code>：large bin 需要用双向链表维护不同大小的空闲块，方便找到合适大小的空闲块</li>
</ol>
<p>这是空闲块的内存布局，那么被分配的内存呢？被分配的内存，相当于是如下的结构：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w">      </span><span class="n">mchunk_size</span><span class="p">;</span><span class="w">       </span><span class="cm">/* Size in bytes, including overhead. */</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[];</span><span class="w">                         </span><span class="cm">/* malloc() returns pointer to payload */</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">};</span>
</span></code></pre></div>
<p>也就是说，<code>malloc()</code> 返回的地址，等于空闲块里 <code>fd</code> 所在的位置。被分配的块，除了用户请求的空间以外，只有前面的 <code>sizeof(size_t)</code> 大小的空间是内存分配器带来的空间开销。块被释放以后，它被重新解释成 <code>malloc_chunk</code> 结构体（注意它们的起始地址不同，<code>malloc_chunk</code> 的地址是 malloc 返回的 <code>payload</code> 地址减去 <code>2 * sizeof(size_t)</code>，对应 <code>mchunk_prev_size</code> 和 <code>mchunk_size</code> 两个字段）。事实上，<code>mchunk_prev_size</code> 保存在用户请求的空间的最后几个字节。内存布局如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a> in-use chunk         free chunk
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>+-------------+      +------------------+
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>| mchunk_size |      | mchunk_size      |
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>+-------------+      +------------------+
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>| payload     |      | fd               |
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>|             |      +------------------+
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>|             |      | bk               |
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>|             |      +------------------+
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>|             |      | fd_nextsize      |
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>|             | ---&gt; +------------------+
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>|             |      | bk_nextsize      |
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>|             |      +------------------+
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>|             |      | unused           |
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>|             |      |                  |
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>|             |      |                  |
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>|             |      |                  |
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>|             |      +------------------+
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>|             |      | mchunk_prev_size |
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>+-------------+      +------------------+
</span></code></pre></div>
<p>因此为了在 payload 和 <code>malloc_chunk</code> 指针之间转换，代码中设计了两个宏来简化指针运算：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cm">/* conversion from malloc headers to user pointers, and back */</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="cp">#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="cp">#define mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span>
</span></code></pre></div>
<p>知道了空闲块的维护方式，由于各个 bin 维护的就是这些空闲块，所以接下来分别看这几种 bin 的维护方式。</p>
<h3 id="fast-bin">fast bin</h3>
<p>fast bin 的维护方式和 tcache 类似，它把不同大小的空闲块按照大小分成多个 bin，每个 bin 记录在一个单向链表当中，然后用一个数组记录各种 bin 大小的链表头，这里直接用的就是 <code>malloc_chunk</code> 指针数组：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">mfastbinptr</span><span class="p">;</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="p">{</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="cm">/* other fields are omitted */</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="cm">/* Fastbins */</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">  </span><span class="n">mfastbinptr</span><span class="w"> </span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">NFASTBINS</span><span class="p">];</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>在 64 位下，默认 <code>NFASTBINS</code> 等于 10，计算方式如下：</p>
<ol>
<li>最大的由 fast bin 管理的块大小等于 <code>80 * sizeof(size_t) / 4 + sizeof(size_t)</code> 向上取整到 16 的倍数，在 64 位机器上等于 176 字节</li>
<li>分配粒度从最小的 32 字节到最大的 176 字节，每 16 字节一个 bin，一共有 10 个 bin（<code>(176 - 32) / 16 + 1 = 10</code>）</li>
</ol>
<p>不过默认情况下，fast bin 管理的块大小通过 <code>set_max_fast(DEFAULT_MXFAST)</code> 被限制在 <code>DEFAULT_MXFAST</code> 附近，这个值等于 <code>64 * sizeof(size_t) / 4</code>，加上 <code>sizeof(size_t)</code> 再向下取整到 16 的倍数，就是 128 字节。此时，只有前 7 个 bin 可以被用到（32 字节到 128 字节，每 16 字节一个 bin，<code>(128 - 32) / 16 + 1 = 7</code>），即 <code>malloc(120)</code> 或更小的分配会保存到 fast bin 中，<code>malloc(121)</code> 或更大的分配则不会。</p>
<h4 id="malloc_1">malloc</h4>
<p>分配的时候，和 tcache 类似，也是计算出 fastbin 的 index，然后去找对应的链表，如果链表非空，则从链表头取出空闲块用于分配：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="cp">#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="cm">/* offset 2 to use otherwise unindexable first 2 bins */</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="cp">#define fastbin_index(sz) \</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="cp">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="c1">// in _int_malloc, allocate using fastbin</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastbin_index</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="n">mfastbinptr</span><span class="w"> </span><span class="o">*</span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fastbin</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="n">mchunkptr</span><span class="w"> </span><span class="n">pp</span><span class="p">;</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">fb</span><span class="p">;</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">      </span><span class="o">*</span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">      </span><span class="n">REMOVE_FB</span><span class="w"> </span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">pp</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_likely</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">victim_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastbin_index</span><span class="w"> </span><span class="p">(</span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">));</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="w"> </span><span class="p">(</span><span class="n">victim_idx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">          </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">);</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">        </span><span class="n">check_remalloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">        </span><span class="cm">/* While we&#39;re here, if we see other chunks of the same size,</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="cm">          stash them in the tcache.  */</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csize2tidx</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">            </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">tc_victim</span><span class="p">;</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">            </span><span class="cm">/* While bin not empty and tcache not full, copy chunks.  */</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">                  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">fb</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">                  </span><span class="o">*</span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">                </span><span class="k">else</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="w">                  </span><span class="p">{</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">                    </span><span class="n">REMOVE_FB</span><span class="w"> </span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">pp</span><span class="p">,</span><span class="w"> </span><span class="n">tc_victim</span><span class="p">);</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">                      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">                  </span><span class="p">}</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="w">                </span><span class="n">tcache_put</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">        </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-23-51"><a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>它的过程如下：</p>
<ol>
<li>使用 <code>fastbin_index (nb)</code> 根据块的大小计算出 fast bin 的 index，然后 <code>fastbin (av, idx)</code> 对应 fast bin 的链表头指针</li>
<li>如果链表非空，说明可以从 fast bin 分配空闲块，此时就把链表头的结点弹出：<code>*fb = victim-&gt;fd</code>（单线程）或 <code>REMOVE_FB (fb, pp, victim)</code>（多线程）；只用到了单向链表的 <code>fd</code> 指针，其余的字段没有用到</li>
<li>进行一系列的安全检查：<code>__builtin_expect</code> 和 <code>check_remalloced_chunk</code></li>
<li>检查 tcache 对应的 bin，如果它还没有满，就把 fast bin 链表中的元素挪到 tcache 当中</li>
<li>把 payload 地址通过 <code>chunk2mem</code> 计算出来，返回给 malloc 调用者</li>
<li>调用 <code>alloc_perturb</code> 往新分配的空间内写入垃圾数据（可选），避免泄露之前的数据</li>
</ol>
<p>可以看到，这个过程比较简单，和 tcache 类似，只不过它从 thread local 的 tcache 改成了支持多线程的版本，同时为了支持多线程访问，使用 CAS 原子指令来更新链表头部：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="cp">#define REMOVE_FB(fb, victim, pp) \</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="cp">  do                              \</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="cp">    {                             \</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="cp">      victim = pp;                \</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="cp">      if (victim == NULL)         \</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="cp">        break;                    \</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="cp">    }                             \</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="cp">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) != victim);</span>
</span></code></pre></div>
<p>正因如此，这个分配过程才能做到比较快，所以这样的分配方法叫做 fast bin。</p>
<h4 id="free_1">free</h4>
<p>接下来分析一下 free 的时候，空闲块是如何进入 fast bin 的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// in _int_free, after tcache handling</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">get_max_fast</span><span class="w"> </span><span class="p">()))</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="cm">/* check omitted */</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="n">free_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">);</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="n">atomic_store_relaxed</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">have_fastchunks</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastbin_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fastbin</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">    </span><span class="cm">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">old2</span><span class="p">;</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="w">        </span><span class="cm">/* Check that the top of the bin is not the record we are going to</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a><span class="cm">          add (i.e., double free).  */</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="w">          </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;double free or corruption (fasttop)&quot;</span><span class="p">);</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="w">        </span><span class="o">*</span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="w">      </span><span class="k">do</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a><span class="w">          </span><span class="cm">/* Check that the top of the bin is not the record we are going to</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="cm">            add (i.e., double free).  */</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a><span class="w">            </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;double free or corruption (fasttop)&quot;</span><span class="p">);</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="w">          </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catomic_compare_and_exchange_val_rel</span><span class="w"> </span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">old2</span><span class="p">))</span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="w">              </span><span class="o">!=</span><span class="w"> </span><span class="n">old2</span><span class="p">);</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="w">    </span><span class="cm">/* check omitted */</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它的逻辑很简单：如果大小合适，就直接添加到 fast bin 的链表头里，没有 tcache 那样的长度限制，多线程场景下依然是用 CAS 来实现原子的链表插入。</p>
<p>相比 tcache，fast bin 的 double free 检查更加简陋：它只能防护连续两次 free 同一个块，只判断了要插入链表的块是否在链表头，而不会检查是否在链表中间。</p>
<h4 id="_3">实验</h4>
<p>接下来写一段代码来观察 fast bin 的更新过程：</p>
<ol>
<li>由于 fastbin 保存在 <code>main_arena</code> 中，所以我们需要找到 <code>main_arena</code> 的运行时地址</li>
<li><code>main_arena</code> 不在 libc 符号表中，不能直接找到它的地址，此时可以通过 libc 的调试符号，找到它相对 image base 的 offset 是 <code>0x1ecb80</code></li>
<li>再找一个在符号表中的符号 <code>_IO_2_1_stdout_</code>，它相对 image base 的 offset 是 <code>0x1ed6a0</code></li>
<li>根据以上信息，就可以在运行时找到 libc 的 image base 地址，从而推断 <code>main_arena</code> 的地址，进而找到所有的 fast bin</li>
<li>下面写一段代码，观察空闲块进入 fast bin 的过程</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stddef.h&gt;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mchunk_prev_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Size of previous chunk (if free).  */</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mchunk_size</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Size in bytes, including overhead. */</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">  </span><span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fd_nextsize</span><span class="p">;</span><span class="w"> </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="p">};</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="cm">/* offset 2 to use otherwise unindexable first 2 bins */</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="cp">#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="cp">#define INTERNAL_SIZE_T size_t</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="cm">/* MALLOC_ALIGNMENT equals to 16 on 64-bit */</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="cp">#define MALLOC_ALIGNMENT                                                       \</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="cp">  (2 * SIZE_SZ &lt; __alignof__(long double) ? __alignof__(long double)           \</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="cp">                                          : 2 * SIZE_SZ)</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="cm">/* The corresponding word size.  */</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="cm">/* SIZE_SZ equals to 8 on 64-bit */</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="cp">#define SIZE_SZ (sizeof(INTERNAL_SIZE_T))</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="cm">/* The corresponding bit mask value.  */</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="cm">/* MALLOC_ALIGN_MASK equals to 15 on 64-bit */</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="cp">#define MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="cm">/* The smallest possible chunk */</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="cm">/* MIN_CHUNK_SIZE equals to 32 on 64-bit */</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="cp">#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="cm">/* The smallest size we can malloc is an aligned minimal chunk */</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="cm">/* MINSIZE equals to 32 on 64-bit */</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="cp">#define MINSIZE                                                                \</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="cp">  (unsigned long)(((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="cm">/* equivalent to max(alignUp(req + SIZE_SZ, MALLOC_ALIGNMENT), MINSIZE) */</span>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="cp">#define request2size(req)                                                      \</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="cp">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                             \</span>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="cp">       ? MINSIZE                                                               \</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="cp">       : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a><span class="cm">/* MAX_FAST_SIZE equals to 160 on 64-bit */</span>
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a><span class="cp">#define MAX_FAST_SIZE (80 * SIZE_SZ / 4)</span>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a><span class="cm">/* NFASTBINS equals to 10 on 64-bit */</span>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a><span class="cp">#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a><span class="w">  </span><span class="cm">/* Serialize access.  */</span>
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a><span class="w">  </span><span class="cm">/* Flags (formerly in max_fast).  */</span>
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a><span class="w">  </span><span class="cm">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a><span class="w">  </span><span class="cm">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">have_fastchunks</span><span class="p">;</span>
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a><span class="w">  </span><span class="cm">/* Fastbins */</span>
</span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">NFASTBINS</span><span class="p">];</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a><span class="p">};</span>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_fastbin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">libc_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stdout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x1ed6a0</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of _IO_2_1_stdout_</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="o">*</span><span class="n">main_arena</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-26-72"><a id="__codelineno-26-72" name="__codelineno-26-72" href="#__codelineno-26-72"></a><span class="w">      </span><span class="n">libc_base</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-26-73"><a id="__codelineno-26-73" name="__codelineno-26-73" href="#__codelineno-26-73"></a><span class="w">      </span><span class="mh">0x1ecb80</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of main_arena</span>
</span><span id="__span-26-74"><a id="__codelineno-26-74" name="__codelineno-26-74" href="#__codelineno-26-74"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NFASTBINS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-75"><a id="__codelineno-26-75" name="__codelineno-26-75" href="#__codelineno-26-75"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">main_arena</span><span class="o">-&gt;</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-76"><a id="__codelineno-26-76" name="__codelineno-26-76" href="#__codelineno-26-76"></a><span class="w">      </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_arena</span><span class="o">-&gt;</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-26-77"><a id="__codelineno-26-77" name="__codelineno-26-77" href="#__codelineno-26-77"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbin #%d: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-26-78"><a id="__codelineno-26-78" name="__codelineno-26-78" href="#__codelineno-26-78"></a><span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-26-79"><a id="__codelineno-26-79" name="__codelineno-26-79" href="#__codelineno-26-79"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-80"><a id="__codelineno-26-80" name="__codelineno-26-80" href="#__codelineno-26-80"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-26-81"><a id="__codelineno-26-81" name="__codelineno-26-81" href="#__codelineno-26-81"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-26-82"><a id="__codelineno-26-82" name="__codelineno-26-82" href="#__codelineno-26-82"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-26-83"><a id="__codelineno-26-83" name="__codelineno-26-83" href="#__codelineno-26-83"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-84"><a id="__codelineno-26-84" name="__codelineno-26-84" href="#__codelineno-26-84"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-85"><a id="__codelineno-26-85" name="__codelineno-26-85" href="#__codelineno-26-85"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-26-86"><a id="__codelineno-26-86" name="__codelineno-26-86" href="#__codelineno-26-86"></a><span class="p">}</span>
</span><span id="__span-26-87"><a id="__codelineno-26-87" name="__codelineno-26-87" href="#__codelineno-26-87"></a>
</span><span id="__span-26-88"><a id="__codelineno-26-88" name="__codelineno-26-88" href="#__codelineno-26-88"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-89"><a id="__codelineno-26-89" name="__codelineno-26-89" href="#__codelineno-26-89"></a><span class="w">  </span><span class="c1">// use 10 malloc + free, the first 7 blocks will be saved in tcache, the rest</span>
</span><span id="__span-26-90"><a id="__codelineno-26-90" name="__codelineno-26-90" href="#__codelineno-26-90"></a><span class="w">  </span><span class="c1">// ones will go to fastbin</span>
</span><span id="__span-26-91"><a id="__codelineno-26-91" name="__codelineno-26-91" href="#__codelineno-26-91"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span id="__span-26-92"><a id="__codelineno-26-92" name="__codelineno-26-92" href="#__codelineno-26-92"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocate 10 pointers:&quot;</span><span class="p">);</span>
</span><span id="__span-26-93"><a id="__codelineno-26-93" name="__codelineno-26-93" href="#__codelineno-26-93"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-94"><a id="__codelineno-26-94" name="__codelineno-26-94" href="#__codelineno-26-94"></a><span class="w">    </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-26-95"><a id="__codelineno-26-95" name="__codelineno-26-95" href="#__codelineno-26-95"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-26-96"><a id="__codelineno-26-96" name="__codelineno-26-96" href="#__codelineno-26-96"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-26-97"><a id="__codelineno-26-97" name="__codelineno-26-97" href="#__codelineno-26-97"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-98"><a id="__codelineno-26-98" name="__codelineno-26-98" href="#__codelineno-26-98"></a>
</span><span id="__span-26-99"><a id="__codelineno-26-99" name="__codelineno-26-99" href="#__codelineno-26-99"></a><span class="w">  </span><span class="c1">// now one ptr goes to fastbin</span>
</span><span id="__span-26-100"><a id="__codelineno-26-100" name="__codelineno-26-100" href="#__codelineno-26-100"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-101"><a id="__codelineno-26-101" name="__codelineno-26-101" href="#__codelineno-26-101"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-26-102"><a id="__codelineno-26-102" name="__codelineno-26-102" href="#__codelineno-26-102"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-26-103"><a id="__codelineno-26-103" name="__codelineno-26-103" href="#__codelineno-26-103"></a>
</span><span id="__span-26-104"><a id="__codelineno-26-104" name="__codelineno-26-104" href="#__codelineno-26-104"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after 8 pointers freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-105"><a id="__codelineno-26-105" name="__codelineno-26-105" href="#__codelineno-26-105"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-26-106"><a id="__codelineno-26-106" name="__codelineno-26-106" href="#__codelineno-26-106"></a>
</span><span id="__span-26-107"><a id="__codelineno-26-107" name="__codelineno-26-107" href="#__codelineno-26-107"></a><span class="w">  </span><span class="c1">// free the 9th one</span>
</span><span id="__span-26-108"><a id="__codelineno-26-108" name="__codelineno-26-108" href="#__codelineno-26-108"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
</span><span id="__span-26-109"><a id="__codelineno-26-109" name="__codelineno-26-109" href="#__codelineno-26-109"></a>
</span><span id="__span-26-110"><a id="__codelineno-26-110" name="__codelineno-26-110" href="#__codelineno-26-110"></a><span class="w">  </span><span class="c1">// two pointers in the fastbin</span>
</span><span id="__span-26-111"><a id="__codelineno-26-111" name="__codelineno-26-111" href="#__codelineno-26-111"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after 9 pointers freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-112"><a id="__codelineno-26-112" name="__codelineno-26-112" href="#__codelineno-26-112"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-26-113"><a id="__codelineno-26-113" name="__codelineno-26-113" href="#__codelineno-26-113"></a>
</span><span id="__span-26-114"><a id="__codelineno-26-114" name="__codelineno-26-114" href="#__codelineno-26-114"></a><span class="w">  </span><span class="c1">// free the 10th one</span>
</span><span id="__span-26-115"><a id="__codelineno-26-115" name="__codelineno-26-115" href="#__codelineno-26-115"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
</span><span id="__span-26-116"><a id="__codelineno-26-116" name="__codelineno-26-116" href="#__codelineno-26-116"></a>
</span><span id="__span-26-117"><a id="__codelineno-26-117" name="__codelineno-26-117" href="#__codelineno-26-117"></a><span class="w">  </span><span class="c1">// three pointers in the fastbin</span>
</span><span id="__span-26-118"><a id="__codelineno-26-118" name="__codelineno-26-118" href="#__codelineno-26-118"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after 10 pointers freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-119"><a id="__codelineno-26-119" name="__codelineno-26-119" href="#__codelineno-26-119"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-26-120"><a id="__codelineno-26-120" name="__codelineno-26-120" href="#__codelineno-26-120"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-26-121"><a id="__codelineno-26-121" name="__codelineno-26-121" href="#__codelineno-26-121"></a><span class="p">}</span>
</span></code></pre></div>
<p>输出如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">allocate</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">pointers</span><span class="o">:</span><span class="w"> </span><span class="mh">0x563bd918d6b0</span><span class="w"> </span><span class="mh">0x563bd918d6e0</span><span class="w"> </span><span class="mh">0x563bd918d710</span><span class="w"> </span><span class="mh">0x563bd918d740</span><span class="w"> </span><span class="mh">0x563bd918d770</span><span class="w"> </span><span class="mh">0x563bd918d7a0</span><span class="w"> </span><span class="mh">0x563bd918d7d0</span><span class="w"> </span><span class="mh">0x563bd918d800</span><span class="w"> </span><span class="mh">0x563bd918d830</span><span class="w"> </span><span class="mh">0x563bd918d860</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">pointers</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x563bd918d7f0</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">pointers</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x563bd918d820</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x563bd918d7f0</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">pointers</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x563bd918d850</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x563bd918d820</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x563bd918d7f0</span>
</span></code></pre></div>
<p>可以看到，代码先分配了十个块，再按顺序释放，那么前七个块会进入 tcache，剩下的三个块则进入了同一个 fast bin，并且后释放的会在链表的开头。注意 fast bin 链表里的地址打印的是 chunk 地址，而用 <code>malloc</code> 分配的地址指向的是 payload 部分，二者差了 16 字节，最终 fast bin 就是把十个块里最后三个块用链表串起来。由于总是往链表的头部插入空闲块，所以后释放的块出现在靠前的位置。</p>
<h3 id="small-bin">small bin</h3>
<p>分析完 fast bin，接下来来看 small bin。small bin 每个 bin 内空闲块的大小是相同的，并且也是以链表的方式组织，只不过用的是双向链表。</p>
<h4 id="malloc_2">malloc</h4>
<p>接下来观察 <code>_int_malloc</code> 是怎么使用 small bin 的。前面提到，<code>_int_malloc</code> 首先会尝试在 fast bin 中分配，如果分配失败，或者大小超出了 fast bin 的范围，接下来会尝试在 small bin 中分配：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">// in _int_malloc</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bin</span><span class="p">)</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">        </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">victim</span><span class="p">))</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">          </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): smallbin double linked list corrupted&quot;</span><span class="p">);</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">        </span><span class="n">set_inuse_bit_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">        </span><span class="n">bin</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">        </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin</span><span class="p">;</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">          </span><span class="n">set_non_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">        </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">        </span><span class="cm">/* While we&#39;re here, if we see other chunks of the same size,</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="cm">           stash them in the tcache.  */</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csize2tidx</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tc_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">            </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">tc_victim</span><span class="p">;</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">            </span><span class="cm">/* While bin not empty and tcache not full, copy chunks over.  */</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">                   </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bin</span><span class="p">)</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">                  </span><span class="p">{</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">                    </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">                    </span><span class="n">set_inuse_bit_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a><span class="w">                      </span><span class="n">set_non_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="p">);</span>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="w">                    </span><span class="n">bin</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">                    </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin</span><span class="p">;</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">                    </span><span class="n">tcache_put</span><span class="w"> </span><span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="w">                  </span><span class="p">}</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a><span class="w">        </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-28-47"><a id="__codelineno-28-47" name="__codelineno-28-47" href="#__codelineno-28-47"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>它的过程如下：</p>
<ol>
<li>使用 <code>in_smallbin_range (nb)</code> 检查块的大小是否应该放到 small bin 当中</li>
<li>使用 <code>smallbin_index (nb)</code> 根据块的大小计算出 small bin 的 index，然后 <code>bin_at (av, idx)</code> 对应 small bin 的链表尾部的哨兵，这个双向链表有且只有一个哨兵，这个哨兵就放在 small bin 数组当中</li>
<li>找到哨兵结点的前驱结点 <code>last (bin)</code>，如果链表为空，那么哨兵的前驱结点就是它自己；如果链表非空，那么哨兵的前驱结点就是链表里的最后一个结点，把它赋值给 <code>victim</code></li>
<li>把这个空闲块标记为正在使用：<code>set_inuse_bit_at_offset (victim, nb)</code></li>
<li>把 <code>victim</code> 从链表里删除：<code>bck = victim-&gt;bk; bin-&gt;bk = bck; bck-&gt;fd = bin;</code>，典型的双向链表的结点删除过程，维护 <code>victim</code> 前驱结点的后继指针，维护哨兵 <code>bin</code> 的前驱指针</li>
<li>进行一系列的安全检查：<code>check_malloced_chunk</code></li>
<li>检查 tcache 对应的 bin，如果它还没有满，就把 small bin 链表中的元素挪到 tcache 当中</li>
<li>把 payload 地址通过 <code>chunk2mem</code> 计算出来，返回给 malloc 调用者</li>
<li>调用 <code>alloc_perturb</code> 往新分配的空间内写入垃圾数据（可选），避免泄露之前的数据</li>
</ol>
<p>其实现过程和 fast bin 很类似，只不过把单向链表改成了双向，并且引入了哨兵结点，这个哨兵结点保存在 <code>malloc_state</code> 结构的 bins 数组当中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="cp">#define NSMALLBINS         64</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="cm">/* SMALLBIN_WIDTH equals to 16 on 64-bit */</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="cp">#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="cm">/* SMALLBIN_CORRECTION equals to 0 on 64-bit */</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="cp">#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="cm">/* MIN_LARGE_SIZE equals to 1024 on 64-bit */</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="cp">#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="cm">/* equivalent to (sz &lt; 1024) on 64-bit */</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="cp">#define in_smallbin_range(sz)  \</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="cp">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="cm">/* equivalent to (sz &gt;&gt; 4) on 64-bit */</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="cp">#define smallbin_index(sz) \</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="cp">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="cp">   + SMALLBIN_CORRECTION)</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="o">*</span><span class="w"> </span><span class="n">mchunkptr</span><span class="p">;</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="cm">/* addressing -- note that bin_at(0) does not exist */</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="cp">#define bin_at(m, i) \</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="cp">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                              \</span>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="cp">             - offsetof (struct malloc_chunk, fd))</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="cp">#define NBINS             128</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="p">{</span>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">  </span><span class="cm">/* omitted */</span>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">  </span><span class="cm">/* Normal bins packed as described above */</span>
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">bins</span><span class="p">[</span><span class="n">NBINS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="p">}</span>
</span></code></pre></div>
<p>乍一看会觉得很奇怪，这里 <code>NBINS * 2 - 2</code> 是什么意思？<code>mchunkptr</code> 是个指针类型，那它指向的数据存在哪？其实这里用了一个小的 trick：</p>
<ol>
<li>不去看 bins 元素的类型，只考虑它的元素的大小，每个元素大小是 <code>sizeof(size_t)</code>，一共有 <code>NBINS * 2 - 2</code> 个元素</li>
<li>而每个 bin 对应一个链表的哨兵结点，由于是双向链表，哨兵结点也没有数据，只需要保存前驱和后继两个指针，即每个 bin 只需要存两个指针的空间，也就是 <code>2 * sizeof(size_t)</code></li>
<li>正好 <code>bins</code> 数组给每个 bin 留出了 <code>2 * sizeof(size_t)</code> 的空间（bin 0 除外，这个 bin 不存在），所以实际上这些哨兵结点的前驱和后继指针就保存在 <code>bins</code> 数组里，按顺序保存，首先是 bin 1 的前驱，然后是 bin 1 的后继，接着是 bin 2 的前驱，依此类推</li>
<li>虽然空间对上了，但是为了方便使用，代码里用 <code>bin_at</code> 宏来计算出一个 <code>malloc_chunk</code> 结构体的指针，而已知 bins 数组只保存了 <code>fd</code> 和 <code>bk</code> 两个指针，并且 bin 的下标从 1 开始，所以 bin i 的 <code>fd</code> 指针地址就是 <code>(char *) &amp;((m)-&gt;bins[((i) - 1) * 2])</code>，再减去 <code>malloc_chunk</code> 结构体中 <code>fd</code> 成员的偏移，就得到了一个 <code>malloc_chunk</code> 结构体的指针，当然了，这个结构体只有 <code>fd</code> 和 <code>bk</code> 两个字段是合法的，其他字段如果访问了，就会访问到其他 bin 那里去</li>
</ol>
<p>抛开这些 trick，其实就等价于用一个数组保存了每个 bin 的 <code>fd</code> 和 <code>bk</code> 指针，至于为什么要强行转换成 <code>malloc_chunk</code> 类型的指针，可能是为了方便代码的编写，不需要区分空闲块的结点和哨兵结点。</p>
<p>此外，small bin 的处理里还多了一次 <code>set_inuse_bit_at_offset (victim, nb)</code>，它的定义如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="cp">#define set_inuse_bit_at_offset(p, s)                                              \</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="cp">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;mchunk_size |= PREV_INUSE)</span>
</span></code></pre></div>
<p>乍一看会觉得很奇怪，这个访问不是越界了吗？其实这个就是跨过当前的 chunk，访问相邻的下一个 chunk，在它的 <code>mchunk_size</code> 字段上打标记，表示它的前一个 chunk 已经被占用。前面提到过，<code>mchunk_size</code> 同时保存了 chunk 的大小和一些 flag，由于 chunk 的大小至少是 8 字节对齐的（32 位系统上），所以最低的 3 位就被拿来保存如下的 flag：</p>
<ol>
<li><code>PREV_INUSE(0x1)</code>: 前一个 chunk 已经被分配</li>
<li><code>IS_MAPPED(0x2)</code>：当前 chunk 的内存来自于 mmap</li>
<li><code>NON_MAIN_ARENA(0x4)</code>：当前 chunk 来自于 main arena 以外的其他 arena</li>
</ol>
<p>在这里，就是设置了 <code>PREV_INUSE</code> flag，方便后续的相邻块的合并。</p>
<p>可以注意到，small bin 的分配范围是 <code>nb &lt; MIN_LARGE_SIZE</code>，因此在 64 位上，<code>malloc(1000)</code> 或更小的分配会被 small bin 分配，而 <code>malloc(1001)</code> 或更大的分配则不可以。</p>
<h4 id="free_2">free</h4>
<p>在讲述 small bin 在 free 中的实现之前，先讨论 <code>_int_malloc</code> 的后续逻辑，最后再回过头来看 free 的部分。</p>
<h3 id="consolidate">consolidate</h3>
<p>当要分配的块经过 fast bin 和 small bin 两段逻辑都没能分配成功，并且要分配的块比较大的时候（<code>!in_small_range (nb)</code>），会进行一次 <code>malloc_consolidate</code> 调用，这个函数会尝试对 fast bin 中的空闲块进行合并，然后把新的块插入到 unsorted bin 当中。它的实现如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">unsorted_bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">maxfb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fastbin</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">NFASTBINS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fastbin</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_exchange_acq</span><span class="w"> </span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">      </span><span class="cm">/* malloc check omitted */</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">      </span><span class="n">check_inuse_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="w">      </span><span class="n">nextp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">      </span><span class="cm">/* Slightly streamlined version of consolidation code in free() */</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="w">      </span><span class="n">nextchunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">      </span><span class="n">nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">);</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">prev_inuse</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="w">        </span><span class="n">prevsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev_size</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">prevsize</span><span class="p">;</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">prevsize</span><span class="p">));</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">        </span><span class="cm">/* malloc check omitted */</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">        </span><span class="n">unlink_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextchunk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">        </span><span class="n">nextinuse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inuse_bit_at_offset</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span><span class="w"> </span><span class="n">nextsize</span><span class="p">);</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">nextinuse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="w">          </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nextsize</span><span class="p">;</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">          </span><span class="n">unlink_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">nextchunk</span><span class="p">);</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="w">          </span><span class="n">clear_inuse_bit_at_offset</span><span class="p">(</span><span class="n">nextchunk</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a><span class="w">        </span><span class="n">first_unsorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_bin</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="w">        </span><span class="n">unsorted_bin</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a><span class="w">        </span><span class="n">first_unsorted</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a>
</span><span id="__span-31-39"><a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-40"><a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a><span class="w">          </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-31-41"><a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a><span class="w">          </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-31-42"><a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-31-43"><a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a>
</span><span id="__span-31-44"><a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a><span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-31-45"><a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_bin</span><span class="p">;</span>
</span><span id="__span-31-46"><a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a><span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_unsorted</span><span class="p">;</span>
</span><span id="__span-31-47"><a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a><span class="w">        </span><span class="n">set_foot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-31-48"><a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-31-49"><a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a>
</span><span id="__span-31-50"><a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-51"><a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nextsize</span><span class="p">;</span>
</span><span id="__span-31-52"><a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a><span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-31-53"><a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a><span class="w">        </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-31-54"><a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-31-55"><a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a>
</span><span id="__span-31-56"><a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nextp</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-31-57"><a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a>
</span><span id="__span-31-58"><a id="__codelineno-31-58" name="__codelineno-31-58" href="#__codelineno-31-58"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-31-59"><a id="__codelineno-31-59" name="__codelineno-31-59" href="#__codelineno-31-59"></a><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fb</span><span class="o">++</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">maxfb</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>第一层循环，遍历每个非空的 fast bin，进行下列操作</li>
<li>第二层循环，每个非空的 fast bin 有一个单向链表，沿着链表进行迭代，遍历链表上的每个空闲块，进行下列操作</li>
<li>循环内部，检查当前空闲块能否和前后的空闲块合并</li>
<li>首先检查在它前面（地址更低的）相邻的块是否空闲：如果 <code>PREV_INUSE</code> 没有被设置，可以通过 <code>mchunk_prev_size</code> 找到前面相邻的块的开头，然后把两个块合并起来；如果前面相邻的块已经在某个双向链表当中（例如 small bin），把它从双向链表中删除：<code>unlink_chunk (av, p);</code>；为什么前面要用双向链表，也是为了在这里可以直接从链表中间删除一个结点</li>
<li>接着检查在它后面（地址更高的）相邻的块是否空闲：根据自己的 size，计算出下一个块的地址，得到下一个块的大小，再读取下一个块的下一个块，根据它的 <code>PREV_INUSE</code>，判断下一个块是否空闲；如果空闲，那就把下一个块也合并进来，同理也要把它从双向链表中删除：<code>unlink_chunk (av, nextchunk);</code>；代码中还有对 top chunk 的特殊处理，这里先略过</li>
<li>合并完成以后，把当前的空闲块放到 unsorted bin 当中，也是一个简单的双向链表向链表头的插入算法：<code>first_unsorted = unsorted_bin-&gt;fd; unsorted_bin-&gt;fd = p; first_unsorted-&gt;bk = p; p-&gt;bk = unsorted_bin; p-&gt;fd = first_unsorted;</code></li>
</ol>
<p><code>unlink_chunk</code> 的实现就是经典的双向链表删除结点的算法：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cm">/* Take a chunk off a bin list.  */</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="nf">unlink_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">mstate</span><span class="w"> </span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="p">{</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">  </span><span class="cm">/* malloc check omitted */</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">  </span><span class="cm">/* malloc check omitted */</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">  </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">  </span><span class="n">bk</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">      </span><span class="cm">/* malloc check omitted */</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-32-19"><a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-32-20"><a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-32-21"><a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">            </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-32-22"><a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">          </span><span class="k">else</span>
</span><span id="__span-32-23"><a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-32-24"><a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">              </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="p">;</span>
</span><span id="__span-32-25"><a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">              </span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-32-26"><a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">              </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-32-27"><a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">              </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-32-28"><a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-32-29"><a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-32-30"><a id="__codelineno-32-30" name="__codelineno-32-30" href="#__codelineno-32-30"></a><span class="w">      </span><span class="k">else</span>
</span><span id="__span-32-31"><a id="__codelineno-32-31" name="__codelineno-32-31" href="#__codelineno-32-31"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-32-32"><a id="__codelineno-32-32" name="__codelineno-32-32" href="#__codelineno-32-32"></a><span class="w">          </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-32-33"><a id="__codelineno-32-33" name="__codelineno-32-33" href="#__codelineno-32-33"></a><span class="w">          </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="p">;</span>
</span><span id="__span-32-34"><a id="__codelineno-32-34" name="__codelineno-32-34" href="#__codelineno-32-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-32-35"><a id="__codelineno-32-35" name="__codelineno-32-35" href="#__codelineno-32-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-36"><a id="__codelineno-32-36" name="__codelineno-32-36" href="#__codelineno-32-36"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 字段适用于 large bin，后面会讨论这个双向链表的细节。</p>
<p>因此 unsorted bin 保存了一些从 fast bin 合并而来的一些块，由于 unsorted bin 只有一个，所以它里面会保存各种大小的空闲块。实际上，unsorted bin 占用的就是 <code>malloc_state</code> 结构中的 bin 1，因为我们已经知道，块的大小至少是 32，而大小为 32 的块，对应的 small bin index 是 2，说明 1 没有被用到，其实就是留给 unsorted bin 用的。在 64 位系统下，<code>malloc_state</code> 的 127 个 bin 分配如下：</p>
<ol>
<li>bin 1 是 unsorted bin</li>
<li>bin 2 到 bin 63 是 small bin</li>
<li>bin 64 到 bin 126 是 large bin</li>
</ol>
<p>bin 127 没有用到。</p>
<p>经过这次合并之后，接下来 <code>_int_malloc</code> 尝试从 unsorted bin 和 large bin 中分配空闲块。</p>
<h3 id="__libc_malloc_1">再次回到 <code>__libc_malloc</code></h3>
<p>接下来，<code>_int_malloc</code> 有一大段代码来进行后续的内存分配，大概步骤包括：</p>
<ol>
<li>把 unsorted bin 中的空闲块的处理，放到 small bin 或者 large bin 中，同时如果有合适的块，就分配给 malloc 的调用者</li>
<li>如果还是没有找到合适大小的块，就在 large bin 里寻找空闲块来分配；如果找不到合适大小的块，进行 consolidate，尝试更多的合并，得到更大的块；重复这个过程多次</li>
<li>如果还是找不到合适的块，就从堆顶分配新的块，如果堆已经满了，还需要去扩大堆，或者直接用 mmap 分配一片内存</li>
</ol>
<p>现在分步骤观察这个过程，首先观察 unsorted bin 的处理。</p>
<h3 id="unsorted-bin">unsorted bin</h3>
<p>首先是 unsorted bin 的空闲块的处理：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">iters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">))</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="cm">/* malloc checks omitted */</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="cm">       If a small request, try to use last remainder if it is the</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="cm">       only chunk in unsorted bin.  This helps promote locality for</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="cm">       runs of consecutive small requests. This is the only</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="cm">       exception to best-fit, and applies only when there is</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="cm">       no exact fit for a small chunk.</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="cm">     */</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">        </span><span class="n">bck</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">        </span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">        </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">))</span>
</span><span id="__span-33-22"><a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-33-23"><a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">        </span><span class="cm">/* split and reattach remainder */</span>
</span><span id="__span-33-24"><a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">        </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
</span><span id="__span-33-25"><a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">        </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-33-26"><a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">        </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-33-27"><a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">        </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-33-28"><a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">        </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-33-29"><a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span>
</span><span id="__span-33-30"><a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-33-31"><a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-33-32"><a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-33-33"><a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-33-34"><a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>
</span><span id="__span-33-35"><a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="w">        </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-33-36"><a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a><span class="w">                  </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-33-37"><a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a><span class="w">        </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-33-38"><a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a><span class="w">        </span><span class="n">set_foot</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
</span><span id="__span-33-39"><a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>
</span><span id="__span-33-40"><a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a><span class="w">        </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-33-41"><a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-33-42"><a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="w">        </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-33-43"><a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-33-44"><a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-45"><a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>
</span><span id="__span-33-46"><a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a><span class="w">    </span><span class="cm">/* remove from unsorted list */</span>
</span><span id="__span-33-47"><a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a><span class="w">    </span><span class="cm">/* malloc checks omitted */</span>
</span><span id="__span-33-48"><a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="w">    </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-33-49"><a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a><span class="w">    </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-33-50"><a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a>
</span><span id="__span-33-51"><a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a><span class="w">    </span><span class="cm">/* Take now instead of binning if exact fit */</span>
</span><span id="__span-33-52"><a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a>
</span><span id="__span-33-53"><a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nb</span><span class="p">)</span>
</span><span id="__span-33-54"><a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-33-55"><a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a><span class="w">        </span><span class="n">set_inuse_bit_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-33-56"><a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span>
</span><span id="__span-33-57"><a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a><span class="w">          </span><span class="n">set_non_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-33-58"><a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a><span class="w">        </span><span class="cm">/* Fill cache first, return to user only if cache fills.</span>
</span><span id="__span-33-59"><a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a><span class="cm">           We may return one of these chunks later.  */</span>
</span><span id="__span-33-60"><a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache_nb</span>
</span><span id="__span-33-61"><a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
</span><span id="__span-33-62"><a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-33-63"><a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a><span class="w">            </span><span class="n">tcache_put</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-33-64"><a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a><span class="w">            </span><span class="n">return_cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-33-65"><a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-33-66"><a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-33-67"><a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-33-68"><a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-33-69"><a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a><span class="w">            </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-33-70"><a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a><span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-33-71"><a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="w">            </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-33-72"><a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-33-73"><a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-33-74"><a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-75"><a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a>
</span><span id="__span-33-76"><a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a><span class="w">    </span><span class="cm">/* place chunk in bin */</span>
</span><span id="__span-33-77"><a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a>
</span><span id="__span-33-78"><a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span><span id="__span-33-79"><a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-33-80"><a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a><span class="w">        </span><span class="n">victim_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-33-81"><a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a><span class="w">        </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span>
</span><span id="__span-33-82"><a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a><span class="w">        </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-33-83"><a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-84"><a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-33-85"><a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-33-86"><a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a><span class="w">        </span><span class="n">victim_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-33-87"><a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a><span class="w">        </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span>
</span><span id="__span-33-88"><a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a><span class="w">        </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-33-89"><a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a>
</span><span id="__span-33-90"><a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a><span class="w">        </span><span class="cm">/* maintain large bins in sorted order */</span>
</span><span id="__span-33-91"><a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">)</span>
</span><span id="__span-33-92"><a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-33-93"><a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a><span class="w">            </span><span class="cm">/* Or with inuse bit to speed comparisons */</span>
</span><span id="__span-33-94"><a id="__codelineno-33-94" name="__codelineno-33-94" href="#__codelineno-33-94"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">;</span>
</span><span id="__span-33-95"><a id="__codelineno-33-95" name="__codelineno-33-95" href="#__codelineno-33-95"></a><span class="w">            </span><span class="cm">/* if smaller than smallest, bypass loop below */</span>
</span><span id="__span-33-96"><a id="__codelineno-33-96" name="__codelineno-33-96" href="#__codelineno-33-96"></a><span class="w">            </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">));</span>
</span><span id="__span-33-97"><a id="__codelineno-33-97" name="__codelineno-33-97" href="#__codelineno-33-97"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-33-98"><a id="__codelineno-33-98" name="__codelineno-33-98" href="#__codelineno-33-98"></a><span class="w">                </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">))</span>
</span><span id="__span-33-99"><a id="__codelineno-33-99" name="__codelineno-33-99" href="#__codelineno-33-99"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-33-100"><a id="__codelineno-33-100" name="__codelineno-33-100" href="#__codelineno-33-100"></a><span class="w">                </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-33-101"><a id="__codelineno-33-101" name="__codelineno-33-101" href="#__codelineno-33-101"></a><span class="w">                </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-33-102"><a id="__codelineno-33-102" name="__codelineno-33-102" href="#__codelineno-33-102"></a>
</span><span id="__span-33-103"><a id="__codelineno-33-103" name="__codelineno-33-103" href="#__codelineno-33-103"></a><span class="w">                </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-33-104"><a id="__codelineno-33-104" name="__codelineno-33-104" href="#__codelineno-33-104"></a><span class="w">                </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-33-105"><a id="__codelineno-33-105" name="__codelineno-33-105" href="#__codelineno-33-105"></a><span class="w">                </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-106"><a id="__codelineno-33-106" name="__codelineno-33-106" href="#__codelineno-33-106"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-33-107"><a id="__codelineno-33-107" name="__codelineno-33-107" href="#__codelineno-33-107"></a><span class="w">            </span><span class="k">else</span>
</span><span id="__span-33-108"><a id="__codelineno-33-108" name="__codelineno-33-108" href="#__codelineno-33-108"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-33-109"><a id="__codelineno-33-109" name="__codelineno-33-109" href="#__codelineno-33-109"></a><span class="w">                </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
</span><span id="__span-33-110"><a id="__codelineno-33-110" name="__codelineno-33-110" href="#__codelineno-33-110"></a><span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span>
</span><span id="__span-33-111"><a id="__codelineno-33-111" name="__codelineno-33-111" href="#__codelineno-33-111"></a><span class="w">                  </span><span class="p">{</span>
</span><span id="__span-33-112"><a id="__codelineno-33-112" name="__codelineno-33-112" href="#__codelineno-33-112"></a><span class="w">                    </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="p">;</span>
</span><span id="__span-33-113"><a id="__codelineno-33-113" name="__codelineno-33-113" href="#__codelineno-33-113"></a><span class="w">                    </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
</span><span id="__span-33-114"><a id="__codelineno-33-114" name="__codelineno-33-114" href="#__codelineno-33-114"></a><span class="w">                  </span><span class="p">}</span>
</span><span id="__span-33-115"><a id="__codelineno-33-115" name="__codelineno-33-115" href="#__codelineno-33-115"></a>
</span><span id="__span-33-116"><a id="__codelineno-33-116" name="__codelineno-33-116" href="#__codelineno-33-116"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">size</span>
</span><span id="__span-33-117"><a id="__codelineno-33-117" name="__codelineno-33-117" href="#__codelineno-33-117"></a><span class="w">                    </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span>
</span><span id="__span-33-118"><a id="__codelineno-33-118" name="__codelineno-33-118" href="#__codelineno-33-118"></a><span class="w">                  </span><span class="cm">/* Always insert in the second position.  */</span>
</span><span id="__span-33-119"><a id="__codelineno-33-119" name="__codelineno-33-119" href="#__codelineno-33-119"></a><span class="w">                  </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-33-120"><a id="__codelineno-33-120" name="__codelineno-33-120" href="#__codelineno-33-120"></a><span class="w">                </span><span class="k">else</span>
</span><span id="__span-33-121"><a id="__codelineno-33-121" name="__codelineno-33-121" href="#__codelineno-33-121"></a><span class="w">                  </span><span class="p">{</span>
</span><span id="__span-33-122"><a id="__codelineno-33-122" name="__codelineno-33-122" href="#__codelineno-33-122"></a><span class="w">                    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
</span><span id="__span-33-123"><a id="__codelineno-33-123" name="__codelineno-33-123" href="#__codelineno-33-123"></a><span class="w">                    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-33-124"><a id="__codelineno-33-124" name="__codelineno-33-124" href="#__codelineno-33-124"></a><span class="w">                    </span><span class="cm">/* malloc checks omitted */</span>
</span><span id="__span-33-125"><a id="__codelineno-33-125" name="__codelineno-33-125" href="#__codelineno-33-125"></a><span class="w">                    </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-126"><a id="__codelineno-33-126" name="__codelineno-33-126" href="#__codelineno-33-126"></a><span class="w">                    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-127"><a id="__codelineno-33-127" name="__codelineno-33-127" href="#__codelineno-33-127"></a><span class="w">                  </span><span class="p">}</span>
</span><span id="__span-33-128"><a id="__codelineno-33-128" name="__codelineno-33-128" href="#__codelineno-33-128"></a><span class="w">                </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-33-129"><a id="__codelineno-33-129" name="__codelineno-33-129" href="#__codelineno-33-129"></a><span class="w">                </span><span class="cm">/* malloc checks omitted */</span>
</span><span id="__span-33-130"><a id="__codelineno-33-130" name="__codelineno-33-130" href="#__codelineno-33-130"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-33-131"><a id="__codelineno-33-131" name="__codelineno-33-131" href="#__codelineno-33-131"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-33-132"><a id="__codelineno-33-132" name="__codelineno-33-132" href="#__codelineno-33-132"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-33-133"><a id="__codelineno-33-133" name="__codelineno-33-133" href="#__codelineno-33-133"></a><span class="w">          </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-134"><a id="__codelineno-33-134" name="__codelineno-33-134" href="#__codelineno-33-134"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-135"><a id="__codelineno-33-135" name="__codelineno-33-135" href="#__codelineno-33-135"></a>
</span><span id="__span-33-136"><a id="__codelineno-33-136" name="__codelineno-33-136" href="#__codelineno-33-136"></a><span class="w">    </span><span class="n">mark_bin</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span>
</span><span id="__span-33-137"><a id="__codelineno-33-137" name="__codelineno-33-137" href="#__codelineno-33-137"></a><span class="w">    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-33-138"><a id="__codelineno-33-138" name="__codelineno-33-138" href="#__codelineno-33-138"></a><span class="w">    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
</span><span id="__span-33-139"><a id="__codelineno-33-139" name="__codelineno-33-139" href="#__codelineno-33-139"></a><span class="w">    </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-140"><a id="__codelineno-33-140" name="__codelineno-33-140" href="#__codelineno-33-140"></a><span class="w">    </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</span><span id="__span-33-141"><a id="__codelineno-33-141" name="__codelineno-33-141" href="#__codelineno-33-141"></a>
</span><span id="__span-33-142"><a id="__codelineno-33-142" name="__codelineno-33-142" href="#__codelineno-33-142"></a><span class="w">    </span><span class="cm">/* If we&#39;ve processed as many chunks as we&#39;re allowed while</span>
</span><span id="__span-33-143"><a id="__codelineno-33-143" name="__codelineno-33-143" href="#__codelineno-33-143"></a><span class="cm">       filling the cache, return one of the cached ones.  */</span>
</span><span id="__span-33-144"><a id="__codelineno-33-144" name="__codelineno-33-144" href="#__codelineno-33-144"></a><span class="w">    </span><span class="o">++</span><span class="n">tcache_unsorted_count</span><span class="p">;</span>
</span><span id="__span-33-145"><a id="__codelineno-33-145" name="__codelineno-33-145" href="#__codelineno-33-145"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">return_cached</span>
</span><span id="__span-33-146"><a id="__codelineno-33-146" name="__codelineno-33-146" href="#__codelineno-33-146"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-33-147"><a id="__codelineno-33-147" name="__codelineno-33-147" href="#__codelineno-33-147"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tcache_unsorted_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span><span class="p">)</span>
</span><span id="__span-33-148"><a id="__codelineno-33-148" name="__codelineno-33-148" href="#__codelineno-33-148"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-33-149"><a id="__codelineno-33-149" name="__codelineno-33-149" href="#__codelineno-33-149"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tcache_get</span><span class="w"> </span><span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
</span><span id="__span-33-150"><a id="__codelineno-33-150" name="__codelineno-33-150" href="#__codelineno-33-150"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-33-151"><a id="__codelineno-33-151" name="__codelineno-33-151" href="#__codelineno-33-151"></a>
</span><span id="__span-33-152"><a id="__codelineno-33-152" name="__codelineno-33-152" href="#__codelineno-33-152"></a><span class="cp">#define MAX_ITERS       10000</span>
</span><span id="__span-33-153"><a id="__codelineno-33-153" name="__codelineno-33-153" href="#__codelineno-33-153"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">iters</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_ITERS</span><span class="p">)</span>
</span><span id="__span-33-154"><a id="__codelineno-33-154" name="__codelineno-33-154" href="#__codelineno-33-154"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-33-155"><a id="__codelineno-33-155" name="__codelineno-33-155" href="#__codelineno-33-155"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>它的流程如下：</p>
<ol>
<li>遍历 unsorted bin 双向链表，从哨兵结点开始，从后往前遍历空闲块</li>
<li>fast path 逻辑：如果要申请的块比当前空闲块小，并且当前空闲块可以拆分，那就拆分当前的空闲块，然后直接分配拆分后的空闲块</li>
<li>如果要申请的块的大小和当前空闲块的大小相同，把空闲块放到 tcache，或者直接分配这个空闲块</li>
<li>把当前空闲块根据大小，分发到 small bin 或者 large bin</li>
<li>如果 tcache 中有合适的空闲块，就分配它</li>
</ol>
<p>由此可见，unsorted bin 中的空闲块在 malloc 的时候会被分派到对应的 small bin 或者 large bin 当中。small bin 的处理比较简单，因为每个 bin 的块大小都相同，直接加入到双向链表即可。large bin 的处理则比较复杂，下面主要来分析 large bin 的结构。</p>
<h3 id="large-bin">large bin</h3>
<p>large bin 和其他 bin 的不同的地方在于，它每个 bin 的大小不是一个固定的值，而是一个范围。在 64 位下，bin 64 到 bin 127 对应的块大小范围：</p>
<ol>
<li>bin 64 到 bin 96: 从 1024 字节开始，每个 bin 覆盖 64 字节的长度范围，例如 bin 64 对应 1024-1087 字节范围，bin 96 对应 3072-3135 字节范围</li>
<li>bin 97 到 bin 111: 从 3136 字节开始，每个 bin 覆盖 512 字节的长度范围，例如 bin 97 对应 3136-3583 字节范围（没有涵盖 512 字节是因为对齐问题，其他的都是涵盖 512 字节），bin 111 对应 10240-10751 字节范围</li>
<li>bin 112 到 bin 119: 从 10752 字节开始，每个 bin 覆盖 4096 字节的长度范围，例如 bin 112 对应 10752-12287 字节范围（没有涵盖 4096 字节是因为对齐问题，其他的都是涵盖 4096 字节），bin 119 对应 36864-40959 字节范围</li>
<li>bin 120 到 bin 123: 从 40960 字节开始，每个 bin 覆盖 32768 字节的长度范围，例如 bin 120 对应 40960-65535 字节范围（没有涵盖 32768 字节是因为对齐问题，其他的都是涵盖 32768 字节），bin 123 对应 131072-163839 字节范围</li>
<li>bin 124: 163840-262143 共 98304 个字节的范围</li>
<li>bin 125: 262144-524287 共 262144 个字节的范围</li>
<li>bin 126: 524288 或更长</li>
</ol>
<p>可以看到，比较短的长度范围给的 bin 也比较多，后面则更加稀疏。上述各个 bin 的大小范围可以通过以下代码打印：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="cp">#define largebin_index_64(sz)                                                  \</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="cp">  (((((unsigned long)(sz)) &gt;&gt; 6) &lt;= 48)                                        \</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="cp">       ? 48 + (((unsigned long)(sz)) &gt;&gt; 6)                                     \</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="cp">       : ((((unsigned long)(sz)) &gt;&gt; 9) &lt;= 20)                                  \</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="cp">             ? 91 + (((unsigned long)(sz)) &gt;&gt; 9)                               \</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="cp">             : ((((unsigned long)(sz)) &gt;&gt; 12) &lt;= 10)                           \</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="cp">                   ? 110 + (((unsigned long)(sz)) &gt;&gt; 12)                       \</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="cp">                   : ((((unsigned long)(sz)) &gt;&gt; 15) &lt;= 4)                      \</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="cp">                         ? 119 + (((unsigned long)(sz)) &gt;&gt; 15)                 \</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="cp">                         : ((((unsigned long)(sz)) &gt;&gt; 18) &lt;= 2)                \</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="cp">                               ? 124 + (((unsigned long)(sz)) &gt;&gt; 18)           \</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="cp">                               : 126)</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">last_bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index_64</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">last_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">largebin_index_64</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last_bin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d-%d: %d, length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">last_i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">last_bin</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_i</span><span class="p">);</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="w">      </span><span class="n">last_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a><span class="w">      </span><span class="n">last_bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index_64</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d-inf: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">last_i</span><span class="p">,</span><span class="w"> </span><span class="n">last_bin</span><span class="p">);</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>因此 large bin 里面会有不同 chunk 大小的空闲块。为了快速地寻找想要的大小的空闲块，large bin 中空闲块按照从大到小的顺序组成链表，同时通过 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 把每种大小出现的第一个块组成双向链表。大致的连接方式如下，参考了 <a href="https://sourceware.org/glibc/wiki/MallocInternals">Malloc Internals</a> 给的示例：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>  bins[id]      chunk A              chunk B              chunk C
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>+----------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>+----------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>| bk = C   |  | fd = B          |  | fd = C          |  | fd = bins[id]   |
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>+----------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>              +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>              | fd_nextsize = C |                       | fd_nextsize = A |
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>              +-----------------+                       +-----------------+
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>              | bk_nextsize = C |                       | bk_nextsize = A |
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>              +-----------------+                       +-----------------+
</span></code></pre></div>
<p>即所有的空闲块加哨兵组成一个双向链表，从大到小按照 <code>A -&gt; B -&gt; C</code> 的顺序连接；然后每种大小的第一个块 <code>A</code> 和 <code>C</code> 单独在一个 nextsize 链表当中。</p>
<p>因此在插入 large bin 的时候，分如下几种情况：</p>
<p>第一种情况，如果新插入的空闲块的大小比目前已有空闲块都小，则直接插入到空闲块和 nextsize 链表的尾部。例如要插入一个 <code>size = 1024</code> 的空闲块 D，插入后状态为：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>  bins[id]      chunk A              chunk B              chunk C              chunk D          
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1040     |  | size = 1024     |
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>| bk = D   |  | fd = B          |  | fd = C          |  | fd = D          |  | fd = bins[id]   |
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = C          |
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>              | fd_nextsize = C |                       | fd_nextsize = D |  | fd_nextsize = A |
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>              +-----------------+                       +-----------------+  +-----------------+
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>              | bk_nextsize = D |                       | bk_nextsize = A |  | bk_nextsize = C |
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>              +-----------------+                       +-----------------+  +-----------------+
</span></code></pre></div>
<p>第二种情况，在遍历 nextsize 链表过程中，发现已经有大小相同的块，那就把新的块插入到它的后面。例如要插入一个 <code>size = 1072</code> 的空闲块 D，通过遍历 nextsize 链表找到了 A，插入之后的状态为：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>  bins[id]      chunk A              chunk D              chunk B              chunk C          
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1072     |  | size = 1040     |
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>| bk = C   |  | fd = D          |  | fd = B          |  | fd = C          |  | fd = bins[id]   |
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>              | bk = bins[id]   |  | bk = A          |  | bk = D          |  | bk = C          |
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>              | fd_nextsize = C |                                            | fd_nextsize = A |
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>              +-----------------+                                            +-----------------+
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>              | bk_nextsize = C |                                            | bk_nextsize = A |
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>              +-----------------+                                            +-----------------+
</span></code></pre></div>
<p>第三种情况，在遍历 nextsize 链表过程中，没有大小相同的块，那就按照从大到小的顺序插入到合适的位置。例如要插入一个 <code>size = 1056</code> 的空闲块 D，通过遍历 nextsize 链表找到了 A 和 C，插入之后的状态为：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>  bins[id]      chunk A              chunk B              chunk D              chunk C          
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>| fd = A   |  | size = 1072     |  | size = 1072     |  | size = 1056     |  | size = 1040     |
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>| bk = D   |  | fd = B          |  | fd = D          |  | fd = C          |  | fd = bins[id]   |
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>+----------+  +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>              | bk = bins[id]   |  | bk = A          |  | bk = B          |  | bk = D          |
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>              +-----------------+  +-----------------+  +-----------------+  +-----------------+
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>              | fd_nextsize = D |                       | fd_nextsize = C |  | fd_nextsize = A |
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>              +-----------------+                       +-----------------+  +-----------------+
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>              | bk_nextsize = C |                       | bk_nextsize = A |  | bk_nextsize = D |
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>              +-----------------+                       +-----------------+  +-----------------+
</span></code></pre></div>
<p>这样就保证了插入以后的 large bin，依然满足从大到小排序，并且每种大小的第一个块组成 nextsize 链表的性质。</p>
<h4 id="malloc_3">malloc</h4>
<p>接着回到 <code>_libc_malloc</code>。前面提到，unsorted bin 中空闲块已经被挪到了 small bin 或者 large bin，并在这个过程中把合适大小的空闲块直接分配。如果还是没有分配成功，接下来就要在 large bin 里寻找一个块来分配：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span><span class="cm">/* skip scan if empty or largest chunk is too small */</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bin</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">)</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">          </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">        </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">                </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">)))</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">          </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="w">        </span><span class="cm">/* Avoid removing the first entry for a size so that the skip</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="cm">           list does not have to be rerouted.  */</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">)</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a><span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">)</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a><span class="w">              </span><span class="o">==</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">))</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a><span class="w">          </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="w">        </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="w">        </span><span class="n">unlink_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="w">        </span><span class="cm">/* Exhaust */</span>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span>
</span><span id="__span-39-27"><a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-39-28"><a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a><span class="w">            </span><span class="n">set_inuse_bit_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-39-29"><a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span>
</span><span id="__span-39-30"><a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a><span class="w">              </span><span class="n">set_non_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-39-31"><a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-39-32"><a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a><span class="w">        </span><span class="cm">/* Split */</span>
</span><span id="__span-39-33"><a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a><span class="w">            </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a><span class="w">            </span><span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a><span class="cm">               have to perform a complete insert here.  */</span>
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a><span class="w">            </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a><span class="w">            </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">))</span>
</span><span id="__span-39-41"><a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a><span class="w">              </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class="p">);</span>
</span><span id="__span-39-42"><a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-39-43"><a id="__codelineno-39-43" name="__codelineno-39-43" href="#__codelineno-39-43"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
</span><span id="__span-39-44"><a id="__codelineno-39-44" name="__codelineno-39-44" href="#__codelineno-39-44"></a><span class="w">            </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-39-45"><a id="__codelineno-39-45" name="__codelineno-39-45" href="#__codelineno-39-45"></a><span class="w">            </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-39-46"><a id="__codelineno-39-46" name="__codelineno-39-46" href="#__codelineno-39-46"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span>
</span><span id="__span-39-47"><a id="__codelineno-39-47" name="__codelineno-39-47" href="#__codelineno-39-47"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-39-48"><a id="__codelineno-39-48" name="__codelineno-39-48" href="#__codelineno-39-48"></a><span class="w">                </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-39-49"><a id="__codelineno-39-49" name="__codelineno-39-49" href="#__codelineno-39-49"></a><span class="w">                </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-39-50"><a id="__codelineno-39-50" name="__codelineno-39-50" href="#__codelineno-39-50"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-39-51"><a id="__codelineno-39-51" name="__codelineno-39-51" href="#__codelineno-39-51"></a><span class="w">            </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-39-52"><a id="__codelineno-39-52" name="__codelineno-39-52" href="#__codelineno-39-52"></a><span class="w">                      </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-39-53"><a id="__codelineno-39-53" name="__codelineno-39-53" href="#__codelineno-39-53"></a><span class="w">            </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-39-54"><a id="__codelineno-39-54" name="__codelineno-39-54" href="#__codelineno-39-54"></a><span class="w">            </span><span class="n">set_foot</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
</span><span id="__span-39-55"><a id="__codelineno-39-55" name="__codelineno-39-55" href="#__codelineno-39-55"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-39-56"><a id="__codelineno-39-56" name="__codelineno-39-56" href="#__codelineno-39-56"></a><span class="w">        </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-39-57"><a id="__codelineno-39-57" name="__codelineno-39-57" href="#__codelineno-39-57"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-39-58"><a id="__codelineno-39-58" name="__codelineno-39-58" href="#__codelineno-39-58"></a><span class="w">        </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-39-59"><a id="__codelineno-39-59" name="__codelineno-39-59" href="#__codelineno-39-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-39-60"><a id="__codelineno-39-60" name="__codelineno-39-60" href="#__codelineno-39-60"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-39-61"><a id="__codelineno-39-61" name="__codelineno-39-61" href="#__codelineno-39-61"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>从 large bin 分配空闲块的过程如下：</p>
<ol>
<li>根据大小找到对应的 large bin</li>
<li>如果 large bin 中最大的空闲块足够大，遍历 nextsize 链表，找到一个比要分配的大小更大的最小的空闲块</li>
<li>为了避免更新 nextsize 链表，如果当前块大小对应了不止一个空闲块，那就取第二个空闲块，这样就不用更新 nextsize 链表</li>
<li>计算空闲块大小和要分配的大小的差值，如果差值太小，多余的部分就直接浪费；如果差的空间还能放下一个 chunk，就进行拆分，把拆出来的剩下的部分放到 unsorted bin 中</li>
<li>计算 payload 地址，进行可选的 perturb，完成分配</li>
</ol>
<h3 id="bin">寻找更大的 bin</h3>
<p>如果在当前 bin 内还是找不到空闲块，那就只能从更大的 bin 里寻找空闲块了：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="o">++</span><span class="n">idx</span><span class="p">;</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx2block</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span><span class="n">block</span><span class="p">];</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx2bit</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="k">for</span><span class="w"> </span><span class="p">(;;</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="cm">/* Skip rest of block if there are no more set bits in this block.  */</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">        </span><span class="k">do</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">block</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BINMAPSIZE</span><span class="p">)</span><span class="w"> </span><span class="cm">/* out of bins */</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="w">              </span><span class="k">goto</span><span class="w"> </span><span class="n">use_top</span><span class="p">;</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span><span class="n">block</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="w">        </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">BINMAPSHIFT</span><span class="p">));</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a><span class="w">        </span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a><span class="w">    </span><span class="cm">/* Advance to bin with set bit. There must be one. */</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bit</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="w">        </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_bin</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="w">        </span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a><span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a>
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a><span class="w">    </span><span class="cm">/* Inspect the bin. It is likely to be non-empty */</span>
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="w">    </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a>
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a><span class="w">    </span><span class="cm">/*  If a false alarm (empty bin), clear the bit. */</span>
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bin</span><span class="p">)</span>
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a><span class="w">        </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">bit</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Write through */</span>
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a><span class="w">        </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_bin</span><span class="w"> </span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a><span class="w">        </span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-40-41"><a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a>
</span><span id="__span-40-42"><a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-40-43"><a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-40-44"><a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a><span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-40-45"><a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a>
</span><span id="__span-40-46"><a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a><span class="w">        </span><span class="cm">/*  We know the first chunk in this bin is big enough to use. */</span>
</span><span id="__span-40-47"><a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a><span class="w">        </span><span class="n">assert</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">));</span>
</span><span id="__span-40-48"><a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a>
</span><span id="__span-40-49"><a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a><span class="w">        </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
</span><span id="__span-40-50"><a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a>
</span><span id="__span-40-51"><a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a><span class="w">        </span><span class="cm">/* unlink */</span>
</span><span id="__span-40-52"><a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a><span class="w">        </span><span class="n">unlink_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-40-53"><a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a>
</span><span id="__span-40-54"><a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a><span class="w">        </span><span class="cm">/* Exhaust */</span>
</span><span id="__span-40-55"><a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span>
</span><span id="__span-40-56"><a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-40-57"><a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a><span class="w">            </span><span class="n">set_inuse_bit_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-40-58"><a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span>
</span><span id="__span-40-59"><a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a><span class="w">              </span><span class="n">set_non_main_arena</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-40-60"><a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-40-61"><a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a>
</span><span id="__span-40-62"><a id="__codelineno-40-62" name="__codelineno-40-62" href="#__codelineno-40-62"></a><span class="w">        </span><span class="cm">/* Split */</span>
</span><span id="__span-40-63"><a id="__codelineno-40-63" name="__codelineno-40-63" href="#__codelineno-40-63"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-40-64"><a id="__codelineno-40-64" name="__codelineno-40-64" href="#__codelineno-40-64"></a><span class="w">          </span><span class="p">{</span>
</span><span id="__span-40-65"><a id="__codelineno-40-65" name="__codelineno-40-65" href="#__codelineno-40-65"></a><span class="w">            </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-40-66"><a id="__codelineno-40-66" name="__codelineno-40-66" href="#__codelineno-40-66"></a>
</span><span id="__span-40-67"><a id="__codelineno-40-67" name="__codelineno-40-67" href="#__codelineno-40-67"></a><span class="w">            </span><span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
</span><span id="__span-40-68"><a id="__codelineno-40-68" name="__codelineno-40-68" href="#__codelineno-40-68"></a><span class="cm">               have to perform a complete insert here.  */</span>
</span><span id="__span-40-69"><a id="__codelineno-40-69" name="__codelineno-40-69" href="#__codelineno-40-69"></a><span class="w">            </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-40-70"><a id="__codelineno-40-70" name="__codelineno-40-70" href="#__codelineno-40-70"></a><span class="w">            </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-40-71"><a id="__codelineno-40-71" name="__codelineno-40-71" href="#__codelineno-40-71"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">))</span>
</span><span id="__span-40-72"><a id="__codelineno-40-72" name="__codelineno-40-72" href="#__codelineno-40-72"></a><span class="w">              </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): corrupted unsorted chunks 2&quot;</span><span class="p">);</span>
</span><span id="__span-40-73"><a id="__codelineno-40-73" name="__codelineno-40-73" href="#__codelineno-40-73"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
</span><span id="__span-40-74"><a id="__codelineno-40-74" name="__codelineno-40-74" href="#__codelineno-40-74"></a><span class="w">            </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
</span><span id="__span-40-75"><a id="__codelineno-40-75" name="__codelineno-40-75" href="#__codelineno-40-75"></a><span class="w">            </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-40-76"><a id="__codelineno-40-76" name="__codelineno-40-76" href="#__codelineno-40-76"></a><span class="w">            </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-40-77"><a id="__codelineno-40-77" name="__codelineno-40-77" href="#__codelineno-40-77"></a>
</span><span id="__span-40-78"><a id="__codelineno-40-78" name="__codelineno-40-78" href="#__codelineno-40-78"></a><span class="w">            </span><span class="cm">/* advertise as last remainder */</span>
</span><span id="__span-40-79"><a id="__codelineno-40-79" name="__codelineno-40-79" href="#__codelineno-40-79"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-40-80"><a id="__codelineno-40-80" name="__codelineno-40-80" href="#__codelineno-40-80"></a><span class="w">              </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-40-81"><a id="__codelineno-40-81" name="__codelineno-40-81" href="#__codelineno-40-81"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span>
</span><span id="__span-40-82"><a id="__codelineno-40-82" name="__codelineno-40-82" href="#__codelineno-40-82"></a><span class="w">              </span><span class="p">{</span>
</span><span id="__span-40-83"><a id="__codelineno-40-83" name="__codelineno-40-83" href="#__codelineno-40-83"></a><span class="w">                </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-40-84"><a id="__codelineno-40-84" name="__codelineno-40-84" href="#__codelineno-40-84"></a><span class="w">                </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-40-85"><a id="__codelineno-40-85" name="__codelineno-40-85" href="#__codelineno-40-85"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-40-86"><a id="__codelineno-40-86" name="__codelineno-40-86" href="#__codelineno-40-86"></a><span class="w">            </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-40-87"><a id="__codelineno-40-87" name="__codelineno-40-87" href="#__codelineno-40-87"></a><span class="w">                      </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-40-88"><a id="__codelineno-40-88" name="__codelineno-40-88" href="#__codelineno-40-88"></a><span class="w">            </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-40-89"><a id="__codelineno-40-89" name="__codelineno-40-89" href="#__codelineno-40-89"></a><span class="w">            </span><span class="n">set_foot</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
</span><span id="__span-40-90"><a id="__codelineno-40-90" name="__codelineno-40-90" href="#__codelineno-40-90"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-40-91"><a id="__codelineno-40-91" name="__codelineno-40-91" href="#__codelineno-40-91"></a><span class="w">        </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-40-92"><a id="__codelineno-40-92" name="__codelineno-40-92" href="#__codelineno-40-92"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-40-93"><a id="__codelineno-40-93" name="__codelineno-40-93" href="#__codelineno-40-93"></a><span class="w">        </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-40-94"><a id="__codelineno-40-94" name="__codelineno-40-94" href="#__codelineno-40-94"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-40-95"><a id="__codelineno-40-95" name="__codelineno-40-95" href="#__codelineno-40-95"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-40-96"><a id="__codelineno-40-96" name="__codelineno-40-96" href="#__codelineno-40-96"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>为了跳过空的 bin，维护了一个 bitmap，记录哪些 bin 会有内容。找到一个非空的 bin 以后，它的大小肯定是足够分配的，接下来就和之前一样，要么舍弃多余的空间，要么把多余的空间做成一个 chunk，插入到 unsorted bin 当中。</p>
<p>如果所有 bin 都空了，说明没有可以分配的可能了，就跳转到 <code>use_top</code> 逻辑。</p>
<h3 id="top-chunk">top chunk 分配</h3>
<p>如果已有的 bin 都无法分配了，就尝试拆分 top chunk 来进行分配。top chunk 指的是当前堆里地址最高的那个 chunk，也可以理解为未分配的部分。分配的逻辑如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="nl">use_top</span><span class="p">:</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">))</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">  </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): corrupted top size&quot;</span><span class="p">);</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">))</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">    </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">    </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">    </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">              </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">    </span><span class="n">set_head</span><span class="w"> </span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">    </span><span class="n">check_malloced_chunk</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">    </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="cm">/* When we are using atomic ops to free fast chunks we can get</span>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="cm">   here for all block sizes.  */</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">atomic_load_relaxed</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">have_fastchunks</span><span class="p">))</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="w">    </span><span class="n">malloc_consolidate</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="w">    </span><span class="cm">/* restore original bin index */</span>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="w">      </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="w">      </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="cm">/*</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="cm">   Otherwise, relay to handle system-dependent cases</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="cm"> */</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a><span class="k">else</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysmalloc</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="n">av</span><span class="p">);</span>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a><span class="w">      </span><span class="n">alloc_perturb</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div>
<p>如果 top chunk 的空间够大，那就对 top chunk 进行拆分，低地址的部分分配出去，剩下的部分成为新的 top chunk。如果 top chunk 不够大，并且 fast bin 还有空间，那就再挣扎一下，consolidate 一下，重新分配一次。如果这些方法都失败了，那就调用 sysmalloc，通过 mmap 或者 sbrk 等方式来分配新的空间。</p>
<p>前面在讨论 consolidate 的时候，跳过了对 top chunk 的特殊处理。其实，top chunk 的特殊处理也很简单，如果当前空闲块的下一个块就是 top chunk，那就把当前空闲块合并到 top chunk 即可。</p>
<h3 id="free_3">free</h3>
<p>前面把 malloc 的流程基本分析完了，接下来分析一下 free 的逻辑，它做的事情包括：</p>
<ol>
<li>前面已经分析过，如果 tcache 对应的 bin 存在且非满，则把空闲块插入到 tcache 的链表头</li>
<li>如果存在对应的 fast bin，则插入空闲块到 fast bin 对应链表的头部</li>
<li>尝试和它前后的空闲块进行合并，实现和前面 consolidate 类似，合并后进入 unsorted bin</li>
<li>如果释放的内存比较多，检查 top chunk 大小，如果剩余的空间比较多，则归还一部分内存给操作系统</li>
<li>对于 mmap 分配的内存，用 munmap 释放掉</li>
</ol>
<p>由于 free 的实现相对简单，在这里就不详细解析了，比较详细的实现分析见后。</p>
<h3 id="realloc">realloc</h3>
<p>realloc 的实现在 <code>__libc_realloc</code> 当中，它的实现比较简单：</p>
<ol>
<li>如果重新分配的大小是 0，realloc 等价为 free，就调用 free</li>
<li>如果旧指针是 NULL，realloc 等价为 malloc，就调用 malloc</li>
<li>如果直接是 mmap 出来的块，利用 mremap 来扩展空间</li>
<li>如果是要申请更少的内存，把多出来的部分拆成一个单独的块，然后 free 掉它</li>
<li>如果是要申请更多的内存，尝试从内存更高地址的相邻块获取空间，如果有的话，合并两个块，然后把多余的空间拆成一个单独的块，然后 free 掉它；如果内存更高地址的相邻块已经被占用，就重新 malloc 一个块，用 memcpy 把数据拷贝过去，再 free 掉旧的内存</li>
</ol>
<h3 id="calloc">calloc</h3>
<p>calloc 的实现在 <code>__libc_calloc</code> 当中，它的语义相比 malloc 多了一个清零，所以它的实现也不复杂：</p>
<ol>
<li>如果 top chunk 还有空间，并且 top chunk 的数据已经被清零，则优先从 top chunk 分配空间，避免了 memset 的开销</li>
<li>fallback 到 <code>_int_malloc</code> 进行内存分配，分配成功后，再 memset 清零</li>
</ol>
<h3 id="arena-heap">arena 和 heap</h3>
<p>前面讨论了各种 chunk 在内存分配器内部流转的情况，但并没有讨论这些空间是怎么从操作系统分配而来的，又是怎么维护的。glibc 内存分配器实际上设计了两个层次：</p>
<ol>
<li>arena 层次：对应锁的粒度，一个 arena 可以对应多个 heap，有一个特殊的 arena 是 main_arena；arena 的数量有限制，在 64 位系统下默认的数量限制是处理器核心数的 8 倍，避免出现太多的内存碎片</li>
<li>heap 层次：每个 heap 大小有上限：<code>1024 * 1024</code> 字节，也就是 1MB；当 arena 需要更多空间的时候，可以分配新的 heap；arena 自身就保存在 arena 的第一个 heap 内部的空间，同一个 arena 的多个 heap 之间通单向链表连接起来；arena 的 top chunk 指向最后一个创建的 heap 的顶部的空闲块</li>
</ol>
<p>arena 的结构就是前面看到的 <code>malloc_state</code>，包括如下字段：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="p">{</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">  </span><span class="cm">/* Serialize access.  */</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">  </span><span class="n">__libc_lock_define</span><span class="w"> </span><span class="p">(,</span><span class="w"> </span><span class="n">mutex</span><span class="p">);</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">  </span><span class="cm">/* Flags (formerly in max_fast).  */</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">  </span><span class="cm">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">  </span><span class="cm">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">have_fastchunks</span><span class="p">;</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">  </span><span class="cm">/* Fastbins */</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">  </span><span class="n">mfastbinptr</span><span class="w"> </span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">NFASTBINS</span><span class="p">];</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">  </span><span class="cm">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">top</span><span class="p">;</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">  </span><span class="cm">/* The remainder from the most recent split of a small request */</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">last_remainder</span><span class="p">;</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">  </span><span class="cm">/* Normal bins packed as described above */</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a><span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">bins</span><span class="p">[</span><span class="n">NBINS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a><span class="w">  </span><span class="cm">/* Bitmap of bins */</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">binmap</span><span class="p">[</span><span class="n">BINMAPSIZE</span><span class="p">];</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">  </span><span class="cm">/* Linked list */</span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a>
</span><span id="__span-42-31"><a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a><span class="w">  </span><span class="cm">/* Linked list for free arenas.  Access to this field is serialized</span>
</span><span id="__span-42-32"><a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="cm">     by free_list_lock in arena.c.  */</span>
</span><span id="__span-42-33"><a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="o">*</span><span class="n">next_free</span><span class="p">;</span>
</span><span id="__span-42-34"><a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a>
</span><span id="__span-42-35"><a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">  </span><span class="cm">/* Number of threads attached to this arena.  0 if the arena is on</span>
</span><span id="__span-42-36"><a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a><span class="cm">     the free list.  Access to this field is serialized by</span>
</span><span id="__span-42-37"><a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a><span class="cm">     free_list_lock in arena.c.  */</span>
</span><span id="__span-42-38"><a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">attached_threads</span><span class="p">;</span>
</span><span id="__span-42-39"><a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a>
</span><span id="__span-42-40"><a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="w">  </span><span class="cm">/* Memory allocated from the system in this arena.  */</span>
</span><span id="__span-42-41"><a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">system_mem</span><span class="p">;</span>
</span><span id="__span-42-42"><a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a><span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">max_system_mem</span><span class="p">;</span>
</span><span id="__span-42-43"><a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a><span class="p">};</span>
</span></code></pre></div>
<p>这里很多字段在之前已经见过了，比如：</p>
<ol>
<li><code>mutex</code>：arena 的互斥锁</li>
<li><code>have_fastchunks</code>：记录 fast bin 中是否还有空闲块，用于判断是否需要 consolidate</li>
<li><code>fastbinsY</code>：保存 fast bin 每个 bin 的头指针的数组</li>
<li><code>top</code>：指向 top chunk</li>
<li><code>last_remainder</code>：指向最近一次 split 出来的空闲块，用于访存局部性优化</li>
<li><code>bins</code>：保存 unsorted bin，small bin 和 large bin 各个双向链表的哨兵结点的 <code>fd</code> 和 <code>bk</code> 指针</li>
<li><code>binmap</code>：记录哪些 small 或 large bin 里面有空闲块，用于加速寻找下一个有空闲块的 bin</li>
</ol>
<p>之前没有涉及到的字段包括：</p>
<ol>
<li><code>flags</code>: 维护 <code>NONCONTIGUOUS_BIT</code> 标记，即 arena 所使用的内存是否是连续的，例如用 sbrk 分配出来的内存是连续的，用 mmap 则不是</li>
<li><code>next</code>: 维护所有 arena 的单向链表，链表头就是 <code>main_arena</code></li>
<li><code>next_free</code>: 维护所有空闲的 arena 的单向链表 free list，链表头保存在 <code>static mstate free_list</code></li>
<li><code>attached_threads</code>: 记录有多少个线程会使用这个 arena，类似于一种引用计数，当它减到零的时候，意味着 arena 可以被释放到 free list 了</li>
<li><code>system_mem</code>: 记录它从操作系统分配了多少的内存的大小</li>
<li><code>max_system_mem</code>：记录它历史上从操作系统分配最多的内存的大小</li>
</ol>
<p>可见 arena 的结构还是比较简单的，接下来分析 heap 的结构：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_heap_info</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="p">{</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">  </span><span class="n">mstate</span><span class="w"> </span><span class="n">ar_ptr</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Arena for this heap. */</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">_heap_info</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Previous heap. */</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Current size in bytes. */</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mprotect_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Size in bytes that has been mprotected</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="cm">                           PROT_READ|PROT_WRITE.  */</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">  </span><span class="cm">/* Make sure the following data is properly aligned, particularly</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="cm">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="cm">     MALLOC_ALIGNMENT. */</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">pad</span><span class="p">[</span><span class="mi">-6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">];</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="p">}</span><span class="w"> </span><span class="n">heap_info</span><span class="p">;</span>
</span></code></pre></div>
<p>字段如下：</p>
<ol>
<li><code>ar_ptr</code>：指向 heap 所属的 arena</li>
<li><code>prev</code>：指向前一个 heap，组成一个 heap 的单向链表，新添加的 heap 放到链表的尾部</li>
<li><code>size</code>: heap 的大小</li>
<li><code>mprotect_size</code>: heap 被设置为可读写的部分的内存大小，也就是 heap 的活跃部分大小，对齐到页的边界；默认情况下，heap 的未分配空间被映射为不可读不可写不可执行的属性</li>
<li><code>pad</code>: 添加 padding，保证它的大小是 <code>MALLOC_ALIGNMENT</code> 的倍数</li>
</ol>
<p>前面提到过，arena 的空间会复用它的第一个 heap 的空间，紧接着放在 <code>heap_info</code> 结构体的后面。这个 <code>heap_info</code> 结构体就放在 heap 所用空间的开头。</p>
<p>heap 有一个特性，就是它的起始地址，一定是对齐到 <code>HEAP_MAX_SIZE</code>（默认是 64MB）的整数倍数，并且它的大小也不会超过 <code>HEAP_MAX_SIZE</code>，所以如果要知道某个 chunk 属于哪个 heap，只需要向下取整到 <code>HEAP_MAX_SIZE</code> 的倍数即可。如果要知道某个 chunk 属于哪个 arena，就先找到 heap，再从 heap_info 获取 ar_ptr 就可以了。</p>
<p>比较有意思的一个点是，heap 保存了 arena 的指针，但是反过来，arena 并没有保存 heap 的指针，那么怎么从 arena 找到属于这个 arena 的所有 heap 呢？这会用到一个性质：arena 的 top 永远指向最新的一个 heap 的地址最高的空闲块，而这个最新的 heap 正好处于 heap 链表的尾部，所以如果要遍历 arena 里的 heap，只需要：</p>
<ol>
<li>获取 arena 的 top 指针</li>
<li>把 top 指针向下取整到 <code>HEAP_MAX_SIZE</code> 的整倍数，得到 top 所在 heap 的 heap_info 指针</li>
<li>沿着 heap_info 的 prev 指针向前走，一直遍历，直到 prev 指针为 NULL 为止</li>
</ol>
<p>所以 top 指针也充当了 heap 链表的尾指针的作用。</p>
<p>接下来观察 arena 和 heap 是怎么初始化的。</p>
<p>main arena 是特殊的，因为它直接保存在 glibc 的 data 段当中，所以不需要动态分配，并且 main arena 的数据是通过 sbrk 从系统分配的，它的维护逻辑在 <code>sysmalloc</code> 函数中实现：当 malloc 尝试各种办法都找不到空间分配时，就会调用 <code>sysmalloc</code> 来扩展 top chunk 并从 top chunk 中分配新的块。当 <code>sysmalloc</code> 遇到 main arena 的时候，就会尝试用 sbrk 扩展堆的大小，从而扩大 top chunk。当然了，sbrk 可能会失败，这个时候 main arena 也会通过 mmap 来分配更多的内存。</p>
<p>其他的 arena 则是通过 <code>_int_new_arena</code> 分配的，它的流程是：</p>
<ol>
<li>调用 <code>new_heap</code> 创建一个堆，至少能够放 <code>heap_info</code> 和 <code>malloc_state</code> 的空间</li>
<li>这段空间的开头就是 <code>heap_info</code>，紧随其后就是 arena 自己的 <code>malloc_state</code>，然后把 top chunk 指向 <code>malloc_state</code> 后面的空闲空间</li>
</ol>
<p><code>new_heap</code> 则是会通过 <code>mmap</code> 向操作系统申请内存。因此除了 main_arena 以外，所有的 arena 的 heap 都会放在 mmap 出来的空间里。</p>
<p>于是 <code>sysmalloc</code> 要做的事情也比较清晰了，它要做的就是，在 top chunk 不够大的时候，分配更多空间给 top chunk：</p>
<ol>
<li>如果要分配的块特别大，超出了阈值 <code>mmap_threshold</code>，就直接用 mmap 申请内存</li>
<li>如果不是 main arena，就尝试扩大 top 所在的 heap：heap 在初始化的时候，虽然会 mmap 一个 <code>HEAP_MAX_SIZE</code> 大小的内存，但大部分空间都被映射为不可读不可写不可执行；所以扩大 heap，实际上就是把要用的部分通过 mprotect 添加可读和可写的权限；如果 heap 达到了大小的上限，那就新建一个 heap，把 top chunk 放到新的 heap 上去</li>
<li>如果是 main arena，就用 sbrk 扩大 top chunk；如果扩大失败，那就用 mmap 来分配内存</li>
</ol>
<h3 id="_4">小结</h3>
<h4 id="_5">结构</h4>
<p>到这里就基本把 glibc 的内存分配器分析得差不多了。glibc 把空闲块放在如下四种 bin 内：</p>
<ol>
<li>fast bin: 每个 bin 对应固定大小的空闲块，用单向链表维护，链表头指针保存在 <code>malloc_state</code> 的 <code>fastbinsY</code> 成员</li>
<li>unsorted bin: 一个双向链表，维护一些刚被 free 的空闲块，无大小要求，链表的哨兵结点保存在 <code>malloc_state</code> 的 <code>bins</code> 成员刚开头</li>
<li>small bin: 每个 bin 对应固定大小的空闲块，用双向链表维护，链表的哨兵结点保存在 <code>malloc_state</code> 的 <code>bins</code> 成员，紧接在 unsorted bin 后面</li>
<li>large bin: 每个 bin 对应一段大小范围的空闲块，用双向链表维护，按照块大小从大到小排序，每个大小的第一个空闲块在 nextsize 双向链表当中，链表的哨兵结点保存在 <code>malloc_state</code> 的 <code>bins</code> 成员中，紧接在 small bin 后面</li>
</ol>
<p>除了这四种 bin 以外，还有一个 per thread 的 tcache 机制，结构和 fast bin 类似，每个 bin 对应固定大小的空闲块，用单向链表维护，链表头指针保存在 <code>tcache</code> 的 <code>entries</code> 成员。</p>
<p>内存在分配器中流转的过程大致如下：</p>
<ol>
<li>一开始从 top chunk 当中被分配出来</li>
<li>被 free 了以后，进入 tcache，或者 fast bin，或者合并后放到 unsorted bin，或者合并到 top chunk</li>
<li>在 malloc 的时候，从 tcache 或者 fast bin 分配，又或者从 unsorted bin 中取出，放到 small bin 或 large bin，中途可能被分配、拆分或者合并</li>
</ol>
<pre class="mermaid"><code>flowchart TD
    top_chunk[top chunk]
    user[user allocated]
    tcache
    fast_bin[fast bin]
    small_bin[small bin]
    large_bin[large bin]
    unsorted_bin[unsorted bin]

    top_chunk --&gt;|malloc| user
    tcache --&gt;|malloc| user
    fast_bin --&gt;|malloc| user
    fast_bin --&gt;|malloc| tcache
    fast_bin --&gt;|consolidate| unsorted_bin
    fast_bin --&gt;|consolidate| top_chunk
    small_bin --&gt;|malloc| user
    small_bin --&gt;|malloc| tcache
    large_bin --&gt;|malloc| user
    large_bin --&gt;|malloc| unsorted_bin
    unsorted_bin --&gt;|malloc| user
    unsorted_bin --&gt;|malloc| tcache
    unsorted_bin --&gt;|malloc| small_bin
    unsorted_bin --&gt;|malloc| large_bin

    user --&gt;|free| tcache
    user --&gt;|free| fast_bin
    user --&gt;|free| unsorted_bin
    user --&gt;|free| top_chunk
    small_bin --&gt;|free| unsorted_bin
    large_bin --&gt;|free| unsorted_bin</code></pre>
<h4 id="malloc_4">malloc</h4>
<p>malloc 的完整流程图如下：</p>
<pre class="mermaid"><code>---
config:
  theme: base
  themeVariables:
    fontSize: "30px"
---
flowchart TD
    malloc[malloc 入口（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3022"&gt;malloc.c:3022&lt;/a&gt;）]
    tcache[尝试从 tcache 中分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3047"&gt;malloc.c:3047&lt;/a&gt;）]
    fastbin[尝试从 fast bin 中分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3577"&gt;malloc.c:3577&lt;/a&gt;）]
    fastbin_migrate[如果 fast bin 还有空闲块且 tcache 没有满，则把空闲块从 fast bin 挪到 tcache（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3596"&gt;malloc.c:3596&lt;/a&gt;）]
    smallbin[尝试从 small bin 中分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3635"&gt;malloc.c:3635&lt;/a&gt;）]
    smallbin_migrate[如果 small bin 还有空闲块且 tcache 没有满，则把空闲块从 small bin 挪到 tcache（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3652"&gt;malloc.c:3652&lt;/a&gt;）]
    malloc_ret[malloc 结束]
    consolidate[consolidate：遍历 fast bin，把空闲块和相邻的空闲块合并，插入到 unsorted bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440"&gt;malloc.c:4440&lt;/a&gt;）]
    consolidate_2[consolidate：遍历 fast bin，把空闲块和相邻的空闲块合并，插入到 unsorted bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4440"&gt;malloc.c:4440&lt;/a&gt;）]
    check_large[块大小是否对应 large bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3695"&gt;malloc.c:3695&lt;/a&gt;）]
    loop[开始循环（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3725"&gt;malloc.c:3725&lt;/a&gt;）]
    unsorted_bin[遍历 unsorted bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3728"&gt;malloc.c:3728&lt;/a&gt;）]
    remainder[内存局部性优化：最近一次 split 出来的 chunk 是否有足够的空间分配（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3756"&gt;malloc.c:3756&lt;/a&gt;）]
    remainder_success[拆分这个 chunk 以完成分配（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3761"&gt;malloc.c:3761&lt;/a&gt;）]
    remove_unsorted_bin[把当前 chunk 从 unsorted bin 中删除（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3784"&gt;malloc.c:3784&lt;/a&gt;）]
    check_same_size[当前空闲块大小和要分配的大小是否相同（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3792"&gt;malloc.c:3792&lt;/a&gt;）]
    check_tcache_full[tcache bin 是否已满（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3800"&gt;malloc.c:3800&lt;/a&gt;）]
    alloc_now[分配当前空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3807"&gt;malloc.c:3807&lt;/a&gt;）]
    move_to_tcache[把当前空闲块挪到 tcache（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3803"&gt;malloc.c:3803&lt;/a&gt;）]
    move_to_bin[根据当前空闲块的大小，挪到 small bin 或 large bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3821"&gt;malloc.c:3821&lt;/a&gt;）]
    check_tcache[检查 tcache 是否有空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3891"&gt;malloc.c:3891&lt;/a&gt;）]
    alloc_tcache[从 tcache 分配空闲块]
    unsorted_bin_exit[检查 tcache 是否有空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3906"&gt;malloc.c:3906&lt;/a&gt;）]
    check_large_alloc[块大小是否对应 large bin（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3917"&gt;malloc.c:3917&lt;/a&gt;）]
    alloc_large[尝试从 large bin 中分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3922"&gt;malloc.c:3922&lt;/a&gt;）]
    alloc_larger[遍历更大的 bin，尝试分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L3990"&gt;malloc.c:3990&lt;/a&gt;）]
    alloc_top[尝试从 top chunk 分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4087"&gt;malloc.c:4087&lt;/a&gt;）]
    alloc_system[从系统请求更多内存来分配空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4139"&gt;malloc.c:4139&lt;/a&gt;）]
    check_fast[fast bin 是否有空闲块（&lt;a href="https://github.com/bminor/glibc/blob/glibc-2.31/malloc/malloc.c#L4126"&gt;malloc.c:4126&lt;/a&gt;）]

    malloc --&gt; tcache
    tcache --&gt;|分配成功| malloc_ret
    tcache --&gt;|分配失败| fastbin
    fastbin --&gt;|分配失败| smallbin
    fastbin --&gt;|分配成功| fastbin_migrate 
    fastbin_migrate --&gt; malloc_ret
    smallbin --&gt;|分配成功| smallbin_migrate
    smallbin_migrate --&gt; malloc_ret
    smallbin --&gt;|分配失败| check_large
    check_large --&gt;|是| consolidate
    check_large --&gt;|否| loop
    consolidate --&gt; loop
    loop --&gt; unsorted_bin
    unsorted_bin --&gt;|unsorted bin 非空，或者循环次数不足 10000 次| remainder
    remainder --&gt;|是| remainder_success
    remainder_success --&gt; malloc_ret
    remainder --&gt;|否| remove_unsorted_bin
    remove_unsorted_bin --&gt; check_same_size
    check_same_size --&gt;|是| check_tcache_full
    check_tcache_full --&gt;|否| move_to_tcache
    check_tcache_full --&gt; |是| alloc_now
    alloc_now --&gt; malloc_ret
    move_to_tcache --&gt; unsorted_bin
    check_same_size --&gt;|否| move_to_bin
    move_to_bin --&gt; check_tcache
    check_tcache --&gt;|是| alloc_tcache
    alloc_tcache --&gt; malloc_ret
    check_tcache --&gt;|否| unsorted_bin
    unsorted_bin --&gt;|unsorted bin 已空，或者循环次数超过 10000 次| unsorted_bin_exit
    unsorted_bin_exit --&gt;|是| alloc_tcache
    unsorted_bin_exit --&gt;|否| check_large_alloc
    check_large_alloc --&gt;|是| alloc_large
    alloc_large --&gt;|分配成功| malloc_ret
    alloc_large --&gt;|分配失败| alloc_larger
    check_large_alloc --&gt;|否| alloc_larger
    alloc_larger --&gt;|分配成功| malloc_ret
    alloc_larger --&gt;|分配失败| alloc_top
    alloc_top --&gt;|分配成功| malloc_ret
    alloc_top --&gt;|分配失败| check_fast
    check_fast --&gt;|是| consolidate_2
    consolidate_2 --&gt; loop
    check_fast --&gt;|否| alloc_system
    alloc_system --&gt; malloc_ret</code></pre>
<p>前面分段整理了 malloc 的实现，在这里列出完整的 malloc 流程：</p>
<ol>
<li>malloc 的入口是 <code>__libc_malloc (size_t bytes)</code> 函数</li>
<li>如果配置了 malloc hook，则调用 malloc hook，直接返回结果</li>
<li>根据用户传入的 malloc 的字节数（<code>bytes</code>），用 <code>checked_request2size</code> 计算出实际的 chunk 大小，算法是先加上 <code>sizeof(size_t)</code>（给 <code>mchunk_size</code> 预留空间），然后向上对齐到 <code>MALLOC_ALIGNMENT</code>（通常是 <code>2 * sizeof(size_t)</code>）的倍数，再和 <code>MINSIZE</code> 取 max，其中 <code>MINSIZE</code> 通常是 <code>4 * sizeof(size_t)</code>，因为空闲块至少要保存两个 size 加上双向链表的 <code>fd</code> 和 <code>bk</code> 指针</li>
<li>如果 tcache 还没初始化，就初始化 tcache</li>
<li>根据 chunk 大小，计算 tcache index，检查对应的 bin 是否有空闲块；如果有，直接分配空闲块并返回</li>
<li>接着获取一个 arena，如有必要，获取 arena 的锁；在单线程情况下，只有一个 main_arena；多线程情况下，每个线程有一个默认的 arena 指针（<code>static __thread mstate thread_arena</code>），在遇到 lock contention 的时候可以动态切换</li>
<li>进入 <code>_int_malloc</code> 从 arena 中分配一个 chunk，分配完成后释放 arena 的锁</li>
<li>接着分析 <code>_int_malloc</code> 的实现，除 tcache 以外的大部分逻辑都在 <code>_int_malloc</code> 函数中</li>
<li>判断 chunk size 大小，如果对应 fast bin 的块大小，在对应的 fast bin 的单向链表中寻找空闲块；如果链表非空，则取出链表头的空闲块，作为分配给 malloc 调用者的块，接着把 fast bin 链表上剩余的空闲块挪到 tcache 当中，直到 fast bin 链表空或者 tcache 满为止，然后函数结束</li>
<li>判断 chunk size 大小，如果对应 small bin 的块大小，在对应的 small bin 的双向链表中寻找空闲块；如果链表非空，则取出链表尾的空闲块，作为分配给 malloc 调用者的块，接着把 small bin 链表上剩余的空闲块挪到 tcache 当中，直到 small bin 链表空或者 tcache 满为止，然后函数结束</li>
<li>判断 chunk size 大小，如果对应 large bin 的块大小，则进行一次 malloc_consolidate：遍历 fast bin 每一个 bin 的每一个空闲块，尝试把它和内存上相邻的前后空闲块合并，合并后的空闲块放入 unsorted bin；特别地，如果空闲块和 top chunk 相邻，就会直接合并到 top chunk，这样就不需要把空闲块放入 unsorted bin</li>
<li>开始一个大的无限循环 <code>for (;;)</code>，如果后续尝试各种方式都分配不成功，但是 fast bin 还有空闲块，在 malloc_consolidate 后会从这里开始再尝试一次分配</li>
<li>遍历 unsorted bin，最多处理 10000 个空闲块：<ol>
<li>如果空闲块的大小对应 small bin，并且它是最近刚 split 出来的空闲块，并且可以放得下要分配的块，就原地把这个空闲块进行拆分，前面的部分是分配给 malloc 调用者的块，后面的部分则放回到 unsorted bin，然后函数结束</li>
<li>把空闲块从 unsorted bin 链表中删除</li>
<li>如果空闲块的大小正好是要分配的块的大小，判断 tcache 是否还有空间；如果 tcache 已经满了，直接把这个空闲块作为分配给 malloc 调用者的块，然后函数结束；如果 tcache 还没满，则先把空闲块挪到 tcache 当中，继续处理 unsorted bin 的其他空闲块，这样做的目的是尽量把 tcache 填满</li>
<li>根据空闲块的大小，插入到对应的 small bin 或者 large bin 当中</li>
<li>记录插入到 small bin 或者 large bin 的空闲块个数，如果超过了阈值，并且之前已经找到一个空闲块的大小正好是要分配的块的大小，同时挪到了 tcache 当中，则立即把这个空闲块从 tcache 中取出并分配给 malloc 调用者，然后函数结束；这样做的目的是避免处理太多无关的 unsorted bin 中的空闲块，导致 malloc 调用时间过长</li>
</ol>
</li>
<li>如果在遍历 unsorted bin 过程中找到了和要分配的块一样大的空闲块，那么这个空闲块已经在 tcache 当中了，则立即把这个空闲块从 tcache 中取出并分配给 malloc 调用者，然后函数结束</li>
<li>判断 chunk size 大小，如果属于 large bin 的块大小，则找到对应的 large bin，从小到大通过 nextsize 链表遍历 large bin 中的空闲块，找到一个足够大的空闲块，对它进行拆分，前面的部分是分配给 malloc 调用者的块，后面的部分则放回到 unsorted bin，然后函数结束</li>
<li>根据 chunk size 大小，找到对应的 small bin 或者 large bin，然后从小到大遍历各个 bin（可能从 small bin 一路遍历到 large bin），通过 bitmap 跳过那些空的 bin，找到第一个非空的 bin 的空闲块，对它进行拆分，前面的部分是分配给 malloc 调用者的块，后面的部分则放回到 unsorted bin，然后函数结束</li>
<li>如果 top chunk 足够大，则对它进行拆分，前面的部分是分配给 malloc 调用者的块，后面的部分成为新的 top chunk，然后函数结束</li>
<li>如果此时 fast bin 有空闲块，调用 malloc_consolidate，然后回到无限循环的开头再尝试一次分配</li>
<li>最后的兜底分配方法：调用 <code>sysmalloc</code>，通过 mmap 或 sbrk 向操作系统申请更多的内存</li>
</ol>
<h4 id="free_4">free</h4>
<p>在这里列出完整的 free 流程：</p>
<ol>
<li>free 的入口是 <code>__libc_free (void *mem)</code> 函数</li>
<li>如果配置了 free hook，则调用 free hook，直接返回</li>
<li>如果是调用 <code>free(NULL)</code>，直接返回</li>
<li>检查 <code>mchunk_size</code> 的 <code>IS_MAPPED</code> 字段，如果它之前是通过 mmap 分配的，那么对它进行 munmap，然后返回</li>
<li>如果 tcache 还没初始化，就初始化 tcache</li>
<li>找到这个 chunk 从哪个 arena 分配的：检查 <code>mchunk_size</code> 的 <code>NON_MAIN_ARENA</code> 字段，如果它不是从 main arena 分配的，则根据 chunk 的地址，找到 heap 的地址（heap 的大小是有上限的，并且 heap 的起始地址是对齐到 <code>HEAP_MAX_SIZE</code> 的整倍数边界的），再根据 heap 开头的 heap_info 找到 arena 的地址</li>
<li>进入 <code>_int_free</code>，接着分析 <code>_int_free</code> 的实现</li>
<li>根据 chunk size 找到对应的 tcache bin，如果它还没有满，则把空闲块放到 tcache 当中，然后返回</li>
<li>判断 chunk size 大小，如果对应 fast bin 的块大小，把空闲块放到对应的 fast bin 的单向链表中，然后返回；注意此时没有获取 arena 的锁，所以 fast bin 的操作会用到原子指令，同理 malloc 中对 fast bin 的操作也要用到原子指令，即使 malloc 持有了 arena 的锁</li>
<li>获取 arena 的锁，尝试把空闲块和在内存中相邻的前后空闲块进行合并，合并后的空闲块放入 unsorted bin；合并时，如果被合并的空闲块已经在 small bin 或者 large bin 当中，利用双向链表的特性，把它从双向链表中删除；如果和 top chunk 相邻，则可以直接合并到 top chunk 上，然后返回</li>
<li>如果释放的块比较大，超过了阈值，则触发一次 malloc_consolidate</li>
</ol>
<h3 id="_6">各种常量的默认值</h3>
<p>下面给出 glibc 内存分配器各常量在 64 位下的默认值：</p>
<ol>
<li><code>MALLOC_ALIGNMENT = max(2 * SIZE_SZ, __alignof__ (long double))</code> 等于 16</li>
<li><code>MIN_CHUNK_SIZE = offsetof(struct malloc_chunk, fd_nextsize)</code> 等于 32</li>
<li><code>MINSIZE = alignUp(MIN_CHUNK_SIZE, MALLOC_ALIGNMENT)</code> 等于 32</li>
<li><code>MAX_FAST_SIZE = 80 * SIZE_SZ / 4</code> 等于 160</li>
<li><code>NSMALLBINS = 64</code></li>
<li><code>MIN_LARGE_SIZE = (NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH</code> 等于 1024</li>
<li><code>DEFAULT_MMAP_THRESHOLD_MIN = 128 * 1024</code> 即 128KB</li>
<li><code>DEFAULT_MMAP_THRESHOLD_MAX = 4 * 1024 * 1024 * sizeof(long)</code> 即 32MB</li>
<li><code>HEAP_MIN_SIZE = 32 * 1024</code> 即 32KB</li>
<li><code>HEAP_MAX_SIZE = 2 * DEFAULT_MMAP_THRESHOLD_MAX</code> 即 64MB</li>
<li><code>TCACHE_MAX_BINS = 64</code></li>
<li><code>TCACHE_FILL_COUNT = 7</code></li>
<li><code>NFASTBINS = fastbin_index(request2size(MAX_FAST_SIZE)) + 1</code> 即 10</li>
<li><code>NBINS = 128</code></li>
<li><code>DEFAULT_MXFAST = 64 * sizeof(size_t) / 4</code> 即 128</li>
</ol>
<p>默认情况下各个 bin 负责的块大小范围：</p>
<ol>
<li>tcache: 块大小不超过 1040 字节，对应 <code>malloc(1032)</code> 或更小</li>
<li>fast bin: 块大小不超过 128 字节，对应 <code>malloc(120)</code> 或更小</li>
<li>small bin: 块大小不超过 1008 字节，对应 <code>malloc(1000)</code> 或更小</li>
<li>large bin: 块大小不小于 1024 字节，不超过 131056 字节，对应 <code>malloc(1001)</code> 到 <code>malloc(131048)</code> 的范围，更大的内存分配会直接走 mmap</li>
</ol>
<h3 id="_7">性能优化</h3>
<p>简单总结一下 glibc 内存分配器的各种性能优化特性：</p>
<ol>
<li>tcache 作为一个 thread local 的结构，不需要锁，性能是最好的，所以尽量把空闲块都丢到 tcache 里面，无论是刚 free 的空闲块，还是在 malloc 过程中，顺带把一些空闲块从 fast bin 或者 small bin 丢到 tcache 里，这样也减少了 lock arena 的次数</li>
<li>fast bin 虽然不再是 thread local，但它在 free 路径上使用原子指令来代替锁，使得 free 在很多时候不需要获取 arena 的锁；而把 fast bin 的空闲块的合并操作挪到 malloc 中进行，此时 arena 的锁是 lock 状态，尽量在一次 lock 的临界区里做更多的事情，减少 lock 的次数</li>
<li>small bin 和 large bin 的区分，主要是考虑到了分配的块的大小分布，越大倾向于越稀疏；代价是 large bin 需要额外维护 nextsize 链表来快速地寻找不同大小的空闲块</li>
<li>在回收 unsorted bin 的时候，会进行一个内存局部性优化，即倾向于连续地从同一个块中切出小块用于分配，适合在循环中分配内存的场景</li>
<li>回收 unsorted bin 时，如果遇到了正好和要分配的块大小相同的空闲块时，先不急着分配，而是丢到 tcache 中，然后继续往前回收若干个空闲块，直到 tcache 满了或者遇到了足够多的大小不同的空闲块为止：这是利用了 unsorted bin 中空闲块大小的局部性，有机会把一系列连续的相同大小的空闲块拿到 tcache 当中，并且限制了搜索的长度，避免带来过多额外的延迟</li>
<li>如果尝试了 unsorted bin、small bin、large bin 和 top chunk 都无法分配，最后再检查一次 fast bin 是否为空，如果是空的，则进行一次 consolidate，把 fast bin 里的空闲块丢到 unsorted bin 中，再重新尝试分配一次：注意这整个过程 malloc 都是持有 arena 锁的，而 fast bin 在 free 中的写入是不需要持有 arena 锁的，而是直接用原子指令更新，所以这是考虑到其他线程在同时往同一个 arena free 的情况</li>
<li>在合并相邻空闲块的时候，被合并的空闲块可能已经在 unsorted bin、small bin 或者 large bin 当中，为了能够把空闲块从这些 bin 里删除，用双向链表来实现 O(1) 时间的删除</li>
</ol>
<h2 id="_8">后续版本更新</h2>
<p>接下来记录 glibc 2.31 后续版本对分配器的更新。</p>
<h3 id="glibc-232">glibc 2.32</h3>
<p>glibc 2.32 在 2.31 的基础上有如下的修改：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>$<span class="w"> </span>git<span class="w"> </span>diff<span class="w"> </span>glibc-2.31<span class="w"> </span>glibc-2.32<span class="w"> </span>--<span class="w"> </span>malloc/malloc.c
</span></code></pre></div>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="gh">diff --git a/malloc/malloc.c b/malloc/malloc.c</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="gh">index f7cd29bc2f..ee87ddbbf9 100644</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="gd">--- a/malloc/malloc.c</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="gi">+++ b/malloc/malloc.c</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="gu">@@ -327,6 +327,18 @@ __malloc_assert (const char *assertion, const char *file, unsigned int line,</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w"> </span># define MAX_TCACHE_COUNT UINT16_MAX
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w"> </span>#endif
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="gi">+/* Safe-Linking:</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="gi">+   Use randomness from ASLR (mmap_base) to protect single-linked lists</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="gi">+   of Fast-Bins and TCache.  That is, mask the &quot;next&quot; pointers of the</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="gi">+   lists&#39; chunks, and also perform allocation alignment checks on them.</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="gi">+   This mechanism reduces the risk of pointer hijacking, as was done with</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="gi">+   Safe-Unlinking in the double-linked lists of Small-Bins.</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="gi">+   It assumes a minimum page size of 4096 bytes (12 bits).  Systems with</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="gi">+   larger pages provide less entropy, although the pointer mangling</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="gi">+   still works.  */</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="gi">+#define PROTECT_PTR(pos, ptr) \</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="gi">+  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="gi">+#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="w"> </span>/*
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="w"> </span>  REALLOC_ZERO_BYTES_FREES should be set if a call to
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="gu">@@ -1620,7 +1632,7 @@ static INTERNAL_SIZE_T global_max_fast;</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="w"> </span> */
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="w"> </span>#define set_max_fast(s) \
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="gd">-  global_max_fast = (((s) == 0)                                                      \</span>
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a><span class="gi">+  global_max_fast = (((size_t) (s) &lt;= MALLOC_ALIGN_MASK - SIZE_SZ)        \</span>
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a><span class="w"> </span>                     ? MIN_CHUNK_SIZE / 2 : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a>
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a><span class="w"> </span>static inline INTERNAL_SIZE_T
</span><span id="__span-45-33"><a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a><span class="gu">@@ -2157,12 +2169,15 @@ do_check_malloc_state (mstate av)</span>
</span><span id="__span-45-34"><a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a>
</span><span id="__span-45-35"><a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a><span class="w"> </span>      while (p != 0)
</span><span id="__span-45-36"><a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a><span class="w"> </span>        {
</span><span id="__span-45-37"><a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a><span class="gi">+          if (__glibc_unlikely (misaligned_chunk (p)))</span>
</span><span id="__span-45-38"><a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a><span class="gi">+            malloc_printerr (&quot;do_check_malloc_state(): &quot;</span>
</span><span id="__span-45-39"><a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a><span class="gi">+                             &quot;unaligned fastbin chunk detected&quot;);</span>
</span><span id="__span-45-40"><a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a><span class="w"> </span>          /* each chunk claims to be inuse */
</span><span id="__span-45-41"><a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a><span class="w"> </span>          do_check_inuse_chunk (av, p);
</span><span id="__span-45-42"><a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a><span class="w"> </span>          total += chunksize (p);
</span><span id="__span-45-43"><a id="__codelineno-45-43" name="__codelineno-45-43" href="#__codelineno-45-43"></a><span class="w"> </span>          /* chunk belongs in this bin */
</span><span id="__span-45-44"><a id="__codelineno-45-44" name="__codelineno-45-44" href="#__codelineno-45-44"></a><span class="w"> </span>          assert (fastbin_index (chunksize (p)) == i);
</span><span id="__span-45-45"><a id="__codelineno-45-45" name="__codelineno-45-45" href="#__codelineno-45-45"></a><span class="gd">-          p = p-&gt;fd;</span>
</span><span id="__span-45-46"><a id="__codelineno-45-46" name="__codelineno-45-46" href="#__codelineno-45-46"></a><span class="gi">+          p = REVEAL_PTR (p-&gt;fd);</span>
</span><span id="__span-45-47"><a id="__codelineno-45-47" name="__codelineno-45-47" href="#__codelineno-45-47"></a><span class="w"> </span>        }
</span><span id="__span-45-48"><a id="__codelineno-45-48" name="__codelineno-45-48" href="#__codelineno-45-48"></a><span class="w"> </span>    }
</span><span id="__span-45-49"><a id="__codelineno-45-49" name="__codelineno-45-49" href="#__codelineno-45-49"></a>
</span><span id="__span-45-50"><a id="__codelineno-45-50" name="__codelineno-45-50" href="#__codelineno-45-50"></a><span class="gu">@@ -2923,7 +2938,7 @@ tcache_put (mchunkptr chunk, size_t tc_idx)</span>
</span><span id="__span-45-51"><a id="__codelineno-45-51" name="__codelineno-45-51" href="#__codelineno-45-51"></a><span class="w"> </span>     detect a double free.  */
</span><span id="__span-45-52"><a id="__codelineno-45-52" name="__codelineno-45-52" href="#__codelineno-45-52"></a><span class="w"> </span>  e-&gt;key = tcache;
</span><span id="__span-45-53"><a id="__codelineno-45-53" name="__codelineno-45-53" href="#__codelineno-45-53"></a>
</span><span id="__span-45-54"><a id="__codelineno-45-54" name="__codelineno-45-54" href="#__codelineno-45-54"></a><span class="gd">-  e-&gt;next = tcache-&gt;entries[tc_idx];</span>
</span><span id="__span-45-55"><a id="__codelineno-45-55" name="__codelineno-45-55" href="#__codelineno-45-55"></a><span class="gi">+  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span>
</span><span id="__span-45-56"><a id="__codelineno-45-56" name="__codelineno-45-56" href="#__codelineno-45-56"></a><span class="w"> </span>  tcache-&gt;entries[tc_idx] = e;
</span><span id="__span-45-57"><a id="__codelineno-45-57" name="__codelineno-45-57" href="#__codelineno-45-57"></a><span class="w"> </span>  ++(tcache-&gt;counts[tc_idx]);
</span><span id="__span-45-58"><a id="__codelineno-45-58" name="__codelineno-45-58" href="#__codelineno-45-58"></a><span class="w"> </span>}
</span><span id="__span-45-59"><a id="__codelineno-45-59" name="__codelineno-45-59" href="#__codelineno-45-59"></a><span class="gu">@@ -2934,7 +2949,9 @@ static __always_inline void *</span>
</span><span id="__span-45-60"><a id="__codelineno-45-60" name="__codelineno-45-60" href="#__codelineno-45-60"></a><span class="w"> </span>tcache_get (size_t tc_idx)
</span><span id="__span-45-61"><a id="__codelineno-45-61" name="__codelineno-45-61" href="#__codelineno-45-61"></a><span class="w"> </span>{
</span><span id="__span-45-62"><a id="__codelineno-45-62" name="__codelineno-45-62" href="#__codelineno-45-62"></a><span class="w"> </span>  tcache_entry *e = tcache-&gt;entries[tc_idx];
</span><span id="__span-45-63"><a id="__codelineno-45-63" name="__codelineno-45-63" href="#__codelineno-45-63"></a><span class="gd">-  tcache-&gt;entries[tc_idx] = e-&gt;next;</span>
</span><span id="__span-45-64"><a id="__codelineno-45-64" name="__codelineno-45-64" href="#__codelineno-45-64"></a><span class="gi">+  if (__glibc_unlikely (!aligned_OK (e)))</span>
</span><span id="__span-45-65"><a id="__codelineno-45-65" name="__codelineno-45-65" href="#__codelineno-45-65"></a><span class="gi">+    malloc_printerr (&quot;malloc(): unaligned tcache chunk detected&quot;);</span>
</span><span id="__span-45-66"><a id="__codelineno-45-66" name="__codelineno-45-66" href="#__codelineno-45-66"></a><span class="gi">+  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span>
</span><span id="__span-45-67"><a id="__codelineno-45-67" name="__codelineno-45-67" href="#__codelineno-45-67"></a><span class="w"> </span>  --(tcache-&gt;counts[tc_idx]);
</span><span id="__span-45-68"><a id="__codelineno-45-68" name="__codelineno-45-68" href="#__codelineno-45-68"></a><span class="w"> </span>  e-&gt;key = NULL;
</span><span id="__span-45-69"><a id="__codelineno-45-69" name="__codelineno-45-69" href="#__codelineno-45-69"></a><span class="w"> </span>  return (void *) e;
</span><span id="__span-45-70"><a id="__codelineno-45-70" name="__codelineno-45-70" href="#__codelineno-45-70"></a><span class="gu">@@ -2960,7 +2977,10 @@ tcache_thread_shutdown (void)</span>
</span><span id="__span-45-71"><a id="__codelineno-45-71" name="__codelineno-45-71" href="#__codelineno-45-71"></a><span class="w"> </span>      while (tcache_tmp-&gt;entries[i])
</span><span id="__span-45-72"><a id="__codelineno-45-72" name="__codelineno-45-72" href="#__codelineno-45-72"></a><span class="w"> </span>        {
</span><span id="__span-45-73"><a id="__codelineno-45-73" name="__codelineno-45-73" href="#__codelineno-45-73"></a><span class="w"> </span>          tcache_entry *e = tcache_tmp-&gt;entries[i];
</span><span id="__span-45-74"><a id="__codelineno-45-74" name="__codelineno-45-74" href="#__codelineno-45-74"></a><span class="gd">-          tcache_tmp-&gt;entries[i] = e-&gt;next;</span>
</span><span id="__span-45-75"><a id="__codelineno-45-75" name="__codelineno-45-75" href="#__codelineno-45-75"></a><span class="gi">+          if (__glibc_unlikely (!aligned_OK (e)))</span>
</span><span id="__span-45-76"><a id="__codelineno-45-76" name="__codelineno-45-76" href="#__codelineno-45-76"></a><span class="gi">+            malloc_printerr (&quot;tcache_thread_shutdown(): &quot;</span>
</span><span id="__span-45-77"><a id="__codelineno-45-77" name="__codelineno-45-77" href="#__codelineno-45-77"></a><span class="gi">+                             &quot;unaligned tcache chunk detected&quot;);</span>
</span><span id="__span-45-78"><a id="__codelineno-45-78" name="__codelineno-45-78" href="#__codelineno-45-78"></a><span class="gi">+          tcache_tmp-&gt;entries[i] = REVEAL_PTR (e-&gt;next);</span>
</span><span id="__span-45-79"><a id="__codelineno-45-79" name="__codelineno-45-79" href="#__codelineno-45-79"></a><span class="w"> </span>          __libc_free (e);
</span><span id="__span-45-80"><a id="__codelineno-45-80" name="__codelineno-45-80" href="#__codelineno-45-80"></a><span class="w"> </span>        }
</span><span id="__span-45-81"><a id="__codelineno-45-81" name="__codelineno-45-81" href="#__codelineno-45-81"></a><span class="w"> </span>    }
</span><span id="__span-45-82"><a id="__codelineno-45-82" name="__codelineno-45-82" href="#__codelineno-45-82"></a><span class="gu">@@ -3570,8 +3590,11 @@ _int_malloc (mstate av, size_t bytes)</span>
</span><span id="__span-45-83"><a id="__codelineno-45-83" name="__codelineno-45-83" href="#__codelineno-45-83"></a><span class="w"> </span>      victim = pp;                                        \
</span><span id="__span-45-84"><a id="__codelineno-45-84" name="__codelineno-45-84" href="#__codelineno-45-84"></a><span class="w"> </span>      if (victim == NULL)                                \
</span><span id="__span-45-85"><a id="__codelineno-45-85" name="__codelineno-45-85" href="#__codelineno-45-85"></a><span class="w"> </span>        break;                                                \
</span><span id="__span-45-86"><a id="__codelineno-45-86" name="__codelineno-45-86" href="#__codelineno-45-86"></a><span class="gi">+      pp = REVEAL_PTR (victim-&gt;fd);                                     \</span>
</span><span id="__span-45-87"><a id="__codelineno-45-87" name="__codelineno-45-87" href="#__codelineno-45-87"></a><span class="gi">+      if (__glibc_unlikely (pp != NULL &amp;&amp; misaligned_chunk (pp)))       \</span>
</span><span id="__span-45-88"><a id="__codelineno-45-88" name="__codelineno-45-88" href="#__codelineno-45-88"></a><span class="gi">+        malloc_printerr (&quot;malloc(): unaligned fastbin chunk detected&quot;); \</span>
</span><span id="__span-45-89"><a id="__codelineno-45-89" name="__codelineno-45-89" href="#__codelineno-45-89"></a><span class="w"> </span>    }                                                        \
</span><span id="__span-45-90"><a id="__codelineno-45-90" name="__codelineno-45-90" href="#__codelineno-45-90"></a><span class="gd">-  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span>
</span><span id="__span-45-91"><a id="__codelineno-45-91" name="__codelineno-45-91" href="#__codelineno-45-91"></a><span class="gi">+  while ((pp = catomic_compare_and_exchange_val_acq (fb, pp, victim)) \</span>
</span><span id="__span-45-92"><a id="__codelineno-45-92" name="__codelineno-45-92" href="#__codelineno-45-92"></a><span class="w"> </span>         != victim);                                        \
</span><span id="__span-45-93"><a id="__codelineno-45-93" name="__codelineno-45-93" href="#__codelineno-45-93"></a>
</span><span id="__span-45-94"><a id="__codelineno-45-94" name="__codelineno-45-94" href="#__codelineno-45-94"></a><span class="w"> </span>  if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ()))
</span><span id="__span-45-95"><a id="__codelineno-45-95" name="__codelineno-45-95" href="#__codelineno-45-95"></a><span class="gu">@@ -3583,8 +3606,11 @@ _int_malloc (mstate av, size_t bytes)</span>
</span><span id="__span-45-96"><a id="__codelineno-45-96" name="__codelineno-45-96" href="#__codelineno-45-96"></a>
</span><span id="__span-45-97"><a id="__codelineno-45-97" name="__codelineno-45-97" href="#__codelineno-45-97"></a><span class="w"> </span>      if (victim != NULL)
</span><span id="__span-45-98"><a id="__codelineno-45-98" name="__codelineno-45-98" href="#__codelineno-45-98"></a><span class="w"> </span>        {
</span><span id="__span-45-99"><a id="__codelineno-45-99" name="__codelineno-45-99" href="#__codelineno-45-99"></a><span class="gi">+          if (__glibc_unlikely (misaligned_chunk (victim)))</span>
</span><span id="__span-45-100"><a id="__codelineno-45-100" name="__codelineno-45-100" href="#__codelineno-45-100"></a><span class="gi">+            malloc_printerr (&quot;malloc(): unaligned fastbin chunk detected 2&quot;);</span>
</span><span id="__span-45-101"><a id="__codelineno-45-101" name="__codelineno-45-101" href="#__codelineno-45-101"></a><span class="gi">+</span>
</span><span id="__span-45-102"><a id="__codelineno-45-102" name="__codelineno-45-102" href="#__codelineno-45-102"></a><span class="w"> </span>          if (SINGLE_THREAD_P)
</span><span id="__span-45-103"><a id="__codelineno-45-103" name="__codelineno-45-103" href="#__codelineno-45-103"></a><span class="gd">-            *fb = victim-&gt;fd;</span>
</span><span id="__span-45-104"><a id="__codelineno-45-104" name="__codelineno-45-104" href="#__codelineno-45-104"></a><span class="gi">+            *fb = REVEAL_PTR (victim-&gt;fd);</span>
</span><span id="__span-45-105"><a id="__codelineno-45-105" name="__codelineno-45-105" href="#__codelineno-45-105"></a><span class="w"> </span>          else
</span><span id="__span-45-106"><a id="__codelineno-45-106" name="__codelineno-45-106" href="#__codelineno-45-106"></a><span class="w"> </span>            REMOVE_FB (fb, pp, victim);
</span><span id="__span-45-107"><a id="__codelineno-45-107" name="__codelineno-45-107" href="#__codelineno-45-107"></a><span class="w"> </span>          if (__glibc_likely (victim != NULL))
</span><span id="__span-45-108"><a id="__codelineno-45-108" name="__codelineno-45-108" href="#__codelineno-45-108"></a><span class="gu">@@ -3605,8 +3631,10 @@ _int_malloc (mstate av, size_t bytes)</span>
</span><span id="__span-45-109"><a id="__codelineno-45-109" name="__codelineno-45-109" href="#__codelineno-45-109"></a><span class="w"> </span>                  while (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count
</span><span id="__span-45-110"><a id="__codelineno-45-110" name="__codelineno-45-110" href="#__codelineno-45-110"></a><span class="w"> </span>                         &amp;&amp; (tc_victim = *fb) != NULL)
</span><span id="__span-45-111"><a id="__codelineno-45-111" name="__codelineno-45-111" href="#__codelineno-45-111"></a><span class="w"> </span>                    {
</span><span id="__span-45-112"><a id="__codelineno-45-112" name="__codelineno-45-112" href="#__codelineno-45-112"></a><span class="gi">+                      if (__glibc_unlikely (misaligned_chunk (tc_victim)))</span>
</span><span id="__span-45-113"><a id="__codelineno-45-113" name="__codelineno-45-113" href="#__codelineno-45-113"></a><span class="gi">+                        malloc_printerr (&quot;malloc(): unaligned fastbin chunk detected 3&quot;);</span>
</span><span id="__span-45-114"><a id="__codelineno-45-114" name="__codelineno-45-114" href="#__codelineno-45-114"></a><span class="w"> </span>                      if (SINGLE_THREAD_P)
</span><span id="__span-45-115"><a id="__codelineno-45-115" name="__codelineno-45-115" href="#__codelineno-45-115"></a><span class="gd">-                        *fb = tc_victim-&gt;fd;</span>
</span><span id="__span-45-116"><a id="__codelineno-45-116" name="__codelineno-45-116" href="#__codelineno-45-116"></a><span class="gi">+                        *fb = REVEAL_PTR (tc_victim-&gt;fd);</span>
</span><span id="__span-45-117"><a id="__codelineno-45-117" name="__codelineno-45-117" href="#__codelineno-45-117"></a><span class="w"> </span>                      else
</span><span id="__span-45-118"><a id="__codelineno-45-118" name="__codelineno-45-118" href="#__codelineno-45-118"></a><span class="w"> </span>                        {
</span><span id="__span-45-119"><a id="__codelineno-45-119" name="__codelineno-45-119" href="#__codelineno-45-119"></a><span class="w"> </span>                          REMOVE_FB (fb, pp, tc_victim);
</span><span id="__span-45-120"><a id="__codelineno-45-120" name="__codelineno-45-120" href="#__codelineno-45-120"></a><span class="gu">@@ -4196,11 +4224,15 @@ _int_free (mstate av, mchunkptr p, int have_lock)</span>
</span><span id="__span-45-121"><a id="__codelineno-45-121" name="__codelineno-45-121" href="#__codelineno-45-121"></a><span class="w"> </span>            LIBC_PROBE (memory_tcache_double_free, 2, e, tc_idx);
</span><span id="__span-45-122"><a id="__codelineno-45-122" name="__codelineno-45-122" href="#__codelineno-45-122"></a><span class="w"> </span>            for (tmp = tcache-&gt;entries[tc_idx];
</span><span id="__span-45-123"><a id="__codelineno-45-123" name="__codelineno-45-123" href="#__codelineno-45-123"></a><span class="w"> </span>                 tmp;
</span><span id="__span-45-124"><a id="__codelineno-45-124" name="__codelineno-45-124" href="#__codelineno-45-124"></a><span class="gd">-                 tmp = tmp-&gt;next)</span>
</span><span id="__span-45-125"><a id="__codelineno-45-125" name="__codelineno-45-125" href="#__codelineno-45-125"></a><span class="gd">-              if (tmp == e)</span>
</span><span id="__span-45-126"><a id="__codelineno-45-126" name="__codelineno-45-126" href="#__codelineno-45-126"></a><span class="gd">-                malloc_printerr (&quot;free(): double free detected in tcache 2&quot;);</span>
</span><span id="__span-45-127"><a id="__codelineno-45-127" name="__codelineno-45-127" href="#__codelineno-45-127"></a><span class="gd">-            /* If we get here, it was a coincidence.  We&#39;ve wasted a</span>
</span><span id="__span-45-128"><a id="__codelineno-45-128" name="__codelineno-45-128" href="#__codelineno-45-128"></a><span class="gd">-               few cycles, but don&#39;t abort.  */</span>
</span><span id="__span-45-129"><a id="__codelineno-45-129" name="__codelineno-45-129" href="#__codelineno-45-129"></a><span class="gi">+                 tmp = REVEAL_PTR (tmp-&gt;next))</span>
</span><span id="__span-45-130"><a id="__codelineno-45-130" name="__codelineno-45-130" href="#__codelineno-45-130"></a><span class="gi">+              {</span>
</span><span id="__span-45-131"><a id="__codelineno-45-131" name="__codelineno-45-131" href="#__codelineno-45-131"></a><span class="gi">+                if (__glibc_unlikely (!aligned_OK (tmp)))</span>
</span><span id="__span-45-132"><a id="__codelineno-45-132" name="__codelineno-45-132" href="#__codelineno-45-132"></a><span class="gi">+                  malloc_printerr (&quot;free(): unaligned chunk detected in tcache 2&quot;);</span>
</span><span id="__span-45-133"><a id="__codelineno-45-133" name="__codelineno-45-133" href="#__codelineno-45-133"></a><span class="gi">+                if (tmp == e)</span>
</span><span id="__span-45-134"><a id="__codelineno-45-134" name="__codelineno-45-134" href="#__codelineno-45-134"></a><span class="gi">+                  malloc_printerr (&quot;free(): double free detected in tcache 2&quot;);</span>
</span><span id="__span-45-135"><a id="__codelineno-45-135" name="__codelineno-45-135" href="#__codelineno-45-135"></a><span class="gi">+                /* If we get here, it was a coincidence.  We&#39;ve wasted a</span>
</span><span id="__span-45-136"><a id="__codelineno-45-136" name="__codelineno-45-136" href="#__codelineno-45-136"></a><span class="gi">+                   few cycles, but don&#39;t abort.  */</span>
</span><span id="__span-45-137"><a id="__codelineno-45-137" name="__codelineno-45-137" href="#__codelineno-45-137"></a><span class="gi">+              }</span>
</span><span id="__span-45-138"><a id="__codelineno-45-138" name="__codelineno-45-138" href="#__codelineno-45-138"></a><span class="w"> </span>          }
</span><span id="__span-45-139"><a id="__codelineno-45-139" name="__codelineno-45-139" href="#__codelineno-45-139"></a>
</span><span id="__span-45-140"><a id="__codelineno-45-140" name="__codelineno-45-140" href="#__codelineno-45-140"></a><span class="w"> </span>        if (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)
</span><span id="__span-45-141"><a id="__codelineno-45-141" name="__codelineno-45-141" href="#__codelineno-45-141"></a><span class="gu">@@ -4264,7 +4296,7 @@ _int_free (mstate av, mchunkptr p, int have_lock)</span>
</span><span id="__span-45-142"><a id="__codelineno-45-142" name="__codelineno-45-142" href="#__codelineno-45-142"></a><span class="w"> </span>           add (i.e., double free).  */
</span><span id="__span-45-143"><a id="__codelineno-45-143" name="__codelineno-45-143" href="#__codelineno-45-143"></a><span class="w"> </span>        if (__builtin_expect (old == p, 0))
</span><span id="__span-45-144"><a id="__codelineno-45-144" name="__codelineno-45-144" href="#__codelineno-45-144"></a><span class="w"> </span>          malloc_printerr (&quot;double free or corruption (fasttop)&quot;);
</span><span id="__span-45-145"><a id="__codelineno-45-145" name="__codelineno-45-145" href="#__codelineno-45-145"></a><span class="gd">-        p-&gt;fd = old;</span>
</span><span id="__span-45-146"><a id="__codelineno-45-146" name="__codelineno-45-146" href="#__codelineno-45-146"></a><span class="gi">+        p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span>
</span><span id="__span-45-147"><a id="__codelineno-45-147" name="__codelineno-45-147" href="#__codelineno-45-147"></a><span class="w"> </span>        *fb = p;
</span><span id="__span-45-148"><a id="__codelineno-45-148" name="__codelineno-45-148" href="#__codelineno-45-148"></a><span class="w"> </span>      }
</span><span id="__span-45-149"><a id="__codelineno-45-149" name="__codelineno-45-149" href="#__codelineno-45-149"></a><span class="w"> </span>    else
</span><span id="__span-45-150"><a id="__codelineno-45-150" name="__codelineno-45-150" href="#__codelineno-45-150"></a><span class="gu">@@ -4274,7 +4306,8 @@ _int_free (mstate av, mchunkptr p, int have_lock)</span>
</span><span id="__span-45-151"><a id="__codelineno-45-151" name="__codelineno-45-151" href="#__codelineno-45-151"></a><span class="w"> </span>             add (i.e., double free).  */
</span><span id="__span-45-152"><a id="__codelineno-45-152" name="__codelineno-45-152" href="#__codelineno-45-152"></a><span class="w"> </span>          if (__builtin_expect (old == p, 0))
</span><span id="__span-45-153"><a id="__codelineno-45-153" name="__codelineno-45-153" href="#__codelineno-45-153"></a><span class="w"> </span>            malloc_printerr (&quot;double free or corruption (fasttop)&quot;);
</span><span id="__span-45-154"><a id="__codelineno-45-154" name="__codelineno-45-154" href="#__codelineno-45-154"></a><span class="gd">-          p-&gt;fd = old2 = old;</span>
</span><span id="__span-45-155"><a id="__codelineno-45-155" name="__codelineno-45-155" href="#__codelineno-45-155"></a><span class="gi">+          old2 = old;</span>
</span><span id="__span-45-156"><a id="__codelineno-45-156" name="__codelineno-45-156" href="#__codelineno-45-156"></a><span class="gi">+          p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span>
</span><span id="__span-45-157"><a id="__codelineno-45-157" name="__codelineno-45-157" href="#__codelineno-45-157"></a><span class="w"> </span>        }
</span><span id="__span-45-158"><a id="__codelineno-45-158" name="__codelineno-45-158" href="#__codelineno-45-158"></a><span class="w"> </span>      while ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))
</span><span id="__span-45-159"><a id="__codelineno-45-159" name="__codelineno-45-159" href="#__codelineno-45-159"></a><span class="w"> </span>             != old2);
</span><span id="__span-45-160"><a id="__codelineno-45-160" name="__codelineno-45-160" href="#__codelineno-45-160"></a><span class="gu">@@ -4472,13 +4505,17 @@ static void malloc_consolidate(mstate av)</span>
</span><span id="__span-45-161"><a id="__codelineno-45-161" name="__codelineno-45-161" href="#__codelineno-45-161"></a><span class="w"> </span>    if (p != 0) {
</span><span id="__span-45-162"><a id="__codelineno-45-162" name="__codelineno-45-162" href="#__codelineno-45-162"></a><span class="w"> </span>      do {
</span><span id="__span-45-163"><a id="__codelineno-45-163" name="__codelineno-45-163" href="#__codelineno-45-163"></a><span class="w"> </span>        {
</span><span id="__span-45-164"><a id="__codelineno-45-164" name="__codelineno-45-164" href="#__codelineno-45-164"></a><span class="gi">+          if (__glibc_unlikely (misaligned_chunk (p)))</span>
</span><span id="__span-45-165"><a id="__codelineno-45-165" name="__codelineno-45-165" href="#__codelineno-45-165"></a><span class="gi">+            malloc_printerr (&quot;malloc_consolidate(): &quot;</span>
</span><span id="__span-45-166"><a id="__codelineno-45-166" name="__codelineno-45-166" href="#__codelineno-45-166"></a><span class="gi">+                             &quot;unaligned fastbin chunk detected&quot;);</span>
</span><span id="__span-45-167"><a id="__codelineno-45-167" name="__codelineno-45-167" href="#__codelineno-45-167"></a><span class="gi">+</span>
</span><span id="__span-45-168"><a id="__codelineno-45-168" name="__codelineno-45-168" href="#__codelineno-45-168"></a><span class="w"> </span>          unsigned int idx = fastbin_index (chunksize (p));
</span><span id="__span-45-169"><a id="__codelineno-45-169" name="__codelineno-45-169" href="#__codelineno-45-169"></a><span class="w"> </span>          if ((&amp;fastbin (av, idx)) != fb)
</span><span id="__span-45-170"><a id="__codelineno-45-170" name="__codelineno-45-170" href="#__codelineno-45-170"></a><span class="w"> </span>            malloc_printerr (&quot;malloc_consolidate(): invalid chunk size&quot;);
</span><span id="__span-45-171"><a id="__codelineno-45-171" name="__codelineno-45-171" href="#__codelineno-45-171"></a><span class="w"> </span>        }
</span><span id="__span-45-172"><a id="__codelineno-45-172" name="__codelineno-45-172" href="#__codelineno-45-172"></a>
</span><span id="__span-45-173"><a id="__codelineno-45-173" name="__codelineno-45-173" href="#__codelineno-45-173"></a><span class="w"> </span>        check_inuse_chunk(av, p);
</span><span id="__span-45-174"><a id="__codelineno-45-174" name="__codelineno-45-174" href="#__codelineno-45-174"></a><span class="gd">-        nextp = p-&gt;fd;</span>
</span><span id="__span-45-175"><a id="__codelineno-45-175" name="__codelineno-45-175" href="#__codelineno-45-175"></a><span class="gi">+        nextp = REVEAL_PTR (p-&gt;fd);</span>
</span><span id="__span-45-176"><a id="__codelineno-45-176" name="__codelineno-45-176" href="#__codelineno-45-176"></a>
</span><span id="__span-45-177"><a id="__codelineno-45-177" name="__codelineno-45-177" href="#__codelineno-45-177"></a><span class="w"> </span>        /* Slightly streamlined version of consolidation code in free() */
</span><span id="__span-45-178"><a id="__codelineno-45-178" name="__codelineno-45-178" href="#__codelineno-45-178"></a><span class="w"> </span>        size = chunksize (p);
</span><span id="__span-45-179"><a id="__codelineno-45-179" name="__codelineno-45-179" href="#__codelineno-45-179"></a><span class="gu">@@ -4896,8 +4933,13 @@ int_mallinfo (mstate av, struct mallinfo *m)</span>
</span><span id="__span-45-180"><a id="__codelineno-45-180" name="__codelineno-45-180" href="#__codelineno-45-180"></a>
</span><span id="__span-45-181"><a id="__codelineno-45-181" name="__codelineno-45-181" href="#__codelineno-45-181"></a><span class="w"> </span>  for (i = 0; i &lt; NFASTBINS; ++i)
</span><span id="__span-45-182"><a id="__codelineno-45-182" name="__codelineno-45-182" href="#__codelineno-45-182"></a><span class="w"> </span>    {
</span><span id="__span-45-183"><a id="__codelineno-45-183" name="__codelineno-45-183" href="#__codelineno-45-183"></a><span class="gd">-      for (p = fastbin (av, i); p != 0; p = p-&gt;fd)</span>
</span><span id="__span-45-184"><a id="__codelineno-45-184" name="__codelineno-45-184" href="#__codelineno-45-184"></a><span class="gi">+      for (p = fastbin (av, i);</span>
</span><span id="__span-45-185"><a id="__codelineno-45-185" name="__codelineno-45-185" href="#__codelineno-45-185"></a><span class="gi">+           p != 0;</span>
</span><span id="__span-45-186"><a id="__codelineno-45-186" name="__codelineno-45-186" href="#__codelineno-45-186"></a><span class="gi">+           p = REVEAL_PTR (p-&gt;fd))</span>
</span><span id="__span-45-187"><a id="__codelineno-45-187" name="__codelineno-45-187" href="#__codelineno-45-187"></a><span class="w"> </span>        {
</span><span id="__span-45-188"><a id="__codelineno-45-188" name="__codelineno-45-188" href="#__codelineno-45-188"></a><span class="gi">+          if (__glibc_unlikely (misaligned_chunk (p)))</span>
</span><span id="__span-45-189"><a id="__codelineno-45-189" name="__codelineno-45-189" href="#__codelineno-45-189"></a><span class="gi">+            malloc_printerr (&quot;int_mallinfo(): &quot;</span>
</span><span id="__span-45-190"><a id="__codelineno-45-190" name="__codelineno-45-190" href="#__codelineno-45-190"></a><span class="gi">+                             &quot;unaligned fastbin chunk detected&quot;);</span>
</span><span id="__span-45-191"><a id="__codelineno-45-191" name="__codelineno-45-191" href="#__codelineno-45-191"></a><span class="w"> </span>          ++nfastblocks;
</span><span id="__span-45-192"><a id="__codelineno-45-192" name="__codelineno-45-192" href="#__codelineno-45-192"></a><span class="w"> </span>          fastavail += chunksize (p);
</span><span id="__span-45-193"><a id="__codelineno-45-193" name="__codelineno-45-193" href="#__codelineno-45-193"></a><span class="w"> </span>        }
</span><span id="__span-45-194"><a id="__codelineno-45-194" name="__codelineno-45-194" href="#__codelineno-45-194"></a><span class="gu">@@ -5437,8 +5479,11 @@ __malloc_info (int options, FILE *fp)</span>
</span><span id="__span-45-195"><a id="__codelineno-45-195" name="__codelineno-45-195" href="#__codelineno-45-195"></a>
</span><span id="__span-45-196"><a id="__codelineno-45-196" name="__codelineno-45-196" href="#__codelineno-45-196"></a><span class="w"> </span>              while (p != NULL)
</span><span id="__span-45-197"><a id="__codelineno-45-197" name="__codelineno-45-197" href="#__codelineno-45-197"></a><span class="w"> </span>                {
</span><span id="__span-45-198"><a id="__codelineno-45-198" name="__codelineno-45-198" href="#__codelineno-45-198"></a><span class="gi">+                  if (__glibc_unlikely (misaligned_chunk (p)))</span>
</span><span id="__span-45-199"><a id="__codelineno-45-199" name="__codelineno-45-199" href="#__codelineno-45-199"></a><span class="gi">+                    malloc_printerr (&quot;__malloc_info(): &quot;</span>
</span><span id="__span-45-200"><a id="__codelineno-45-200" name="__codelineno-45-200" href="#__codelineno-45-200"></a><span class="gi">+                                     &quot;unaligned fastbin chunk detected&quot;);</span>
</span><span id="__span-45-201"><a id="__codelineno-45-201" name="__codelineno-45-201" href="#__codelineno-45-201"></a><span class="w"> </span>                  ++nthissize;
</span><span id="__span-45-202"><a id="__codelineno-45-202" name="__codelineno-45-202" href="#__codelineno-45-202"></a><span class="gd">-                  p = p-&gt;fd;</span>
</span><span id="__span-45-203"><a id="__codelineno-45-203" name="__codelineno-45-203" href="#__codelineno-45-203"></a><span class="gi">+                  p = REVEAL_PTR (p-&gt;fd);</span>
</span><span id="__span-45-204"><a id="__codelineno-45-204" name="__codelineno-45-204" href="#__codelineno-45-204"></a><span class="w"> </span>                }
</span><span id="__span-45-205"><a id="__codelineno-45-205" name="__codelineno-45-205" href="#__codelineno-45-205"></a>
</span><span id="__span-45-206"><a id="__codelineno-45-206" name="__codelineno-45-206" href="#__codelineno-45-206"></a><span class="w"> </span>              fastavail += nthissize * thissize;
</span></code></pre></div>
<p>glibc 2.32 的主要修改：</p>
<ol>
<li>给 tcache 和 fast bin 这两个基于单向链表的结构实现了 Safe Linking 机制：原来 <code>fd</code> 直接保存的是后继结点的地址，现在 <code>fd</code> 保存的是后继结点的地址经过 <code>(&amp;fd &gt;&gt; 12) ^ fd</code> 运算后的结果，也就是把当前结点的地址右移 12 位再异或到后继结点的地址；由于遍历的时候，总是从链表头开始遍历，所以总是可以知道 <code>&amp;fd</code> 的地址，再异或回去，就可以得到正确的地址</li>
<li>给 tcache 和 fast bin 添加了更多对齐检查，例如在 64 位下，块总是会对齐到 16 字节</li>
</ol>
<p>之前编写的 <code>dump_tcache</code> 需要改写成如下的代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_tcache</span><span class="p">(</span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TCACHE_MAX_BINS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">      </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache bin #%d: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">      </span><span class="c1">// handle safe linking</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="p">)(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="glibc-233">glibc 2.33</h3>
<p>glibc 2.33 的主要修改是添加了 memory tagging 的支持，通过 memory tagging 把用户指针和分配器内部的指针区分开，从而避免指针的误用。在不支持 memory tagging 的平台上，则没有变化。</p>
<h3 id="glibc-234">glibc 2.34</h3>
<p>glibc 2.34 除了改进 memory tagging 支持以外，针对分配器的变化主要是 tcache 的 key 的使用。在 glibc 2.31 版本，tcache 的 key 指向的是 tcache 本身，用于检测是否出现了 double free。但是这也可能导致 tcache 地址的泄露，所以在 glibc 2.34 版本中，改成了用一个随机数来判断 tcache entry 是否已经被 free 了：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="gh">diff --git a/malloc/malloc.c b/malloc/malloc.c</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="gh">index 1f4bbd8edf..e065785af7 100644</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="gd">--- a/malloc/malloc.c</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="gi">+++ b/malloc/malloc.c</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="gu">@@ -252,6 +252,10 @@</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w"> </span>#include &lt;libc-internal.h&gt;
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="gi">+/* For tcache double-free check.  */</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="gi">+#include &lt;random-bits.h&gt;</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="gi">+#include &lt;sys/random.h&gt;</span>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="gi">+</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a><span class="w"> </span>/*
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="w"> </span>  Debugging:
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a><span class="gu">@@ -3060,7 +3014,7 @@ typedef struct tcache_entry</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a><span class="w"> </span>{
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a><span class="w"> </span>  struct tcache_entry *next;
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w"> </span>  /* This field exists to detect double frees.  */
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a><span class="gd">-  struct tcache_perthread_struct *key;</span>
</span><span id="__span-47-21"><a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a><span class="gi">+  uintptr_t key;</span>
</span><span id="__span-47-22"><a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a><span class="w"> </span>} tcache_entry;
</span><span id="__span-47-23"><a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a>
</span><span id="__span-47-24"><a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a><span class="w"> </span>/* There is one of these for each thread, which contains the
</span><span id="__span-47-25"><a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a><span class="gu">@@ -3077,6 +3031,31 @@ typedef struct tcache_perthread_struct</span>
</span><span id="__span-47-26"><a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a><span class="w"> </span>static __thread bool tcache_shutting_down = false;
</span><span id="__span-47-27"><a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a><span class="w"> </span>static __thread tcache_perthread_struct *tcache = NULL;
</span><span id="__span-47-28"><a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>
</span><span id="__span-47-29"><a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a><span class="gi">+/* Process-wide key to try and catch a double-free in the same thread.  */</span>
</span><span id="__span-47-30"><a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a><span class="gi">+static uintptr_t tcache_key;</span>
</span><span id="__span-47-31"><a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a><span class="gi">+</span>
</span><span id="__span-47-32"><a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a><span class="gi">+/* The value of tcache_key does not really have to be a cryptographically</span>
</span><span id="__span-47-33"><a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a><span class="gi">+   secure random number.  It only needs to be arbitrary enough so that it does</span>
</span><span id="__span-47-34"><a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a><span class="gi">+   not collide with values present in applications.  If a collision does happen</span>
</span><span id="__span-47-35"><a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a><span class="gi">+   consistently enough, it could cause a degradation in performance since the</span>
</span><span id="__span-47-36"><a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a><span class="gi">+   entire list is checked to check if the block indeed has been freed the</span>
</span><span id="__span-47-37"><a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a><span class="gi">+   second time.  The odds of this happening are exceedingly low though, about 1</span>
</span><span id="__span-47-38"><a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a><span class="gi">+   in 2^wordsize.  There is probably a higher chance of the performance</span>
</span><span id="__span-47-39"><a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a><span class="gi">+   degradation being due to a double free where the first free happened in a</span>
</span><span id="__span-47-40"><a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a><span class="gi">+   different thread; that&#39;s a case this check does not cover.  */</span>
</span><span id="__span-47-41"><a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a><span class="gi">+static void</span>
</span><span id="__span-47-42"><a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="gi">+tcache_key_initialize (void)</span>
</span><span id="__span-47-43"><a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a><span class="gi">+{</span>
</span><span id="__span-47-44"><a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a><span class="gi">+  if (__getrandom (&amp;tcache_key, sizeof(tcache_key), GRND_NONBLOCK)</span>
</span><span id="__span-47-45"><a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a><span class="gi">+      != sizeof (tcache_key))</span>
</span><span id="__span-47-46"><a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a><span class="gi">+    {</span>
</span><span id="__span-47-47"><a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a><span class="gi">+      tcache_key = random_bits ();</span>
</span><span id="__span-47-48"><a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a><span class="gi">+#if __WORDSIZE == 64</span>
</span><span id="__span-47-49"><a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a><span class="gi">+      tcache_key = (tcache_key &lt;&lt; 32) | random_bits ();</span>
</span><span id="__span-47-50"><a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a><span class="gi">+#endif</span>
</span><span id="__span-47-51"><a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a><span class="gi">+    }</span>
</span><span id="__span-47-52"><a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a><span class="gi">+}</span>
</span><span id="__span-47-53"><a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a><span class="gi">+</span>
</span><span id="__span-47-54"><a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a><span class="w"> </span>/* Caller must ensure that we know tc_idx is valid and there&#39;s room
</span><span id="__span-47-55"><a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a><span class="w"> </span>   for more chunks.  */
</span><span id="__span-47-56"><a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a><span class="w"> </span>static __always_inline void
</span><span id="__span-47-57"><a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a><span class="gu">@@ -3086,7 +3065,7 @@ tcache_put (mchunkptr chunk, size_t tc_idx)</span>
</span><span id="__span-47-58"><a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a>
</span><span id="__span-47-59"><a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a><span class="w"> </span>  /* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will
</span><span id="__span-47-60"><a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a><span class="w"> </span>     detect a double free.  */
</span><span id="__span-47-61"><a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a><span class="gd">-  e-&gt;key = tcache;</span>
</span><span id="__span-47-62"><a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a><span class="gi">+  e-&gt;key = tcache_key;</span>
</span><span id="__span-47-63"><a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a>
</span><span id="__span-47-64"><a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a><span class="w"> </span>  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);
</span><span id="__span-47-65"><a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a><span class="w"> </span>  tcache-&gt;entries[tc_idx] = e;
</span><span id="__span-47-66"><a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a><span class="gu">@@ -3103,7 +3082,7 @@ tcache_get (size_t tc_idx)</span>
</span><span id="__span-47-67"><a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a><span class="w"> </span>    malloc_printerr (&quot;malloc(): unaligned tcache chunk detected&quot;);
</span><span id="__span-47-68"><a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a><span class="w"> </span>  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);
</span><span id="__span-47-69"><a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a><span class="w"> </span>  --(tcache-&gt;counts[tc_idx]);
</span><span id="__span-47-70"><a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a><span class="gd">-  e-&gt;key = NULL;</span>
</span><span id="__span-47-71"><a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a><span class="gi">+  e-&gt;key = 0;</span>
</span><span id="__span-47-72"><a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a><span class="w"> </span>  return (void *) e;
</span><span id="__span-47-73"><a id="__codelineno-47-73" name="__codelineno-47-73" href="#__codelineno-47-73"></a><span class="w"> </span>}
</span><span id="__span-47-74"><a id="__codelineno-47-74" name="__codelineno-47-74" href="#__codelineno-47-74"></a>
</span><span id="__span-47-75"><a id="__codelineno-47-75" name="__codelineno-47-75" href="#__codelineno-47-75"></a><span class="gu">@@ -4413,7 +4343,7 @@ _int_free (mstate av, mchunkptr p, int have_lock)</span>
</span><span id="__span-47-76"><a id="__codelineno-47-76" name="__codelineno-47-76" href="#__codelineno-47-76"></a><span class="w"> </span>      trust it (it also matches random payload data at a 1 in
</span><span id="__span-47-77"><a id="__codelineno-47-77" name="__codelineno-47-77" href="#__codelineno-47-77"></a><span class="w"> </span>      2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely
</span><span id="__span-47-78"><a id="__codelineno-47-78" name="__codelineno-47-78" href="#__codelineno-47-78"></a><span class="w"> </span>      coincidence before aborting.  */
</span><span id="__span-47-79"><a id="__codelineno-47-79" name="__codelineno-47-79" href="#__codelineno-47-79"></a><span class="gd">-   if (__glibc_unlikely (e-&gt;key == tcache))</span>
</span><span id="__span-47-80"><a id="__codelineno-47-80" name="__codelineno-47-80" href="#__codelineno-47-80"></a><span class="gi">+   if (__glibc_unlikely (e-&gt;key == tcache_key))</span>
</span><span id="__span-47-81"><a id="__codelineno-47-81" name="__codelineno-47-81" href="#__codelineno-47-81"></a><span class="w"> </span>     {
</span><span id="__span-47-82"><a id="__codelineno-47-82" name="__codelineno-47-82" href="#__codelineno-47-82"></a><span class="w"> </span>       tcache_entry *tmp;
</span><span id="__span-47-83"><a id="__codelineno-47-83" name="__codelineno-47-83" href="#__codelineno-47-83"></a><span class="w"> </span>       size_t cnt = 0;
</span></code></pre></div>
<p>有了这个更新以后，就不能像之前那样，先 free 一个块进入到 tcache 中，再从它的 key 字段找到 tcache 的地址了。但我们知道，tcache 保存在 thread local storage (TLS) 当中，x86 的 TLS 是基于 fs 段寄存器访问的，所以只需要从 libc 读取 tcache 的 TLS offset，再手动读取即可：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1">// get tcache address from tls, offset is read from libc</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">libc_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stdout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x1d3760</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of _IO_2_1_stdout_</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">tcache_tls_offset_ptr</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="n">libc_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1d1d78</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of tcache tls offset, found by decompiling</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">                          </span><span class="c1">// __libc_malloc</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tcache_tls_offset_ptr</span><span class="p">;</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="c1">// locate tcache from fs</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="p">;</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movq %%fs:(%1), %0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tcache</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache is at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tcache</span><span class="p">);</span>
</span></code></pre></div>
<p>这个方法在旧版本中也是工作的，注意 tcache 在没有初始化的时候是 NULL。</p>
<p>关于 TLS 的工作原理，特别是 glibc 所使用的 initial-exec TLS model，详见 <a href="https://www.akkadia.org/drepper/tls.pdf">ELF Handling For Thread-Local Storage</a>。</p>
<p>此外，glibc 2.34 还把 malloc/realloc/free/memalign/after_morecore hook 删掉了：虽然符号还在，但是不会被调用。</p>
<h3 id="glibc-235">glibc 2.35</h3>
<p>glibc 2.35 主要是改进了分配器对 Transparent Huge Page 的支持，其余没有什么变化。</p>
<h3 id="glibc-236">glibc 2.36</h3>
<p>glibc 2.36 的分配器有少量的代码重构，没有什么实质的变化。</p>
<h3 id="glibc-237">glibc 2.37</h3>
<p>glibc 2.37 的分配器对 realloc 的实现有少量的修改，但目前本文还没有分析 realloc，其余的部分没有什么变化。</p>
<h3 id="glibc-238">glibc 2.38</h3>
<p>glibc 2.38 的分配器添加了 C17 aligned_alloc 的支持，允许分配特定对齐的内存。给 tcache 添加了从中间删除结点的功能，但仅用于 memalign，对已有的其他部分没有影响。</p>
<h3 id="glibc-239">glibc 2.39</h3>
<p>glibc 2.39 的分配器针对 free 和 memalign 进行了一些代码重构，没有什么实质的变化。</p>
<h3 id="glibc-240">glibc 2.40</h3>
<p>glibc 2.40 的分配器没有修改。</p>
<h3 id="glibc-241">glibc 2.41</h3>
<p>glibc 2.41 针对 tcache 进行了一些重构，并且此时 calloc 也会使用 tcache 了，之前的版本是不会的。此外对 free 的逻辑有一定的修改：之前版本 chunk 被 free 以后无论 small 还是 large 都可能会被放到 unsorted bin 里，而 glibc 2.41 改成，如果被释放的块的大小对应 small bin，则直接放到对应的 small bin 当中，而对应 large bin 的块才放到 unsorted bin 里。</p>
<h3 id="glibc-242">glibc 2.42</h3>
<p>glibc 2.42 针对 tcache 进行了比较大的改动。之前的版本里，tcache 共有 64（<code>TCACHE_MAX_BINS</code>）个 bin，在 64 位下，这 64 个 bin 对应的块大小是从 32 字节到 1040 字节，每 16 字节一个 bin。而 glibc 2.42 给 tcache 添加了额外的 12（<code>TCACHE_LARGE_BINS</code>）个 bin：把原来的 64 个 bin 称为 tcache small bin，新添加的 12 个 bin 称为 tcache large bin。不过 tcache large bin 默认不会被用到，除非手动设置了 <code>tcache_max_bytes</code> tunables，默认行为和之前版本一样。</p>
<p>tcache large bin 下标的计算公式：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="cp"># define TCACHE_SMALL_BINS             64</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="cp"># define TCACHE_LARGE_BINS             12 </span><span class="cm">/* Up to 4M chunks */</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="cp"># define TCACHE_MAX_BINS       (TCACHE_SMALL_BINS + TCACHE_LARGE_BINS)</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="c1">// on 64-bit, MAX_TCACHE_SMALL_SIZE = 63 * 16 + 32 - 8 = 1032</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="cp"># define MAX_TCACHE_SMALL_SIZE tidx2usize (TCACHE_SMALL_BINS-1)</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">size_t</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="n">large_csize2tidx</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">nb</span><span class="p">)</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="p">{</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCACHE_SMALL_BINS</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">              </span><span class="o">+</span><span class="w"> </span><span class="n">__builtin_clz</span><span class="w"> </span><span class="p">(</span><span class="n">MAX_TCACHE_SMALL_SIZE</span><span class="p">)</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">__builtin_clz</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以得到每个 tcache large bin 对应的块大小范围：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>1056-2040: bin 64
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>2056-4088: bin 65
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>4104-8184: bin 66
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>8200-16376: bin 67
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>16392-32760: bin 68
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>32776-65528: bin 69
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>65544-131064: bin 70
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>131080-262136: bin 71
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>262152-524280: bin 72
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>524296-1048568: bin 73
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>1048584-2097144: bin 74
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>2097160-4194288: bin 75
</span></code></pre></div>
<p>超过 4MB（4194304 bytes）的块不会进入 tcache large bin 当中。</p>
<p>在 glibc 2.42 中，允许不同的 tcache bin 的最大空闲块个数不同，此时 <code>tcache_perthread_struct</code> 从记录 bin 链表中的空闲块个数 <code>counts[TCACHE_MAX_BINS]</code>，变成还可以加到链表中的空闲块的个数 <code>num_slots[TCACHE_MAX_BINS]</code>（即最大个数减去当前个数）。但默认依然是每个 tcache bin 最多放 7 个空闲块。</p>
<p>由于 tcache large bin 中空闲块的大小不再相同，所以为了分配的时候找到满足分配要求的尽可能小的空闲块，在把空闲块放入 tcache large bin 时，会按照块大小从小到大的顺序放在链表当中。</p>
<p>总而言之，虽然 glibc 2.42 对 tcache 做了不少修改，但是默认配置下，还是原来的 tcache bin 的组织方式。不确定未来会不会进一步修改默认配置。</p>
<p>此外，glibc 2.42 针对 large bin 添加了对 nextsize 链表的检查：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">))</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span><span class="n">malloc_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="_9">小结</h3>
<p>总结一下从 glibc 2.31 之后内存分配器行为的几个大的变化：</p>
<ol>
<li>glibc 2.32 开始，tcache 和 fast bin 的单向链表的地址进行了保护：<code>(&amp;fd &gt;&gt; 12) ^ fd</code></li>
<li>glibc 2.34 开始，tcache 的 key 不再指向 tcache 自己，而是设置为一个随机数</li>
<li>glibc 2.41 开始，calloc 也会使用 tcache</li>
<li>glibc 2.41 开始，free 面对比较小的 chunk，会直接放到 small bin 而不是 unsorted bin</li>
</ol>
<h2 id="ctf">CTF</h2>
<h3 id="tcache-poisoning">tcache poisoning</h3>
<p>根据前面的分析，tcache 采用单向链表组织，并且 <code>next</code> 指针就放在 <code>payload</code> 的开头，所以如果有 use after free，即 free 了一个 chunk 以后把 payload 开头 8 个字节改掉，就可以篡改 tcache 的内容，影响后续的分配：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1">// see also:</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="c1">// https://github.com/shellphish/how2heap/blob/master/glibc_2.31/tcache_poisoning.c</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="cp">#define TCACHE_MAX_BINS 64</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">;</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_entry</span><span class="p">;</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">tcache_perthread_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">  </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="p">}</span><span class="w"> </span><span class="n">tcache_perthread_struct</span><span class="p">;</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_tcache</span><span class="p">(</span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TCACHE_MAX_BINS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="w">      </span><span class="n">tcache_entry</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache bin #%d: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a><span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a><span class="p">}</span>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a>
</span><span id="__span-52-34"><a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-35"><a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a><span class="w">  </span><span class="c1">// trigger tcache creation</span>
</span><span id="__span-52-36"><a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-37"><a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p0</span><span class="p">);</span>
</span><span id="__span-52-38"><a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a><span class="w">  </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-39"><a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a>
</span><span id="__span-52-40"><a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a><span class="w">  </span><span class="c1">// get tcache address from tls, offset is read from libc</span>
</span><span id="__span-52-41"><a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">libc_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stdout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x1ed6a0</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of _IO_2_1_stdout_</span>
</span><span id="__span-52-42"><a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a><span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">tcache_tls_offset_ptr</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-52-43"><a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a><span class="w">      </span><span class="n">libc_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1ebd78</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of tcache tls offset, found by decompiling</span>
</span><span id="__span-52-44"><a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a><span class="w">                            </span><span class="c1">// __libc_malloc</span>
</span><span id="__span-52-45"><a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a><span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tcache_tls_offset_ptr</span><span class="p">;</span>
</span><span id="__span-52-46"><a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>
</span><span id="__span-52-47"><a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a><span class="w">  </span><span class="c1">// locate tcache from fs</span>
</span><span id="__span-52-48"><a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a><span class="w">  </span><span class="n">tcache_perthread_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tcache</span><span class="p">;</span>
</span><span id="__span-52-49"><a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a><span class="w">  </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;movq %%fs:(%1), %0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tcache</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
</span><span id="__span-52-50"><a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;tcache is at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-51"><a id="__codelineno-52-51" name="__codelineno-52-51" href="#__codelineno-52-51"></a>
</span><span id="__span-52-52"><a id="__codelineno-52-52" name="__codelineno-52-52" href="#__codelineno-52-52"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-53"><a id="__codelineno-52-53" name="__codelineno-52-53" href="#__codelineno-52-53"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-54"><a id="__codelineno-52-54" name="__codelineno-52-54" href="#__codelineno-52-54"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-52-55"><a id="__codelineno-52-55" name="__codelineno-52-55" href="#__codelineno-52-55"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after free(p1):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-56"><a id="__codelineno-52-56" name="__codelineno-52-56" href="#__codelineno-52-56"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-57"><a id="__codelineno-52-57" name="__codelineno-52-57" href="#__codelineno-52-57"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-52-58"><a id="__codelineno-52-58" name="__codelineno-52-58" href="#__codelineno-52-58"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after free(p2):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-59"><a id="__codelineno-52-59" name="__codelineno-52-59" href="#__codelineno-52-59"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-60"><a id="__codelineno-52-60" name="__codelineno-52-60" href="#__codelineno-52-60"></a>
</span><span id="__span-52-61"><a id="__codelineno-52-61" name="__codelineno-52-61" href="#__codelineno-52-61"></a><span class="w">  </span><span class="c1">// use after free</span>
</span><span id="__span-52-62"><a id="__codelineno-52-62" name="__codelineno-52-62" href="#__codelineno-52-62"></a><span class="w">  </span><span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">p0</span><span class="p">;</span>
</span><span id="__span-52-63"><a id="__codelineno-52-63" name="__codelineno-52-63" href="#__codelineno-52-63"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after use after free:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-64"><a id="__codelineno-52-64" name="__codelineno-52-64" href="#__codelineno-52-64"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-65"><a id="__codelineno-52-65" name="__codelineno-52-65" href="#__codelineno-52-65"></a>
</span><span id="__span-52-66"><a id="__codelineno-52-66" name="__codelineno-52-66" href="#__codelineno-52-66"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-67"><a id="__codelineno-52-67" name="__codelineno-52-67" href="#__codelineno-52-67"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after malloc(p3):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-68"><a id="__codelineno-52-68" name="__codelineno-52-68" href="#__codelineno-52-68"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-69"><a id="__codelineno-52-69" name="__codelineno-52-69" href="#__codelineno-52-69"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-52-70"><a id="__codelineno-52-70" name="__codelineno-52-70" href="#__codelineno-52-70"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;after malloc(p4):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-52-71"><a id="__codelineno-52-71" name="__codelineno-52-71" href="#__codelineno-52-71"></a><span class="w">  </span><span class="n">dump_tcache</span><span class="p">(</span><span class="n">tcache</span><span class="p">);</span>
</span><span id="__span-52-72"><a id="__codelineno-52-72" name="__codelineno-52-72" href="#__codelineno-52-72"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;p0=%p p1=%p p2=%p p3=%p p4=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">,</span><span class="w"> </span><span class="n">p4</span><span class="p">);</span>
</span><span id="__span-52-73"><a id="__codelineno-52-73" name="__codelineno-52-73" href="#__codelineno-52-73"></a><span class="p">}</span>
</span></code></pre></div>
<p>输出：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">tcache</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0x56359aa16010</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">after</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x56359aa166e0</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="n">after</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x56359aa16710</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x56359aa166e0</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="n">after</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">free</span><span class="o">:</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x56359aa16710</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x56359aa162a0</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="n">after</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="n">tcache</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x56359aa162a0</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="n">after</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="n">p0</span><span class="o">=</span><span class="mh">0x56359aa162a0</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="mh">0x56359aa166e0</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x56359aa16710</span><span class="w"> </span><span class="n">p3</span><span class="o">=</span><span class="mh">0x56359aa16710</span><span class="w"> </span><span class="n">p4</span><span class="o">=</span><span class="mh">0x56359aa162a0</span>
</span></code></pre></div>
<p>可以看到 malloc 出来的两个指针 <code>p0</code> 和 <code>p4</code> 是相同的。</p>
<h3 id="duplicate-chunks-in-fast-bin">duplicate chunks in fast bin</h3>
<p>根据前面的分析，fast bin 对 double free 的检测比较弱，如果构造一种情况，让它无法被检测到，就会导致一个空闲块被插入 fast bin 两次，此后就会被分配两次：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1">// see also: https://github.com/shellphish/how2heap/blob/master/glibc_2.31/fastbin_dup.c</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stddef.h&gt;</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mchunk_prev_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Size of previous chunk (if free).  */</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">mchunk_size</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Size in bytes, including overhead. */</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">bk</span><span class="p">;</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">  </span><span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fd_nextsize</span><span class="p">;</span><span class="w"> </span><span class="cm">/* double links -- used only if free. */</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">bk_nextsize</span><span class="p">;</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="p">};</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="cm">/* offset 2 to use otherwise unindexable first 2 bins */</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="cp">#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="cp">#define INTERNAL_SIZE_T size_t</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a><span class="cp">#define MALLOC_ALIGNMENT                                                       \</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a><span class="cp">  (2 * SIZE_SZ &lt; __alignof__(long double) ? __alignof__(long double)           \</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a><span class="cp">                                          : 2 * SIZE_SZ)</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>
</span><span id="__span-54-28"><a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a><span class="cm">/* The corresponding word size.  */</span>
</span><span id="__span-54-29"><a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a><span class="cp">#define SIZE_SZ (sizeof(INTERNAL_SIZE_T))</span>
</span><span id="__span-54-30"><a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>
</span><span id="__span-54-31"><a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a><span class="cm">/* The corresponding bit mask value.  */</span>
</span><span id="__span-54-32"><a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a><span class="cp">#define MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span>
</span><span id="__span-54-33"><a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a>
</span><span id="__span-54-34"><a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a><span class="cm">/* The smallest possible chunk */</span>
</span><span id="__span-54-35"><a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="cp">#define MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span>
</span><span id="__span-54-36"><a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>
</span><span id="__span-54-37"><a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a><span class="cm">/* The smallest size we can malloc is an aligned minimal chunk */</span>
</span><span id="__span-54-38"><a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a><span class="cp">#define MINSIZE                                                                \</span>
</span><span id="__span-54-39"><a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a><span class="cp">  (unsigned long)(((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span>
</span><span id="__span-54-40"><a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a>
</span><span id="__span-54-41"><a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a><span class="cp">#define request2size(req)                                                      \</span>
</span><span id="__span-54-42"><a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a><span class="cp">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                             \</span>
</span><span id="__span-54-43"><a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a><span class="cp">       ? MINSIZE                                                               \</span>
</span><span id="__span-54-44"><a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a><span class="cp">       : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span>
</span><span id="__span-54-45"><a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a>
</span><span id="__span-54-46"><a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a><span class="cp">#define MAX_FAST_SIZE (80 * SIZE_SZ / 4)</span>
</span><span id="__span-54-47"><a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a>
</span><span id="__span-54-48"><a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a><span class="cp">#define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)</span>
</span><span id="__span-54-49"><a id="__codelineno-54-49" name="__codelineno-54-49" href="#__codelineno-54-49"></a>
</span><span id="__span-54-50"><a id="__codelineno-54-50" name="__codelineno-54-50" href="#__codelineno-54-50"></a><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-51"><a id="__codelineno-54-51" name="__codelineno-54-51" href="#__codelineno-54-51"></a><span class="w">  </span><span class="cm">/* Serialize access.  */</span>
</span><span id="__span-54-52"><a id="__codelineno-54-52" name="__codelineno-54-52" href="#__codelineno-54-52"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
</span><span id="__span-54-53"><a id="__codelineno-54-53" name="__codelineno-54-53" href="#__codelineno-54-53"></a><span class="w">  </span><span class="cm">/* Flags (formerly in max_fast).  */</span>
</span><span id="__span-54-54"><a id="__codelineno-54-54" name="__codelineno-54-54" href="#__codelineno-54-54"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
</span><span id="__span-54-55"><a id="__codelineno-54-55" name="__codelineno-54-55" href="#__codelineno-54-55"></a><span class="w">  </span><span class="cm">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
</span><span id="__span-54-56"><a id="__codelineno-54-56" name="__codelineno-54-56" href="#__codelineno-54-56"></a><span class="w">  </span><span class="cm">/* Note this is a bool but not all targets support atomics on booleans.  */</span>
</span><span id="__span-54-57"><a id="__codelineno-54-57" name="__codelineno-54-57" href="#__codelineno-54-57"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">have_fastchunks</span><span class="p">;</span>
</span><span id="__span-54-58"><a id="__codelineno-54-58" name="__codelineno-54-58" href="#__codelineno-54-58"></a><span class="w">  </span><span class="cm">/* Fastbins */</span>
</span><span id="__span-54-59"><a id="__codelineno-54-59" name="__codelineno-54-59" href="#__codelineno-54-59"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">NFASTBINS</span><span class="p">];</span>
</span><span id="__span-54-60"><a id="__codelineno-54-60" name="__codelineno-54-60" href="#__codelineno-54-60"></a><span class="p">};</span>
</span><span id="__span-54-61"><a id="__codelineno-54-61" name="__codelineno-54-61" href="#__codelineno-54-61"></a>
</span><span id="__span-54-62"><a id="__codelineno-54-62" name="__codelineno-54-62" href="#__codelineno-54-62"></a><span class="kt">void</span><span class="w"> </span><span class="nf">dump_fastbin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-63"><a id="__codelineno-54-63" name="__codelineno-54-63" href="#__codelineno-54-63"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">libc_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stdout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x1ed6a0</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of _IO_2_1_stdout_</span>
</span><span id="__span-54-64"><a id="__codelineno-54-64" name="__codelineno-54-64" href="#__codelineno-54-64"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_state</span><span class="w"> </span><span class="o">*</span><span class="n">main_arena</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-54-65"><a id="__codelineno-54-65" name="__codelineno-54-65" href="#__codelineno-54-65"></a><span class="w">      </span><span class="n">libc_base</span><span class="w"> </span><span class="o">+</span>
</span><span id="__span-54-66"><a id="__codelineno-54-66" name="__codelineno-54-66" href="#__codelineno-54-66"></a><span class="w">      </span><span class="mh">0x1ecb80</span><span class="p">;</span><span class="w"> </span><span class="c1">// offset of main_arena, found by decompiling malloc_trim</span>
</span><span id="__span-54-67"><a id="__codelineno-54-67" name="__codelineno-54-67" href="#__codelineno-54-67"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NFASTBINS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-68"><a id="__codelineno-54-68" name="__codelineno-54-68" href="#__codelineno-54-68"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">main_arena</span><span class="o">-&gt;</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-69"><a id="__codelineno-54-69" name="__codelineno-54-69" href="#__codelineno-54-69"></a><span class="w">      </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_arena</span><span class="o">-&gt;</span><span class="n">fastbinsY</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-54-70"><a id="__codelineno-54-70" name="__codelineno-54-70" href="#__codelineno-54-70"></a><span class="w">      </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_chunk</span><span class="w"> </span><span class="o">*</span><span class="n">init_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-54-71"><a id="__codelineno-54-71" name="__codelineno-54-71" href="#__codelineno-54-71"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbin #%d: %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-54-72"><a id="__codelineno-54-72" name="__codelineno-54-72" href="#__codelineno-54-72"></a><span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-54-73"><a id="__codelineno-54-73" name="__codelineno-54-73" href="#__codelineno-54-73"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-74"><a id="__codelineno-54-74" name="__codelineno-54-74" href="#__codelineno-54-74"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; -&gt; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-54-75"><a id="__codelineno-54-75" name="__codelineno-54-75" href="#__codelineno-54-75"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">init_p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-76"><a id="__codelineno-54-76" name="__codelineno-54-76" href="#__codelineno-54-76"></a><span class="w">          </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; (cycle detected)&quot;</span><span class="p">);</span>
</span><span id="__span-54-77"><a id="__codelineno-54-77" name="__codelineno-54-77" href="#__codelineno-54-77"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-54-78"><a id="__codelineno-54-78" name="__codelineno-54-78" href="#__codelineno-54-78"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-79"><a id="__codelineno-54-79" name="__codelineno-54-79" href="#__codelineno-54-79"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-54-80"><a id="__codelineno-54-80" name="__codelineno-54-80" href="#__codelineno-54-80"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-54-81"><a id="__codelineno-54-81" name="__codelineno-54-81" href="#__codelineno-54-81"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-82"><a id="__codelineno-54-82" name="__codelineno-54-82" href="#__codelineno-54-82"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-83"><a id="__codelineno-54-83" name="__codelineno-54-83" href="#__codelineno-54-83"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-84"><a id="__codelineno-54-84" name="__codelineno-54-84" href="#__codelineno-54-84"></a><span class="p">}</span>
</span><span id="__span-54-85"><a id="__codelineno-54-85" name="__codelineno-54-85" href="#__codelineno-54-85"></a>
</span><span id="__span-54-86"><a id="__codelineno-54-86" name="__codelineno-54-86" href="#__codelineno-54-86"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-87"><a id="__codelineno-54-87" name="__codelineno-54-87" href="#__codelineno-54-87"></a><span class="w">  </span><span class="c1">// use 7 malloc + free to fill the tcache</span>
</span><span id="__span-54-88"><a id="__codelineno-54-88" name="__codelineno-54-88" href="#__codelineno-54-88"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptrs</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span><span id="__span-54-89"><a id="__codelineno-54-89" name="__codelineno-54-89" href="#__codelineno-54-89"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocate 7 pointers:&quot;</span><span class="p">);</span>
</span><span id="__span-54-90"><a id="__codelineno-54-90" name="__codelineno-54-90" href="#__codelineno-54-90"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-91"><a id="__codelineno-54-91" name="__codelineno-54-91" href="#__codelineno-54-91"></a><span class="w">    </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-92"><a id="__codelineno-54-92" name="__codelineno-54-92" href="#__codelineno-54-92"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %p&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-54-93"><a id="__codelineno-54-93" name="__codelineno-54-93" href="#__codelineno-54-93"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-94"><a id="__codelineno-54-94" name="__codelineno-54-94" href="#__codelineno-54-94"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-95"><a id="__codelineno-54-95" name="__codelineno-54-95" href="#__codelineno-54-95"></a>
</span><span id="__span-54-96"><a id="__codelineno-54-96" name="__codelineno-54-96" href="#__codelineno-54-96"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-97"><a id="__codelineno-54-97" name="__codelineno-54-97" href="#__codelineno-54-97"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-98"><a id="__codelineno-54-98" name="__codelineno-54-98" href="#__codelineno-54-98"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocate p1=%p p2=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-54-99"><a id="__codelineno-54-99" name="__codelineno-54-99" href="#__codelineno-54-99"></a>
</span><span id="__span-54-100"><a id="__codelineno-54-100" name="__codelineno-54-100" href="#__codelineno-54-100"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-101"><a id="__codelineno-54-101" name="__codelineno-54-101" href="#__codelineno-54-101"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-54-102"><a id="__codelineno-54-102" name="__codelineno-54-102" href="#__codelineno-54-102"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-103"><a id="__codelineno-54-103" name="__codelineno-54-103" href="#__codelineno-54-103"></a>
</span><span id="__span-54-104"><a id="__codelineno-54-104" name="__codelineno-54-104" href="#__codelineno-54-104"></a><span class="w">  </span><span class="c1">// now p1 goes to fastbin</span>
</span><span id="__span-54-105"><a id="__codelineno-54-105" name="__codelineno-54-105" href="#__codelineno-54-105"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-54-106"><a id="__codelineno-54-106" name="__codelineno-54-106" href="#__codelineno-54-106"></a>
</span><span id="__span-54-107"><a id="__codelineno-54-107" name="__codelineno-54-107" href="#__codelineno-54-107"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after p1 freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-108"><a id="__codelineno-54-108" name="__codelineno-54-108" href="#__codelineno-54-108"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-54-109"><a id="__codelineno-54-109" name="__codelineno-54-109" href="#__codelineno-54-109"></a>
</span><span id="__span-54-110"><a id="__codelineno-54-110" name="__codelineno-54-110" href="#__codelineno-54-110"></a><span class="w">  </span><span class="c1">// now p2 goes to fastbin</span>
</span><span id="__span-54-111"><a id="__codelineno-54-111" name="__codelineno-54-111" href="#__codelineno-54-111"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span><span id="__span-54-112"><a id="__codelineno-54-112" name="__codelineno-54-112" href="#__codelineno-54-112"></a>
</span><span id="__span-54-113"><a id="__codelineno-54-113" name="__codelineno-54-113" href="#__codelineno-54-113"></a><span class="w">  </span><span class="c1">// two pointers in the fastbin</span>
</span><span id="__span-54-114"><a id="__codelineno-54-114" name="__codelineno-54-114" href="#__codelineno-54-114"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after p1 &amp; p2 freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-115"><a id="__codelineno-54-115" name="__codelineno-54-115" href="#__codelineno-54-115"></a>
</span><span id="__span-54-116"><a id="__codelineno-54-116" name="__codelineno-54-116" href="#__codelineno-54-116"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-54-117"><a id="__codelineno-54-117" name="__codelineno-54-117" href="#__codelineno-54-117"></a>
</span><span id="__span-54-118"><a id="__codelineno-54-118" name="__codelineno-54-118" href="#__codelineno-54-118"></a><span class="w">  </span><span class="c1">// free p1 again</span>
</span><span id="__span-54-119"><a id="__codelineno-54-119" name="__codelineno-54-119" href="#__codelineno-54-119"></a><span class="w">  </span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span><span id="__span-54-120"><a id="__codelineno-54-120" name="__codelineno-54-120" href="#__codelineno-54-120"></a>
</span><span id="__span-54-121"><a id="__codelineno-54-121" name="__codelineno-54-121" href="#__codelineno-54-121"></a><span class="w">  </span><span class="c1">// three pointers in the fastbin</span>
</span><span id="__span-54-122"><a id="__codelineno-54-122" name="__codelineno-54-122" href="#__codelineno-54-122"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;fastbins after p1, p2 &amp; p1 freed:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-123"><a id="__codelineno-54-123" name="__codelineno-54-123" href="#__codelineno-54-123"></a><span class="w">  </span><span class="n">dump_fastbin</span><span class="p">();</span>
</span><span id="__span-54-124"><a id="__codelineno-54-124" name="__codelineno-54-124" href="#__codelineno-54-124"></a>
</span><span id="__span-54-125"><a id="__codelineno-54-125" name="__codelineno-54-125" href="#__codelineno-54-125"></a><span class="w">  </span><span class="c1">// allocate 7 pointers to clear tcache</span>
</span><span id="__span-54-126"><a id="__codelineno-54-126" name="__codelineno-54-126" href="#__codelineno-54-126"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocate 7 pointers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-54-127"><a id="__codelineno-54-127" name="__codelineno-54-127" href="#__codelineno-54-127"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-128"><a id="__codelineno-54-128" name="__codelineno-54-128" href="#__codelineno-54-128"></a><span class="w">    </span><span class="n">ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-129"><a id="__codelineno-54-129" name="__codelineno-54-129" href="#__codelineno-54-129"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-54-130"><a id="__codelineno-54-130" name="__codelineno-54-130" href="#__codelineno-54-130"></a>
</span><span id="__span-54-131"><a id="__codelineno-54-131" name="__codelineno-54-131" href="#__codelineno-54-131"></a><span class="w">  </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-132"><a id="__codelineno-54-132" name="__codelineno-54-132" href="#__codelineno-54-132"></a><span class="w">  </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-133"><a id="__codelineno-54-133" name="__codelineno-54-133" href="#__codelineno-54-133"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span id="__span-54-134"><a id="__codelineno-54-134" name="__codelineno-54-134" href="#__codelineno-54-134"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;allocate p1=%p p2=%p p3=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">p3</span><span class="p">);</span>
</span><span id="__span-54-135"><a id="__codelineno-54-135" name="__codelineno-54-135" href="#__codelineno-54-135"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-54-136"><a id="__codelineno-54-136" name="__codelineno-54-136" href="#__codelineno-54-136"></a><span class="p">}</span>
</span></code></pre></div>
<p>由于 fast bin 的 double free 检查只检查链表头，所以按照 <code>p1, p2, p1</code> 的顺序释放，就不会被检查到，并且此时链表中出现了两次 <code>p1</code>，那么后续再分配内存时，就会把同一个地址分配了两次。上述代码的输出如下，符合预期：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">allocate</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">pointers</span><span class="o">:</span><span class="w"> </span><span class="mh">0x5633121676b0</span><span class="w"> </span><span class="mh">0x5633121676e0</span><span class="w"> </span><span class="mh">0x563312167710</span><span class="w"> </span><span class="mh">0x563312167740</span><span class="w"> </span><span class="mh">0x563312167770</span><span class="w"> </span><span class="mh">0x5633121677a0</span><span class="w"> </span><span class="mh">0x5633121677d0</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">allocate</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="mh">0x563312167800</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x563312167830</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x5633121677f0</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x563312167820</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x5633121677f0</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="n">fastbins</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="n">freed</span><span class="o">:</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="n">fastbin</span><span class="w"> </span><span class="err">#</span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0x5633121677f0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x563312167820</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mh">0x5633121677f0</span><span class="w"> </span><span class="p">(</span><span class="n">cycle</span><span class="w"> </span><span class="n">detected</span><span class="p">)</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="n">allocate</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">pointers</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="n">allocate</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="mh">0x563312167800</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="mh">0x563312167830</span><span class="w"> </span><span class="n">p3</span><span class="o">=</span><span class="mh">0x563312167800</span>
</span></code></pre></div>
<p>可见 double free 不一定能被检测到，并且可能带来危险的后果。</p>
<h2 id="_10">参考</h2>
<ul>
<li><a href="https://sourceware.org/glibc/wiki/MallocInternals">Malloc Internals</a></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年7月29日 05:28:16 UTC">2025年7月29日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年3月30日 11:48:51 UTC">2025年3月30日</span>
  </span>

    
    
    
  </aside>


  



<!-- https://squidfunk.github.io/mkdocs-material/setup/adding-a-comment-system/ -->
<h2 id="__comments">评论</h2>
<!-- Insert generated snippet here -->

<script src="https://giscus.app/client.js"
      data-repo="jiegec/kb"
      data-repo-id="R_kgDOJZwffg"
      data-category="General"
      data-category-id="DIC_kwDOJZwffs4CV-wv"
      data-mapping="pathname"
      data-strict="1"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="en"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
</script>
                

  <script>
    var language = "";
    if (language === "None") {
      language = "zh";
    }
    var prefix = "";
    var suffix = "";
    if (language === "zh") {
      prefix = "图 ";
      suffix = "：";
    } else {
      // en
      prefix = "Figure ";
      suffix = ": ";
    }
    /* prepend the counter to the figcaption content */
    var styles = `figure figcaption:before { content: "${prefix}" counter(figureCounter) "${suffix}" }`;

    var styleSheet = document.createElement("style")
    styleSheet.innerText = styles
    document.head.appendChild(styleSheet)
  </script>

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="gcc.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: GCC 内部实现">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                GCC 内部实现
              </div>
            </div>
          </a>
        
        
          
          <a href="glibc_file.html" class="md-footer__link md-footer__link--next" aria-label="下一页: glibc FILE 结构体">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                glibc FILE 结构体
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023-2025 Jiajie Chen
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit", "content.code.copy", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tracking", "navigation.tabs", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../javascripts/tablesort.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>